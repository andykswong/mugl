var e,t;e=self,t=function(){return(()=>{var e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AddressMode:()=>k,BYTE_MASK:()=>se,BlendFactor:()=>T,BlendOp:()=>L,BufferType:()=>D,ColorMask:()=>P,CompareFunc:()=>R,CubeFace:()=>I,CullMode:()=>N,FilterMode:()=>V,FrontFace:()=>G,GL1Feature:()=>me,GL2Feature:()=>be,IndexFormat:()=>E,MinFilterMode:()=>j,MipmapHint:()=>U,PixelFormat:()=>W,PrimitiveType:()=>Z,ShaderType:()=>z,StencilOp:()=>q,TexType:()=>X,UniformFormat:()=>H,UniformType:()=>Y,Usage:()=>K,VertexFormat:()=>J,getGLDevice:()=>Ne,getNGLDevice:()=>He,glTexFormat:()=>fe,glTexInternalFormat:()=>ue,glTexType:()=>de,hasStencil:()=>le,indexSize:()=>ce,is3DTexture:()=>ie,isDepthStencil:()=>ae,muglBind:()=>Ue,vertexByteSize:()=>ne,vertexNormalized:()=>he,vertexSize:()=>oe,vertexType:()=>pe});const r=1024,s=16384,i=32774,a=34962,l=34963,n=1028,o=1029,p=3089,h=2305,c=5121,u=5123,f=5126,d=6408,g=519,m=7680,b=9728,v=34069,x=33984,w=33071,y=35675,F=36160,S=36161,A=34041,_=36064,B=36096,O=33306,M=35345,C=4294967295,k={Clamp:w,Repeat:10497,Mirror:33648},T={Zero:0,One:1,SrcColor:768,OneMinusSrcColor:769,SrcAlpha:770,OneMinusSrcAlpha:771,DstColor:774,OneMinusDstColor:775,DstAlpha:772,OneMinusDstAlpha:773,SrcAlphaSaturate:776,BlendColor:32769,OneMinusBlendColor:32770},L={Add:i,Sub:32778,RevSub:32779,Min:32775,Max:32776},D={Vertex:a,Index:l,Uniform:M},P={R:1,G:2,B:4,A:8,RGB:7,All:15},R={Never:512,Less:513,Equal:514,LEqual:515,Greater:516,NotEqual:517,GEqual:518,Always:g},I={PosX:v,NegX:34070,PosY:34071,NegY:34072,PosZ:34073,NegZ:34074},N={None:0,Front:n,Back:o},V={Nearest:b,Linear:9729},G={CCW:h,CW:2304},E={UInt16:u,UInt32:5125},U={None:4352,Fast:4353,Nice:4354},j={Nearest:b,Linear:9729,NearestMipmapNearest:9984,NearestMipmapLinear:9986,LinearMipmapNearest:9985,LinearMipmapLinear:9987},W={Depth:65796,Stencil:131589,DepthStencil:197381,RGBA8:263169,RGBA32F:328706,RGBA16F:394243,R32F:460034,R16F:525571,RG32F:591362,RG16F:656899},Z={Points:0,Lines:1,LineStrip:3,Tri:4,TriStrip:5},z={Vertex:35633,Fragment:35632},q={Keep:m,Zero:0,Replace:7681,Incr:7682,Decr:7683,Invert:5386,IncrWrap:34055,DecrWrap:34056},X={Tex2D:3553,Cube:34067,Tex3D:32879,Array:35866},H={Float:f,Vec2:35664,Vec3:35665,Vec4:35666,Mat2:y,Mat3:y,Mat4:35676},Y={Value:1,Tex:2,Buffer:4},K={Static:35044,Dynamic:35048,Stream:35040},J={Float:256,Float2:512,Float3:768,Float4:1024,Char2:513,Char2N:66049,UChar2:514,UChar2N:66050,Char4:1025,Char4N:66561,UChar4:1026,UChar4N:66562,Short2:515,Short2N:66051,Short4:1027,Short4N:66563,UShort2:516,UShort2N:66052,UShort4:1028,UShort4N:66564},Q=[0,33189,A,A,32856,34836,34842,33326,33325,33328,33327],$=[0,6402,A,A,d,6403,33319],ee=[0,c,f,36193,5125,34042],te=[f,5120,c,5122,u],re=[4,1,1,2,2],se=255;function ie(e){return 32879===e||35866===e}function ae(e){return e>0&&e>>16<=3}function le(e){return 5==(e&se)}function ne(e){return re[e&se]*oe(e)}function oe(e){return e>>8&se}function pe(e){return te[e&se]}function he(e){return!!(e>>16)}function ce(e){return e-u+2}function ue(e,t=!1){return t||ae(e)?Q[e>>16]:fe(e)}function fe(e){return $[e>>8&se]}function de(e,t=!1){const r=ee[e&se];return t&&36193===r?5131:r}const ge={Aniso:"EXT_texture_filter_anisotropic",TexFP16Lin:"OES_texture_half_float_linear",TexFPLin:"OES_texture_float_linear"},me={DFfx:"OES_standard_derivatives",Instancing:"ANGLE_instanced_arrays",UintIndex:"OES_element_index_uint",BlendMinMax:"EXT_blend_minmax",DrawBuffers:"WEBGL_draw_buffers",DepthTex:"WEBGL_depth_texture",TexFP16:"OES_texture_half_float",TexFP:"OES_texture_float",...ge},be={BufFP:"EXT_color_buffer_float",...ge};class ve{constructor(e,t){const r=this.gl=e.gl;this.props={type:t.type||D.Vertex,usage:t.usage||K.Static,size:t.size},r.bindBuffer(this.props.type,this.glb=r.createBuffer()),r.bufferData(this.props.type,this.props.size,this.props.usage)}data(e,t=0){return this.gl.bindBuffer(this.props.type,this.glb),this.gl.bufferSubData(this.props.type,t,e),this}destroy(){this.gl.deleteBuffer(this.glb),this.glb=null}}const xe={frontFace:h,cullMode:0,depthBias:0,depthBiasSlopeScale:0,alphaToCoverage:!1},we={write:!1,compare:g},ye={frontCompare:g,frontFailOp:m,frontZFailOp:m,frontPassOp:m,backCompare:g,backFailOp:m,backZFailOp:m,backPassOp:m,readMask:se,writeMask:se},Fe={srcFactorRGB:1,dstFactorRGB:0,opRGB:i,srcFactorAlpha:1,dstFactorAlpha:0,opAlpha:i,colorMask:P.All};function Se(e,t,r,s=0,i=!1){const{raster:a,depth:l,stencil:p,blend:h}=r;let c=!1,u=0,f=0,d=0,g=0;const m=t.raster||xe,b=a||xe;if(u=b.frontFace,(i||m.frontFace!==u)&&e.frontFace(u),u=b.cullMode,(i||m.cullMode!==u)&&((c=0!==u)&&e.cullFace(u),Oe(e,2884,c)),u=b.depthBiasSlopeScale,f=b.depthBias,(i||m.depthBiasSlopeScale!==u||m.depthBias!==f)&&(Oe(e,32823,!(!u&&!f)),e.polygonOffset(u,f)),c=b.alphaToCoverage,(i||m.alphaToCoverage!==c)&&Oe(e,32926,c),c=!!l,(i||t.depthOn!==c)&&Oe(e,2929,c),i||c){const r=t.depth||we,s=l||we;_e(e,r.write,s.write,i),u=s.compare,(i||r.compare!==u)&&e.depthFunc(u)}if(c=!!p,(i||t.stencilOn!==c)&&Oe(e,2960,c),i||c){const r=t.stencil||ye,a=p||ye;u=a.readMask,c=i||r.readMask!==u,f=a.frontCompare,(c||r.frontCompare!==f)&&e.stencilFuncSeparate(n,f,s,u),f=a.backCompare,(c||r.backCompare!==f)&&e.stencilFuncSeparate(o,f,s,u),u=a.frontFailOp,f=a.frontZFailOp,d=a.frontPassOp,(i||r.frontFailOp!==u||r.frontZFailOp!==f||r.frontPassOp!==d)&&e.stencilOpSeparate(n,u,f,d),u=a.backFailOp,f=a.backZFailOp,d=a.backPassOp,(i||r.backFailOp!==u||r.backZFailOp!==f||r.backPassOp!==d)&&e.stencilOpSeparate(o,u,f,d),Be(e,r.writeMask,a.writeMask,i)}if(c=!!h,(i||t.blendOn!==c)&&Oe(e,3042,c),i||c){const r=t.blend||Fe,s=h||Fe;u=s.srcFactorRGB,f=s.dstFactorRGB,d=s.srcFactorAlpha,g=s.dstFactorAlpha,(i||r.srcFactorRGB!==u||r.dstFactorRGB!==f||r.srcFactorAlpha!==d||r.dstFactorAlpha!==g)&&e.blendFuncSeparate(u,f,d,g),u=s.opRGB,f=s.opAlpha,(i||r.opRGB!==u||r.opAlpha!==f)&&e.blendEquationSeparate(u,f),Ae(e,r.colorMask,s.colorMask,i)}}function Ae(e,t,r,s=!1){(t!==r||s)&&e.colorMask(!!(r&P.R),!!(r&P.G),!!(r&P.B),!!(r&P.A))}function _e(e,t,r,s=!1){(t!==r||s)&&e.depthMask(r)}function Be(e,t,r,s=!1){(t!==r||s)&&e.stencilMask(r)}function Oe(e,t,r){r?e.enable(t):e.disable(t)}const Me=(e,t)=>t||e?Object.assign(e||{},t):null;class Ce{constructor(e,t){const r=this.gl=e.gl,s=this.gls=r.createShader(this.type=t.type);r.shaderSource(s,this.source=t.source),r.compileShader(s)}destroy(){this.gl.deleteShader(this.gls),this.gls=null}}class ke{constructor(e,t){var r;const s=this.gl=e.gl,i=Array(16);let a=0,l=!1;const n=t.buffers.map((({attrs:e,stride:t=0,instanced:r=!1})=>{l=l||r;const s=Array(e.length);let n=0,o=e.length>0?1/0:0;for(let t=0;t<e.length;++t){const{offset:r=n,shaderLoc:l=a}=e[t];for(s[t]={...e[t],offset:r,shaderLoc:l},i[a=l]=!0;i[++a];);n=Math.max(n,r+ne(s[t].format)),o=Math.min(o,r)}return{attrs:s,stride:t||n-o,instanced:r}})),o=(t.uniforms||[]).map((e=>({name:e.name,type:e.type||Y.Value,texType:e.texType||X.Tex2D,valueFormat:e.valueFormat||H.Float})));this.instanced=l,this.props={vert:t.vert,frag:t.frag,indexFormat:t.indexFormat||E.UInt16,mode:null!==(r=t.mode)&&void 0!==r?r:Z.Tri,buffers:n,uniforms:o,raster:{...xe,...t.raster},depth:t.depth?{...we,...t.depth}:null,stencil:t.stencil?{...ye,...t.stencil}:null,blend:t.blend?{...Fe,...t.blend}:null};const p=this.glp=function(e,t,r,s){const i=e.createProgram();e.attachShader(i,t.gls),e.attachShader(i,r.gls);for(let t=0;t<s.length;++t){const r=s[t].attrs;for(let t=0;t<r.length;++t)e.bindAttribLocation(i,r[t].shaderLoc||0,r[t].name)}return e.linkProgram(i),i}(s,t.vert,t.frag,n),h=this.cache={};let c=0,u=0;for(let e=0;e<o.length;++e){const t=o[e];let r=null,i=C;t.type===Y.Buffer?(i=s.getUniformBlockIndex(p,t.name),s.uniformBlockBinding(p,i,c++)):r=s.getUniformLocation(p,t.name),null===r&&i===C||(h[t.name]={...t,loc:r,index:i,binding:t.type===Y.Tex?u++:t.type===Y.Buffer?c:-1})}}destroy(){this.gl.deleteProgram(this.glp),this.glp=null}}class Te{constructor(e,t={}){var r,s,i;this.glfb=null,this.glrfb=[];const a=this.gl=e.gl,l=e.feature(me.DrawBuffers),n=(null===(r=t.color)||void 0===r?void 0:r.map(Re))||[],o=Re(t.depth),p=o&&le(o.tex.props.format)||!1;if(this.props={color:n,depth:o,clearColor:t.clearColor||null,clearDepth:null!==(s=t.clearDepth)&&void 0!==s?s:NaN,clearStencil:null!==(i=t.clearStencil)&&void 0!==i?i:NaN},n.length){this.glfb=a.createFramebuffer(),a.bindFramebuffer(F,this.glfb);const t=l||e.webgl2?n.length:1;for(let r=0;r<t;++r)e.webgl2&&n[r].tex.props.samples>1?a.framebufferRenderbuffer(F,_+r,S,n[r].tex.glrb):Le(a,_+r,n[r]);if(t>1&&(e.webgl2?a.drawBuffers(n.map(((e,t)=>_+t))):l&&l.drawBuffersWEBGL(n.map(((e,t)=>_+t)))),o&&(o.tex.props.renderTarget||e.webgl2&&o.tex.props.samples>1?a.framebufferRenderbuffer(F,p?O:B,S,o.tex.glrb):ae(o.tex.props.format)&&Le(a,p?O:B,o)),e.webgl2){for(let e=0;e<t;++e)this.glrfb.push(n[e].tex.props.samples>1?De(a,_,n[e]):null);this.glrfb.push(o&&o.tex.props.samples>1?De(a,p?O:B,o):null)}}}destroy(){this.gl.deleteFramebuffer(this.glfb),this.glfb=null;for(const e of this.glrfb)this.gl.deleteFramebuffer(e);this.glrfb=[]}resolve(){for(let e=0;e<this.glrfb.length-1;++e)this.glrfb[e]&&Pe(this.gl,this.glfb,this.glrfb[e],this.props.color[e].tex,s,_+e);const e=this.glrfb[this.glrfb.length-1];this.props.depth&&e&&Pe(this.gl,this.glfb,e,this.props.depth.tex,1280)}}function Le(e,t,{tex:r,slice:s,mipLevel:i}){if(ie(r.props.type))e.framebufferTextureLayer(F,t,r.glt,i,s);else{const a=34067===r.props.type?v+s:r.props.type;e.framebufferTexture2D(F,t,a,r.glt,i)}}function De(e,t,r){const s=e.createFramebuffer();return e.bindFramebuffer(F,s),Le(e,t,r),s}function Pe(e,t,r,s,i,a=-1){e.bindFramebuffer(36008,t),e.bindFramebuffer(36009,r),a>=0&&e.readBuffer(a),e.blitFramebuffer(0,0,s.props.width,s.props.height,0,0,s.props.width,s.props.height,i,b)}function Re(e){return e?{slice:0,mipLevel:0,...e}:null}class Ie{constructor(e,t={},r={},s=!1){var i,a;this.glt=null,this.glrb=null,this.webgl2=s;const l=this.gl=e.gl,n=t.type||X.Tex2D,o=t.format||W.RGBA8,p=n===X.Cube,h=ae(o)&&(t.renderTarget||!1),c=ue(o,s);if(this.props={type:n,format:o,width:t.width||1,height:t.height||1,depth:p?6:t.depth||1,mipLevels:t.mipLevels||1,samples:s&&t.samples||1,renderTarget:h},this.sampler={wrapU:r.wrapU||k.Clamp,wrapV:r.wrapV||k.Clamp,wrapW:r.wrapW||k.Clamp,magFilter:r.magFilter||V.Nearest,minFilter:r.minFilter||j.Nearest,maxLOD:null!==(i=r.maxLOD)&&void 0!==i?i:1e3,minLOD:null!==(a=r.minLOD)&&void 0!==a?a:-1e3,maxAniso:r.maxAniso||1},(h||this.props.samples>1)&&(l.bindRenderbuffer(S,this.glrb=l.createRenderbuffer()),this.props.samples>1?l.renderbufferStorageMultisample(S,this.props.samples,c,this.props.width,this.props.height):l.renderbufferStorage(S,c,this.props.width,this.props.height)),!h)if(l.activeTexture(x),l.bindTexture(n,this.glt=l.createTexture()),l.texParameteri(n,10241,this.sampler.minFilter),l.texParameteri(n,10240,this.sampler.magFilter),l.texParameteri(n,10242,this.sampler.wrapU),l.texParameteri(n,10243,this.sampler.wrapV),s&&(l.texParameteri(n,32882,this.sampler.wrapW),l.texParameterf(n,33083,this.sampler.maxLOD),l.texParameterf(n,33082,this.sampler.minLOD)),this.sampler.maxAniso>1&&l.texParameterf(n,34046,Math.min(this.sampler.maxAniso,l.getParameter(34047))),s)ie(n)?l.texStorage3D(n,this.props.mipLevels,c,this.props.width,this.props.height,this.props.depth):l.texStorage2D(n,this.props.mipLevels,c,this.props.width,this.props.height);else{const e=fe(o),t=de(o,this.webgl2),r=p?v:n,s=p?6:1;for(let i=0;i<s;++i)for(let s=0;s<this.props.mipLevels;++s)l.texImage2D(r+i,s,c,this.props.width>>s||1,this.props.height>>s||1,0,e,t,null)}}data(e,[t,r,s=0]=[0,0],[i,a,l=this.props.depth-s]=[this.props.width-t,this.props.height-r],n=0){var o;const p=fe(this.props.format),h=de(this.props.format,this.webgl2),c=this.props.type===X.Cube,u=this.props.type===X.Array,f=c?v+s:this.props.type;this.gl.activeTexture(x),this.gl.bindTexture(this.props.type,this.glt);const d=(c||u)&&(null===(o=e.images)||void 0===o?void 0:o.length)||1,g=e.buffer||null;let m=e.image||null;for(let o=0;o<d;++o){var b;m=(null===(b=e.images)||void 0===b?void 0:b[o])||m,ie(this.props.type)?this.gl.texSubImage3D(f,n,t,r,s+o*l,i,a,l,p,h,m||g):g?this.gl.texSubImage2D(f+o,n,t,r,i,a,p,h,g):m&&this.gl.texSubImage2D(f+o,n,t,r,p,h,m)}return this}mipmap(e=U.None){return this.gl.activeTexture(x),this.gl.bindTexture(this.props.type,this.glt),this.gl.hint(33170,e),this.gl.generateMipmap(this.props.type),this}destroy(){this.gl.deleteTexture(this.glt),this.gl.deleteRenderbuffer(this.glrb),this.glt=this.glrb=null}}const Ne=(e,t={})=>{let r=null,s=!1;return t.webgl2&&(s=!!(r=e.getContext("webgl2",t))),r||(r=e.getContext("webgl",t)||e.getContext("experimental-webgl",t)),r?new Ve(r,s):null};class Ve{constructor(e,t){this.gl=e,this.webgl2=t,this.canvas=e.canvas,this.maxAttr=Math.min(e.getParameter(34921),16);for(const e of Object.values(t?be:me))this.feature(e);this.state=this.reset(),this.renderCtx=new Ge(e,t,this.state,this.maxAttr,this.feature(me.Instancing))}get width(){return this.gl.drawingBufferWidth}get height(){return this.gl.drawingBufferHeight}buffer(e){return new ve(this,e)}texture(e,t){return new Ie(this,e,t)}shader(e){return new Ce(this,e)}pipeline(e){return new ke(this,e)}pass(e){return new Te(this,e)}render(e){let t=this.width,i=this.height;e.props.color.length&&(t=e.props.color[0].tex.props.width,i=e.props.color[0].tex.props.height),this.gl.bindFramebuffer(F,e.glfb),this.gl.viewport(0,0,t,i),this.gl.depthRange(0,1),this.state.scissor&&(this.state.scissor=!1,this.gl.disable(p));const a=this.state.pipe.blend||Fe,l=this.state.pipe.depth||we,n=this.state.pipe.stencil||ye;let o=0;return e.props.clearColor&&(o|=s,this.gl.clearColor(...e.props.clearColor),Ae(this.gl,a.colorMask,P.All)),isNaN(e.props.clearDepth)||(o|=256,this.gl.clearDepth(e.props.clearDepth),_e(this.gl,l.write,!0)),isNaN(e.props.clearStencil)||(o|=r,this.gl.clearStencil(e.props.clearStencil),Be(this.gl,n.writeMask,se)),o&&(this.gl.clear(o),o&s&&Ae(this.gl,P.All,a.colorMask),256&o&&_e(this.gl,!0,l.write),o&r&&Be(this.gl,se,n.writeMask)),this.renderCtx.pass=e,this.renderCtx}feature(e){return this.gl.getExtension(e)}reset(){return Object.assign(this.state||{},function(e,t){const r={blend:null,blendOn:!1,depth:null,depthOn:!1,stencil:null,stencilOn:!1,raster:{...xe}},s=[1,1,1,1];e.useProgram(null),e.blendColor(...s),Se(e,r,r,0,!0);for(let r=0;r<t;++r)e.disableVertexAttribArray(r);return{pipeObj:null,bufs:[],attrs:[],idx:null,idxFmt:E.UInt16,mode:Z.Tri,pipe:r,blend:s,stencilRef:0,scissor:!1}}(this.gl,this.maxAttr))}}class Ge{constructor(e,t,r,s,i){this.pass=null,this.gl=e,this.webgl2=t,this.state=r,this.maxAttr=s,this.extInst=i}pipeline(e){if(this.state.pipeObj===e)return this;this.state.pipeObj&&this.state.pipeObj.glp===e.glp||this.gl.useProgram(e.glp),this.state.pipeObj=e;const t=this.state.pipe;var r,s;Se(this.gl,t,e.props,this.state.stencilRef),r=t,s=e.props,r.blend=Me(r.blend,s.blend),r.blendOn=!!s.blend,r.depth=Me(r.depth,s.depth),r.depthOn=!!s.depth,r.stencil=Me(r.stencil,s.stencil),r.stencilOn=!!s.stencil,Object.assign(r.raster,s.raster);const i=this.state.bufs=Array(e.props.buffers.length),a=Array(this.maxAttr).fill(null),l=this.state.attrs;this.state.attrs=a;for(let t=0;t<e.props.buffers.length;++t){const{attrs:r,stride:s,instanced:l}=e.props.buffers[t],n=[];i[t]={glb:null,attrs:n};for(const{format:e,offset:i,shaderLoc:o}of r)n.push(a[o]={buf:t,ptr:[o,oe(e),pe(e),he(e),s,i],step:l?1:0})}for(let e=0;e<this.maxAttr;++e)a[e]&&!l[e]?this.gl.enableVertexAttribArray(e):!a[e]&&l[e]&&this.gl.disableVertexAttribArray(e);return this.state.idxFmt=e.props.indexFormat,this.state.mode=e.props.mode,this}index({glb:e}){return e!==this.state.idx&&this.gl.bindBuffer(l,this.state.idx=e),this}vertex(e,{glb:t}){const r=this.state.bufs[e];if(r&&r.glb!==t){this.gl.bindBuffer(a,r.glb=t);for(let e=0;e<r.attrs.length;++e){const{ptr:t,step:i}=r.attrs[e];var s;this.gl.vertexAttribPointer(...t),this.webgl2?this.gl.vertexAttribDivisor(t[0],i):null===(s=this.extInst)||void 0===s||s.vertexAttribDivisorANGLE(t[0],i)}}return this}uniforms(e){if(!this.state.pipeObj)return this;for(let r=0;r<e.length;++r){const s=e[r],i=this.state.pipeObj.cache[s.name];if(i)if(i.type===Y.Value)if(s.values)switch(i.valueFormat){case H.Mat4:this.gl.uniformMatrix4fv(i.loc,!1,s.values);break;case H.Mat3:this.gl.uniformMatrix3fv(i.loc,!1,s.values);break;case H.Mat2:this.gl.uniformMatrix2fv(i.loc,!1,s.values);break;case H.Vec4:this.gl.uniform4fv(i.loc,s.values);break;case H.Vec3:this.gl.uniform3fv(i.loc,s.values);break;case H.Vec2:this.gl.uniform2fv(i.loc,s.values);break;case H.Float:this.gl.uniform1fv(i.loc,s.values)}else(s.value||0===s.value)&&i.valueFormat===H.Float&&this.gl.uniform1f(i.loc,s.value);else if(i.type===Y.Tex)s.tex&&(this.gl.activeTexture(x+i.binding),this.gl.bindTexture(s.tex.props.type,s.tex.glt),this.gl.uniform1i(i.loc,i.binding));else if(i.type===Y.Buffer){var t;if((null===(t=s.buffer)||void 0===t?void 0:t.props.type)===M){const e=s.bufferOffset||0;this.gl.bindBufferRange(M,i.index,s.buffer.glb,e,s.bufferSize||s.buffer.props.size-e)}}}return this}draw(e,t=1,r=0){return this.state.pipeObj?(this.state.pipeObj.instanced&&(this.webgl2||this.extInst)?this.webgl2?this.gl.drawArraysInstanced(this.state.mode,r,e,t):this.extInst.drawArraysInstancedANGLE(this.state.mode,r,e,t):this.gl.drawArrays(this.state.mode,r,e),this):this}drawIndexed(e,t=1,r=0){if(!this.state.pipeObj)return this;const{mode:s,idxFmt:i}=this.state,a=r*ce(i);return this.state.pipeObj.instanced&&(this.webgl2||this.extInst)?this.webgl2?this.gl.drawElementsInstanced(s,e,i,a,t):this.extInst.drawElementsInstancedANGLE(s,e,i,a,t):this.gl.drawElements(s,e,i,a),this}viewport(e,t,r,s,i=0,a=1){return this.gl.viewport(e,t,r,s),this.gl.depthRange(i,a),this}scissor(e,t,r,s){return this.state.scissor||(this.gl.enable(p),this.state.scissor=!0),this.gl.scissor(e,t,r,s),this}blendColor(e){return this.gl.blendColor(...e),this}stencilRef(e){if(this.state.stencilRef!==e){const{frontCompare:t,backCompare:r,readMask:s}=this.state.pipe.stencil||ye;this.gl.stencilFuncSeparate(n,t,e,s),this.gl.stencilFuncSeparate(o,r,e,s),this.state.stencilRef=e}return this}end(){var e;null===(e=this.pass)||void 0===e||e.resolve(),this.pass=null}}const Ee=4294967295;function Ue(e,t=Ne){let r={};const s={};let i=1;const a={},l={};let n=1;const o={},p={};let h=1;const c={};let u=1;const f={};let d=1;const g={};let m=1;const b={};let v=1;const x={};let w=1;const y={};let F=1;const S={},A={};return e.mugl={getCanvasById(e){const t=r.__getString(e);if(a[t])return a[t];const s=document.getElementById(t);return s?(a[t]=i,l[i]=s,i++):0},createImage(e){const t=p[n]=new Image;return t.crossOrigin="anonymous",t.src=r.__getString(e),n++},getImageById(e){const t=r.__getString(e);if(o[t])return o[t];const s=document.getElementById(t);return s?(o[t]=n,p[n]=s,n++):0},deleteImage(e){delete p[e]},getGLDevice(e,r){const s={alpha:!!(1&r),antialias:!!(2&r),depth:!!(4&r),desynchronized:!!(8&r),failIfMajorPerformanceCaveat:!!(16&r),powerPreference:64&r?"high-performance":32&r?"low-power":"default",premultipliedAlpha:!!(128&r),preserveDrawingBuffer:!!(256&r),stencil:!!(512&r),webgl2:!!(1024&r)},i=l[e]&&t(l[e],s);return i?(c[h]=i,h++):0},getCanvasWidth(e){var t;return null===(t=c[e])||void 0===t?void 0:t.width},getCanvasHeight(e){var t;return null===(t=c[e])||void 0===t?void 0:t.height},resetDevice(e){var t;null===(t=c[e])||void 0===t||t.reset()},deviceFeature(e,t){var s;return!(null===(s=c[e])||void 0===s||!s.feature(r.__getString(t)))},createBuffer(e,t,r,s){const i=c[e];return i?(f[u]=i.buffer({type:t,size:r,usage:s}),u++):0},deleteBuffer(e){var t;null===(t=f[e])||void 0===t||t.destroy(),delete f[e]},bufferData(e,t,s){var i;null===(i=f[e])||void 0===i||i.data(r.__getArrayView(t),s)},createTexture(e,t,r,s,i,a,l,n,o,p,h,u,f,m,b,v,x){const w=c[e];return w?(g[d]=w.texture({type:t,format:r,width:s,height:i,depth:a,mipLevels:l,samples:n,renderTarget:o},{wrapU:p,wrapV:h,wrapW:u,magFilter:f,minFilter:m,minLOD:b,maxLOD:v,maxAniso:x}),d++):0},deleteTexture(e){var t;null===(t=g[e])||void 0===t||t.destroy(),delete g[e]},textureBuffer(e,t,s,i,a){var l;const n=r.__getArrayView(t);null===(l=g[e])||void 0===l||l.data({buffer:n},r.__getArrayView(s),r.__getArrayView(i),a)},textureImages(e,t,s,i,a){var l;const n=r.__getArrayView(t),o=new Array(n.length);for(let e=0;e<n.length;++e)o[e]=p[n[e]];null===(l=g[e])||void 0===l||l.data({images:o},r.__getArrayView(s),r.__getArrayView(i),a)},mipmap(e,t){var r;null===(r=g[e])||void 0===r||r.mipmap(t)},createShader(e,t,s){const i=c[e];return i?(b[m]=i.shader({type:t,source:r.__getString(s)}),m++):0},deleteShader(e){var t;null===(t=b[e])||void 0===t||t.destroy(),delete b[e]},createRenderPass(e,t,s,i,a,l,n,o,p,h){const u=c[e];if(!u)return 0;const f=[];if(t){const e=r.__getArrayView(s),a=r.__getArrayView(i),l=r.__getArrayView(t);for(let t=0;t<l.length;++t)f.push({tex:g[l[t]],mipLevel:e[t],slice:a[t]})}return x[v]=u.pass({color:f,depth:g[a]?{tex:g[a],mipLevel:l,slice:n}:null,clearColor:o?r.__getArray(o):null,clearDepth:p,clearStencil:h}),v++},deleteRenderPass(e){var t;null===(t=x[e])||void 0===t||t.destroy(),delete x[e]},resolveRenderPass(e){var t;null===(t=x[e])||void 0===t||t.resolve()},createPipeline(e,t,s,i,a,l,n,o,p,h,u,f,d,g,m,v,x,F,S,A,_,B,O,M,C,k,T,L,D,P,R,I,N,V,G,E,U,j,W,Z,z){const q=c[e];if(!q)return 0;const X=r.__getArrayView(l),H=Array(X.length);for(let e=0;e<H.length;++e)H[e]={attrs:[],stride:X[e]>>1,instanced:!!(1&X[e])};const Y=r.__getArrayView(n),K=Array(Y.length);for(let e=0;e<K.length;++e)K[e]=r.__getString(Y[e]);const J=r.__getArrayView(o),Q=r.__getArrayView(p),$=r.__getArrayView(h),ee=r.__getArrayView(u);for(let e=0;e<K.length;++e)H[J[e]].attrs.push({name:K[e],format:Q[e],shaderLoc:$[e]===Ee?void 0:$[e],offset:ee[e]===Ee?void 0:ee[e]});const te=[];if(f){const e=r.__getArrayView(f),t=Array(e.length);for(let s=0;s<t.length;++s)t[s]=r.__getString(e[s]);const s=r.__getArrayView(d),i=r.__getArrayView(g);for(let e=0;e<t.length;++e)te.push({name:t[e],type:s[e],texType:i[e],valueFormat:i[e]})}return y[w]=q.pipeline({vert:b[t],frag:b[s],indexFormat:i,mode:a,buffers:H,uniforms:te,raster:{frontFace:m,cullMode:v,depthBias:x,depthBiasSlopeScale:F,alphaToCoverage:S},depth:A?{write:_,compare:B}:null,stencil:O?{frontCompare:M,frontFailOp:C,frontZFailOp:k,frontPassOp:T,backCompare:L,backFailOp:D,backZFailOp:P,backPassOp:R,readMask:I,writeMask:N}:null,blend:V?{srcFactorRGB:G,dstFactorRGB:E,opRGB:U,srcFactorAlpha:j,dstFactorAlpha:W,opAlpha:Z,colorMask:z}:null}),w++},deletePipeline(e){var t;null===(t=y[e])||void 0===t||t.destroy(),delete y[e]},render(e,t){const r=c[e],s=x[t];return r&&s?(S[F]=r.render(s),A[F]=[],F++):0},endRender(e){var t;null===(t=S[e])||void 0===t||t.end(),delete S[e],delete A[e]},bindPipeline(e,t){var r;y[t]&&(null===(r=S[e])||void 0===r||r.pipeline(y[t]))},bindVertexBuffer(e,t,r){var s;f[r]&&(null===(s=S[e])||void 0===s||s.vertex(t,f[r]))},bindIndexBuffer(e,t){var r;f[t]&&(null===(r=S[e])||void 0===r||r.index(f[t]))},bindUniform(e,t,i,a,l,n,o,p){var h;let c;a&&(c=r.__getArrayView(a),r.__pin(a),s[a]=a),null===(h=A[e])||void 0===h||h.push({name:r.__getString(t),value:i,values:c,tex:g[l],buffer:f[n],bufferOffset:o,bufferSize:p})},draw(e,t,i,a,l){const n=A[e];var o,p,h;null!=n&&n.length&&(null===(o=S[e])||void 0===o||o.uniforms(n),n.length=0),t?null===(p=S[e])||void 0===p||p.drawIndexed(i,a,l):null===(h=S[e])||void 0===h||h.draw(i,a,l);for(const e in s)r.__unpin(s[e]),delete s[e]},viewport(e,t,r,s,i,a,l){var n;null===(n=S[e])||void 0===n||n.viewport(t,r,s,i,a,l)},scissor(e,t,r,s,i){var a;null===(a=S[e])||void 0===a||a.scissor(t,r,s,i)},blendColor(e,t){var s;null===(s=S[e])||void 0===s||s.blendColor(r.__getArrayView(t))},stencilRef(e,t){var r;null===(r=S[e])||void 0===r||r.stencilRef(t)}},{bindModule(e){r=e},addCanvas:(e,t)=>(a[e]=i,l[i]=t,i++),addImage:(e,t)=>(o[e]=n,p[n]=t,n++),pinned:s,canvasIdMap:a,canvas:l,imageIdMap:o,images:p,devices:c,renderPassContexts:S,boundUniforms:A,buffers:f,textures:g,shaders:b,renderPasses:x,pipelines:y}}class je{constructor(e,t){this.gl=e,this.props={type:a,usage:35044,...t},e.bindBuffer(this.props.type,this.glb=e.createBuffer()),e.bufferData(this.props.type,this.props.size,this.props.usage)}data(e,t=0){return this.gl.bindBuffer(this.props.type,this.glb),this.gl.bufferSubData(this.props.type,t,e),this}destroy(){this.gl.deleteBuffer(this.glb)}}class We{constructor(e,t,r){this.glt=null,this.glrb=null,this.gl=e;const s=this.props={type:3553,format:263169,width:1,height:1,...t},i=this.sampler={wrapU:w,wrapV:w,magFilter:b,minFilter:b,...r};s.format<=197381?(e.bindRenderbuffer(S,this.glrb=e.createRenderbuffer()),e.renderbufferStorage(S,A,s.width,s.height)):(e.bindTexture(s.type,this.glt=e.createTexture()),e.texParameteri(s.type,10241,i.minFilter),e.texParameteri(s.type,10240,i.magFilter),e.texParameteri(s.type,10242,i.wrapU),e.texParameteri(s.type,10243,i.wrapV),e.texImage2D(s.type,0,d,s.width,s.height,0,d,c,null))}data(e,[t,r]=[0,0,0],[s,i]=[this.props.width-t,this.props.height-r,0]){return this.gl.bindTexture(this.props.type,this.glt),e.buffer?this.gl.texSubImage2D(this.props.type,0,t,r,s,i,d,c,e.buffer):e.image&&this.gl.texSubImage2D(this.props.type,0,t,r,d,c,e.image),this}mipmap(){return this.gl.bindTexture(this.props.type,this.glt),this.gl.generateMipmap(this.props.type),this}destroy(){this.gl.deleteTexture(this.glt),this.gl.deleteRenderbuffer(this.glrb)}}class Ze{constructor(e,t,r){if(this.glfb=null,this.gl=e,this.props=t,t.color&&t.color.length){e.bindFramebuffer(F,this.glfb=e.createFramebuffer());const s=r?t.color.length:1;for(let r=0;r<s;++r)e.framebufferTexture2D(F,_+r,t.color[r].tex.props.type,t.color[r].tex.glt,0);s>1&&r.drawBuffersWEBGL(t.color.map(((e,t)=>_+t))),t.depth&&e.framebufferRenderbuffer(F,O,S,t.depth.tex.glrb)}}destroy(){this.gl.deleteFramebuffer(this.glfb)}resolve(){}}class ze{constructor(e,t){this.gl=e;const r=this.gls=e.createShader(this.type=t.type);e.shaderSource(r,this.source=t.source),e.compileShader(r)}destroy(){this.gl.deleteShader(this.gls)}}class qe{constructor(e,t){this.gl=e;let r=0;this.props={mode:4,indexFormat:u,...t,buffers:t.buffers.map((({attrs:e,stride:t,instanced:s=!1})=>{this.i=this.i||s;const i=Array(e.length);let a=0;for(let t=0;t<e.length;++t,++r){const{name:s,format:l,offset:n=a,shaderLoc:o=r}=e[t];i[t]={name:s,format:l,offset:n,shaderLoc:o},a=Math.max(a,n)+ne(l)}return{attrs:i,stride:t||a,instanced:s}}))},this.glp=function(e,t,r,s){const i=e.createProgram();e.attachShader(i,t.gls),e.attachShader(i,r.gls);for(const{attrs:t}of s)for(const r of t)e.bindAttribLocation(i,r.shaderLoc,r.name);return e.linkProgram(i),i}(e,t.vert,t.frag,this.props.buffers)}destroy(){this.gl.deleteProgram(this.glp)}}function Xe(e,t,r){r?e.enable(t):e.disable(t)}const He=(e,t)=>{const r=e.getContext("webgl",t);return r?new Ye(r):null};class Ye{constructor(e){this.webgl2=!1,this.gl=e,this.canvas=e.canvas,this.d=this.feature("WEBGL_draw_buffers"),this.r=new Ke(e,this.feature("ANGLE_instanced_arrays"))}get width(){return this.gl.drawingBufferWidth}get height(){return this.gl.drawingBufferHeight}buffer(e){return new je(this.gl,e)}texture(e,t){return new We(this.gl,e,t)}shader(e){return new ze(this.gl,e)}pipeline(e){return new qe(this.gl,e)}pass(e={}){return new Ze(this.gl,e,this.d)}render(e){let t=this.width,i=this.height;e.props.color&&({width:t,height:i}=e.props.color[0].tex.props),this.gl.bindFramebuffer(F,e.glfb),this.gl.viewport(0,0,t,i),this.gl.disable(p);let a=0;return e.props.clearColor&&(a|=s,this.gl.clearColor(...e.props.clearColor),this.gl.colorMask(!0,!0,!0,!0)),isNaN(e.props.clearDepth)||(a|=256,this.gl.clearDepth(e.props.clearDepth),this.gl.depthMask(!0)),isNaN(e.props.clearStencil)||(a|=r,this.gl.clearStencil(e.props.clearStencil),this.gl.stencilMask(se)),a&&this.gl.clear(a),this.r}feature(e){return this.gl.getExtension(e)}reset(){this.r.reset()}}class Ke{constructor(e,t){this.gl=e,this.inst=t,this.reset()}reset(){this.s={p:null,r:0}}pipeline(e){if(this.s.p!==e){this.s.p=e,this.gl.useProgram(e.glp),function(e,t,r=0){const{blend:s,depth:a,stencil:l}=t,p=t.raster||{};if(Xe(e,32926,!!p.alphaToCoverage),Xe(e,2884,!!p.cullMode),Xe(e,32823,!(!p.depthBiasSlopeScale&&!p.depthBias)),e.polygonOffset(p.depthBiasSlopeScale||0,p.depthBias||0),p.cullMode&&e.cullFace(p.cullMode),e.frontFace(p.frontFace||h),Xe(e,2929,!!a),a&&(e.depthMask(!!a.write),e.depthFunc(a.compare||g)),Xe(e,2960,!!l),l){var c,u;e.stencilMask(null!==(c=l.writeMask)&&void 0!==c?c:se);const t=null!==(u=l.readMask)&&void 0!==u?u:se;e.stencilFuncSeparate(n,l.frontCompare||g,r,t),e.stencilFuncSeparate(o,l.backCompare||g,r,t),e.stencilOpSeparate(n,l.frontFailOp||m,l.frontZFailOp||m,l.frontPassOp||m),e.stencilOpSeparate(o,l.backFailOp||m,l.backZFailOp||m,l.backPassOp||m)}if(Xe(e,3042,!!s),s){const t=s.colorMask||se;e.colorMask(!!(1&t),!!(2&t),!!(4&t),!!(8&t)),e.blendFuncSeparate(s.srcFactorRGB||1,s.dstFactorRGB||0,s.srcFactorAlpha||1,s.dstFactorAlpha||0),e.blendEquationSeparate(s.opRGB||i,s.opAlpha||i)}}(this.gl,e.props,this.s.r);for(let e=0;e<16;++e)this.gl.disableVertexAttribArray(e);for(const{attrs:t}of e.props.buffers)for(const{shaderLoc:e}of t)this.gl.enableVertexAttribArray(e)}return this}index({glb:e}){return this.gl.bindBuffer(l,e),this}vertex(e,{glb:t}){const{attrs:r,stride:s,instanced:i}=this.s.p.props.buffers[e];this.gl.bindBuffer(a,t);for(const{format:e,offset:t,shaderLoc:a}of r)this.gl.vertexAttribPointer(a,oe(e),pe(e),he(e),s,t),this.inst&&this.inst.vertexAttribDivisorANGLE(a,i?1:0);return this}uniforms(e){let t=0;for(const r of e){const e=this.gl.getUniformLocation(this.s.p.glp,r.name);if(e)if(r.values){const t=this.s.p.props.uniforms.find((e=>e.name===r.name));if(t)switch(t.valueFormat){case 35676:this.gl.uniformMatrix4fv(e,!1,r.values);break;case y:this.gl.uniformMatrix3fv(e,!1,r.values);break;case 35666:this.gl.uniform4fv(e,r.values);break;case 35665:this.gl.uniform3fv(e,r.values);break;case 35664:this.gl.uniform2fv(e,r.values);break;default:this.gl.uniform1fv(e,r.values)}}else r.tex?(this.gl.activeTexture(x+t),this.gl.bindTexture(r.tex.props.type,r.tex.glt),this.gl.uniform1i(e,t++)):isNaN(r.value)||this.gl.uniform1f(e,r.value)}return this}draw(e,t=1,r=0){const{props:{mode:s},i}=this.s.p;return i?this.inst&&this.inst.drawArraysInstancedANGLE(s,r,e,t):this.gl.drawArrays(s,r,e),this}drawIndexed(e,t=1,r=0){const{props:{indexFormat:s,mode:i},i:a}=this.s.p;return a?this.inst&&this.inst.drawElementsInstancedANGLE(i,e,s,r*ce(s),t):this.gl.drawElements(i,e,s,r*ce(s)),this}viewport(e,t,r,s){return this.gl.viewport(e,t,r,s),this}scissor(e,t,r,s){return this.gl.scissor(e,t,r,s),this}blendColor(e){return this.gl.blendColor(...e),this}stencilRef(e){{const r=this.s.p&&this.s.p.props.stencil;if(r){var t;const s=null!==(t=r.readMask)&&void 0!==t?t:se;this.gl.stencilFuncSeparate(n,r.frontCompare||g,e,s),this.gl.stencilFuncSeparate(o,r.backCompare||g,e,s)}this.s.r=e}return this}end(){}}return t})()},"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("mugl",[],t):"object"==typeof exports?exports.mugl=t():e.mugl=t();