var t,e;t=self,e=function(){return(()=>{var t={d:(e,r)=>{for(var s in r)t.o(r,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:r[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{getNGLDevice:()=>M});const r=1028,s=1029,i=5121,o=5123,a=6408,l=519,n=7680,h=36160,p=36161,c=[5126,5120,i,5122,o],f=[4,1,1,2,2],u=255;function g(t){return f[t&u]*d(t)}function d(t){return t>>8&u}function b(t){return c[t&u]}function m(t){return!!(t>>16)}function y(t){return t-o+2}class x{constructor(t,e){this.gl=t,this.props={type:34962,usage:35044,...e},t.bindBuffer(this.props.type,this.glb=t.createBuffer()),t.bufferData(this.props.type,this.props.size,this.props.usage)}data(t,e=0){return this.gl.bindBuffer(this.props.type,this.glb),this.gl.bufferSubData(this.props.type,e,t),this}destroy(){this.gl.deleteBuffer(this.glb)}}class v{constructor(t,e,r){this.glt=null,this.glrb=null,this.gl=t;const s=this.props={type:3553,format:263169,width:1,height:1,...e},o=this.sampler={wrapU:33071,wrapV:33071,magFilter:9728,minFilter:9728,...r};s.format<=197381?(t.bindRenderbuffer(p,this.glrb=t.createRenderbuffer()),t.renderbufferStorage(p,34041,s.width,s.height)):(t.bindTexture(s.type,this.glt=t.createTexture()),t.texParameteri(s.type,10241,o.minFilter),t.texParameteri(s.type,10240,o.magFilter),t.texParameteri(s.type,10242,o.wrapU),t.texParameteri(s.type,10243,o.wrapV),t.texImage2D(s.type,0,a,s.width,s.height,0,a,i,null))}data(t,[e,r]=[0,0,0],[s,o]=[this.props.width-e,this.props.height-r,0]){return this.gl.bindTexture(this.props.type,this.glt),t.buffer?this.gl.texSubImage2D(this.props.type,0,e,r,s,o,a,i,t.buffer):t.image&&this.gl.texSubImage2D(this.props.type,0,e,r,a,i,t.image),this}mipmap(){return this.gl.bindTexture(this.props.type,this.glt),this.gl.generateMipmap(this.props.type),this}destroy(){this.gl.deleteTexture(this.glt),this.gl.deleteRenderbuffer(this.glrb)}}class w{constructor(t,e,r){if(this.glfb=null,this.gl=t,this.props=e,e.color&&e.color.length){t.bindFramebuffer(h,this.glfb=t.createFramebuffer());const s=r?e.color.length:1;for(let r=0;r<s;++r)t.framebufferTexture2D(h,36064+r,e.color[r].tex.props.type,e.color[r].tex.glt,0);s>1&&r.drawBuffersWEBGL(e.color.map(((t,e)=>36064+e))),e.depth&&t.framebufferRenderbuffer(h,33306,p,e.depth.tex.glrb)}}destroy(){this.gl.deleteFramebuffer(this.glfb)}resolve(){}}class S{constructor(t,e){this.gl=t;const r=this.gls=t.createShader(this.type=e.type);t.shaderSource(r,this.source=e.source),t.compileShader(r)}destroy(){this.gl.deleteShader(this.gls)}}class F{constructor(t,e){this.gl=t;let r=0;this.props={mode:4,indexFormat:o,...e,buffers:e.buffers.map((({attrs:t,stride:e,instanced:s=!1})=>{this.i=this.i||s;const i=Array(t.length);let o=0;for(let e=0;e<t.length;++e,++r){const{name:s,format:a,offset:l=o,shaderLoc:n=r}=t[e];i[e]={name:s,format:a,offset:l,shaderLoc:n},o=Math.max(o,l)+g(a)}return{attrs:i,stride:e||o,instanced:s}}))},this.glp=function(t,e,r,s){const i=t.createProgram();t.attachShader(i,e.gls),t.attachShader(i,r.gls);for(const{attrs:e}of s)for(const r of e)t.bindAttribLocation(i,r.shaderLoc,r.name);return t.linkProgram(i),i}(t,e.vert,e.frag,this.props.buffers)}destroy(){this.gl.deleteProgram(this.glp)}}function k(t,e,r){r?t.enable(e):t.disable(e)}const M=(t,e)=>{const r=t.getContext("webgl",e);return r?new B(r):null};class B{constructor(t){this.webgl2=!1,this.gl=t,this.canvas=t.canvas,this.d=this.feature("WEBGL_draw_buffers"),this.r=new A(t,this.feature("ANGLE_instanced_arrays"))}get width(){return this.gl.drawingBufferWidth}get height(){return this.gl.drawingBufferHeight}buffer(t){return new x(this.gl,t)}texture(t,e){return new v(this.gl,t,e)}shader(t){return new S(this.gl,t)}pipeline(t){return new F(this.gl,t)}pass(t={}){return new w(this.gl,t,this.d)}render(t){let e=this.width,r=this.height;t.props.color&&({width:e,height:r}=t.props.color[0].tex.props),this.gl.bindFramebuffer(h,t.glfb),this.gl.viewport(0,0,e,r),this.gl.disable(3089);let s=0;return t.props.clearColor&&(s|=16384,this.gl.clearColor(...t.props.clearColor),this.gl.colorMask(!0,!0,!0,!0)),isNaN(t.props.clearDepth)||(s|=256,this.gl.clearDepth(t.props.clearDepth),this.gl.depthMask(!0)),isNaN(t.props.clearStencil)||(s|=1024,this.gl.clearStencil(t.props.clearStencil),this.gl.stencilMask(u)),s&&this.gl.clear(s),this.r}feature(t){return this.gl.getExtension(t)}reset(){this.r.reset()}}class A{constructor(t,e){this.gl=t,this.inst=e,this.reset()}reset(){this.s={p:null,r:0}}pipeline(t){if(this.s.p!==t){this.s.p=t,this.gl.useProgram(t.glp),function(t,e,i=0){const{blend:o,depth:a,stencil:h}=e,p=e.raster||{};if(k(t,32926,!!p.alphaToCoverage),k(t,2884,!!p.cullMode),k(t,32823,!(!p.depthBiasSlopeScale&&!p.depthBias)),t.polygonOffset(p.depthBiasSlopeScale||0,p.depthBias||0),p.cullMode&&t.cullFace(p.cullMode),t.frontFace(p.frontFace||2305),k(t,2929,!!a),a&&(t.depthMask(!!a.write),t.depthFunc(a.compare||l)),k(t,2960,!!h),h){var c,f;t.stencilMask(null!==(c=h.writeMask)&&void 0!==c?c:u);const e=null!==(f=h.readMask)&&void 0!==f?f:u;t.stencilFuncSeparate(r,h.frontCompare||l,i,e),t.stencilFuncSeparate(s,h.backCompare||l,i,e),t.stencilOpSeparate(r,h.frontFailOp||n,h.frontZFailOp||n,h.frontPassOp||n),t.stencilOpSeparate(s,h.backFailOp||n,h.backZFailOp||n,h.backPassOp||n)}if(k(t,3042,!!o),o){const e=o.colorMask||u;t.colorMask(!!(1&e),!!(2&e),!!(4&e),!!(8&e)),t.blendFuncSeparate(o.srcFactorRGB||1,o.dstFactorRGB||0,o.srcFactorAlpha||1,o.dstFactorAlpha||0),t.blendEquationSeparate(o.opRGB||32774,o.opAlpha||32774)}}(this.gl,t.props,this.s.r);for(let t=0;t<16;++t)this.gl.disableVertexAttribArray(t);for(const{attrs:e}of t.props.buffers)for(const{shaderLoc:t}of e)this.gl.enableVertexAttribArray(t)}return this}index({glb:t}){return this.gl.bindBuffer(34963,t),this}vertex(t,{glb:e}){const{attrs:r,stride:s,instanced:i}=this.s.p.props.buffers[t];this.gl.bindBuffer(34962,e);for(const{format:t,offset:e,shaderLoc:o}of r)this.gl.vertexAttribPointer(o,d(t),b(t),m(t),s,e),this.inst&&this.inst.vertexAttribDivisorANGLE(o,i?1:0);return this}uniforms(t){let e=0;for(const r of t){const t=this.gl.getUniformLocation(this.s.p.glp,r.name);if(t)if(r.values){const e=this.s.p.props.uniforms.find((t=>t.name===r.name));if(e)switch(e.valueFormat){case 35676:this.gl.uniformMatrix4fv(t,!1,r.values);break;case 35675:this.gl.uniformMatrix3fv(t,!1,r.values);break;case 35666:this.gl.uniform4fv(t,r.values);break;case 35665:this.gl.uniform3fv(t,r.values);break;case 35664:this.gl.uniform2fv(t,r.values);break;default:this.gl.uniform1fv(t,r.values)}}else r.tex?(this.gl.activeTexture(33984+e),this.gl.bindTexture(r.tex.props.type,r.tex.glt),this.gl.uniform1i(t,e++)):isNaN(r.value)||this.gl.uniform1f(t,r.value)}return this}draw(t,e=1,r=0){const{props:{mode:s},i}=this.s.p;return i?this.inst&&this.inst.drawArraysInstancedANGLE(s,r,t,e):this.gl.drawArrays(s,r,t),this}drawIndexed(t,e=1,r=0){const{props:{indexFormat:s,mode:i},i:o}=this.s.p;return o?this.inst&&this.inst.drawElementsInstancedANGLE(i,t,s,r*y(s),e):this.gl.drawElements(i,t,s,r*y(s)),this}viewport(t,e,r,s){return this.gl.viewport(t,e,r,s),this}scissor(t,e,r,s){return this.gl.scissor(t,e,r,s),this}blendColor(t){return this.gl.blendColor(...t),this}stencilRef(t){{const i=this.s.p&&this.s.p.props.stencil;if(i){var e;const o=null!==(e=i.readMask)&&void 0!==e?e:u;this.gl.stencilFuncSeparate(r,i.frontCompare||l,t,o),this.gl.stencilFuncSeparate(s,i.backCompare||l,t,o)}this.s.r=t}return this}end(){}}return e})()},"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("ngl",[],e):"object"==typeof exports?exports.ngl=e():t.ngl=e();