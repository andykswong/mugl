{"version":3,"sources":["../../../src/js/gl2/pipestate.ts"],"names":["BYTE_MASK","ColorMask","GLenum","DEFAULT_RASTER_STATE","frontFace","CCW","cullMode","NONE","depthBias","depthBiasSlopeScale","alphaToCoverage","DEFAULT_DEPTH_STATE","write","compare","ALWAYS","DEFAULT_STENCIL_STATE","frontCompare","frontFailOp","KEEP","frontZFailOp","frontPassOp","backCompare","backFailOp","backZFailOp","backPassOp","readMask","writeMask","DEFAULT_BLEND_STATE","srcFactorRGB","ONE","dstFactorRGB","ZERO","opRGB","FUNC_ADD","srcFactorAlpha","dstFactorAlpha","opAlpha","colorMask","All","newGLPipelineState","blend","blendOn","depth","depthOn","stencil","stencilOn","raster","applyPipelineState","gl","prevState","state","stencilRef","force","b","n","n2","n3","n4","prevRaster","nextRaster","cullFace","glToggle","CULL_FACE","POLYGON_OFFSET_FILL","polygonOffset","SAMPLE_ALPHA_TO_COVERAGE","DEPTH_TEST","prevDepth","nextDepth","applyDepthMask","depthFunc","STENCIL_TEST","prevStencil","nextStencil","stencilFuncSeparate","FRONT","BACK","stencilOpSeparate","applyStencilMask","BLEND","prevBlend","nextBlend","blendFuncSeparate","blendEquationSeparate","applyColorMask","mergePipelineState","assignOrNull","Object","assign","prevMask","mask","R","G","B","A","depthMask","stencilMask","flag","enable","disable","to","from"],"mappings":"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","sourcesContent":["import { Writable } from 'ts-essentials';\r\nimport {\r\n  BYTE_MASK, ColorMask, BlendState, DepthState, GLenum, RasterizationState, StencilState, ReadonlyPipelineState\r\n} from '../../common';\r\n\r\n/**\r\n * WebGL pipeline state.\r\n */\r\nexport type GLPipelineState = Writable<ReadonlyPipelineState> & {\r\n  /** Specify if blend state is enabled. */\r\n  blendOn: boolean;\r\n\r\n  /** Specify if depth state is enabled. */\r\n  depthOn: boolean;\r\n\r\n  /** Specify if stencil state is enabled. */\r\n  stencilOn: boolean;\r\n};\r\n\r\nexport const DEFAULT_RASTER_STATE: Readonly<Required<RasterizationState>> = {\r\n  frontFace: GLenum.CCW,\r\n  cullMode: GLenum.NONE,\r\n  depthBias: 0,\r\n  depthBiasSlopeScale: 0,\r\n  alphaToCoverage: false\r\n} as const;\r\n\r\nexport const DEFAULT_DEPTH_STATE: Readonly<Required<DepthState>> = {\r\n  write: false,\r\n  compare: GLenum.ALWAYS\r\n} as const;\r\n\r\nexport const DEFAULT_STENCIL_STATE: Readonly<Required<StencilState>> = {\r\n  frontCompare: GLenum.ALWAYS,\r\n  frontFailOp: GLenum.KEEP,\r\n  frontZFailOp: GLenum.KEEP,\r\n  frontPassOp: GLenum.KEEP,\r\n  backCompare: GLenum.ALWAYS,\r\n  backFailOp: GLenum.KEEP,\r\n  backZFailOp: GLenum.KEEP,\r\n  backPassOp: GLenum.KEEP,\r\n  readMask: BYTE_MASK,\r\n  writeMask: BYTE_MASK\r\n} as const;\r\n\r\nexport const DEFAULT_BLEND_STATE: Readonly<Required<BlendState>> = {\r\n  srcFactorRGB: GLenum.ONE,\r\n  dstFactorRGB: GLenum.ZERO,\r\n  opRGB: GLenum.FUNC_ADD,\r\n  srcFactorAlpha: GLenum.ONE,\r\n  dstFactorAlpha: GLenum.ZERO,\r\n  opAlpha: GLenum.FUNC_ADD,\r\n  colorMask: ColorMask.All\r\n} as const;\r\n\r\nexport const newGLPipelineState = (): GLPipelineState => ({\r\n  blend: null,\r\n  blendOn: false,\r\n  depth: null,\r\n  depthOn: false,\r\n  stencil: null,\r\n  stencilOn: false,\r\n  raster: { ...DEFAULT_RASTER_STATE }\r\n});\r\n\r\nexport function applyPipelineState(\r\n  gl: WebGLRenderingContext, prevState: GLPipelineState, state: ReadonlyPipelineState, stencilRef = 0,\r\n  force = false\r\n): void {\r\n  const { raster, depth, stencil, blend } = state;\r\n  // Temporary variables to reuse for performance\r\n  let b = false, n = 0, n2 = 0, n3 = 0, n4 = 0;\r\n\r\n  // 1. Apply rasterizer state\r\n  const prevRaster = prevState.raster || DEFAULT_RASTER_STATE;\r\n  const nextRaster = raster || DEFAULT_RASTER_STATE;\r\n  n = nextRaster.frontFace;\r\n  if (force || (prevRaster.frontFace !== n)) {\r\n    gl.frontFace(n);\r\n  }\r\n\r\n  n = nextRaster.cullMode;\r\n  if (force || (prevRaster.cullMode !== n)) {\r\n    if ((b = (n !== GLenum.NONE))) {\r\n      gl.cullFace(n);\r\n    }\r\n    glToggle(gl, GLenum.CULL_FACE, b);\r\n  }\r\n\r\n  n = nextRaster.depthBiasSlopeScale;\r\n  n2 = nextRaster.depthBias;\r\n  if (force || (prevRaster.depthBiasSlopeScale !== n) || (prevRaster.depthBias !== n2)) {\r\n    glToggle(gl, GLenum.POLYGON_OFFSET_FILL, !(!n && !n2)); // Enable if any of the 2 values is non-zero\r\n    gl.polygonOffset(n, n2);\r\n  }\r\n\r\n  b = nextRaster.alphaToCoverage;\r\n  if (force || (prevRaster.alphaToCoverage !== b)) {\r\n    glToggle(gl, GLenum.SAMPLE_ALPHA_TO_COVERAGE, b);\r\n  }\r\n\r\n  // 2. Apply depth state changes\r\n  b = !!depth;\r\n  if (force || (prevState.depthOn !== b)) {\r\n    glToggle(gl, GLenum.DEPTH_TEST, b);\r\n  }\r\n\r\n  if (force || b) {\r\n    const prevDepth = prevState.depth || DEFAULT_DEPTH_STATE;\r\n    const nextDepth = depth || DEFAULT_DEPTH_STATE;\r\n\r\n    applyDepthMask(gl, prevDepth.write, nextDepth.write, force);\r\n\r\n    n = nextDepth.compare;\r\n    if (force || (prevDepth.compare !== n)) {\r\n      gl.depthFunc(n);\r\n    }\r\n  }\r\n\r\n  // 3. Apply stencil state changes\r\n  b = !!stencil;\r\n  if (force || (prevState.stencilOn !== b)) {\r\n    glToggle(gl, GLenum.STENCIL_TEST, b);\r\n  }\r\n\r\n  if (force || b) {\r\n    const prevStencil = prevState.stencil || DEFAULT_STENCIL_STATE;\r\n    const nextStencil = stencil || DEFAULT_STENCIL_STATE;\r\n\r\n    n = nextStencil.readMask;\r\n    b = force || (prevStencil.readMask !== n);\r\n\r\n    n2 = nextStencil.frontCompare;\r\n    if (b || (prevStencil.frontCompare !== n2)) {\r\n      gl.stencilFuncSeparate(GLenum.FRONT, n2, stencilRef, n);\r\n    }\r\n    n2 = nextStencil.backCompare;\r\n    if (b || (prevStencil.backCompare !== n2)) {\r\n      gl.stencilFuncSeparate(GLenum.BACK, n2, stencilRef, n);\r\n    }\r\n\r\n    n = nextStencil.frontFailOp;\r\n    n2 = nextStencil.frontZFailOp;\r\n    n3 = nextStencil.frontPassOp;\r\n    if (force ||\r\n      (prevStencil.frontFailOp !== n) ||\r\n      (prevStencil.frontZFailOp !== n2) ||\r\n      (prevStencil.frontPassOp !== n3)\r\n    ) {\r\n      gl.stencilOpSeparate(GLenum.FRONT, n, n2, n3);\r\n    }\r\n    n = nextStencil.backFailOp;\r\n    n2 = nextStencil.backZFailOp;\r\n    n3 = nextStencil.backPassOp;\r\n    if (force ||\r\n      (prevStencil.backFailOp !== n) ||\r\n      (prevStencil.backZFailOp !== n2) ||\r\n      (prevStencil.backPassOp !== n3)\r\n    ) {\r\n      gl.stencilOpSeparate(GLenum.BACK, n, n2, n3);\r\n    }\r\n\r\n    applyStencilMask(gl, prevStencil.writeMask, nextStencil.writeMask, force);\r\n  }\r\n\r\n  // 4. Apply blend state changes\r\n  b = !!blend;\r\n  if (force || (prevState.blendOn !== b)) {\r\n    glToggle(gl, GLenum.BLEND, b);\r\n  }\r\n\r\n  if (force || b) {\r\n    const prevBlend = prevState.blend || DEFAULT_BLEND_STATE;\r\n    const nextBlend = blend || DEFAULT_BLEND_STATE;\r\n\r\n    n = nextBlend.srcFactorRGB;\r\n    n2 = nextBlend.dstFactorRGB;\r\n    n3 = nextBlend.srcFactorAlpha;\r\n    n4 = nextBlend.dstFactorAlpha;\r\n    if (force ||\r\n      (prevBlend.srcFactorRGB !== n) ||\r\n      (prevBlend.dstFactorRGB !== n2) ||\r\n      (prevBlend.srcFactorAlpha !== n3) ||\r\n      (prevBlend.dstFactorAlpha !== n4)\r\n    ) {\r\n      gl.blendFuncSeparate(n, n2, n3, n4);\r\n    }\r\n\r\n    n = nextBlend.opRGB;\r\n    n2 = nextBlend.opAlpha;\r\n    if (force || (prevBlend.opRGB !== n) || (prevBlend.opAlpha !== n2)) {\r\n      gl.blendEquationSeparate(n, n2);\r\n    }\r\n\r\n    applyColorMask(gl, prevBlend.colorMask, nextBlend.colorMask, force);\r\n  }\r\n}\r\n\r\nexport function mergePipelineState(\r\n  prevState: GLPipelineState, state: ReadonlyPipelineState\r\n): void {\r\n  prevState.blend = assignOrNull(prevState.blend, state.blend);\r\n  prevState.blendOn = !!state.blend;\r\n  prevState.depth = assignOrNull(prevState.depth, state.depth);\r\n  prevState.depthOn = !!state.depth;\r\n  prevState.stencil = assignOrNull(prevState.stencil, state.stencil);\r\n  prevState.stencilOn = !!state.stencil;\r\n  Object.assign(prevState.raster, state.raster);\r\n}\r\n\r\nexport function applyColorMask(gl: WebGLRenderingContext, prevMask: ColorMask, mask: ColorMask, force = false): void {\r\n  if (prevMask !== mask || force) {\r\n    gl.colorMask(\r\n      !!(mask & ColorMask.R),\r\n      !!(mask & ColorMask.G),\r\n      !!(mask & ColorMask.B),\r\n      !!(mask & ColorMask.A)\r\n    );\r\n  }\r\n}\r\n\r\nexport function applyDepthMask(gl: WebGLRenderingContext, prevMask: boolean, mask: boolean, force = false): void {\r\n  if (prevMask !== mask || force) {\r\n    gl.depthMask(mask);\r\n  }\r\n}\r\n\r\nexport function applyStencilMask(gl: WebGLRenderingContext, prevMask: number, mask: number, force = false): void {\r\n  if (prevMask !== mask || force) {\r\n    gl.stencilMask(mask);\r\n  }\r\n}\r\n\r\nfunction glToggle(gl: WebGLRenderingContext, flag: GLenum, enable: boolean): void {\r\n  enable ? gl.enable(flag) : gl.disable(flag);\r\n}\r\n\r\nconst assignOrNull = <T>(to: T | null, from: T | null): T | null =>\r\n  (from || to) ? Object.assign(to || {}, from) : null;\r\n"],"file":"pipestate.js"}