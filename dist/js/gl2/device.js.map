{"version":3,"sources":["../../../src/js/gl2/device.ts"],"names":["MUGL_DEBUG","BYTE_MASK","ColorMask","GLenum","IndexFormat","indexSize","PrimitiveType","vertexNormalized","vertexSize","vertexType","UniformType","GL1Feature","GL2Feature","UniformFormat","MAX_VERTEX_ATTRIBS","GLBuffer","GLPipeline","applyColorMask","applyDepthMask","applyPipelineState","applyStencilMask","DEFAULT_BLEND_STATE","DEFAULT_DEPTH_STATE","DEFAULT_STENCIL_STATE","mergePipelineState","newGLPipelineState","GLRenderPass","GLTexture","GLShader","getGLDevice","canvas","options","gl","isWebGL2","webgl2","getContext","WebGLRenderingDevice","constructor","maxAttr","Math","min","getParameter","ext","Object","values","feature","state","reset","renderCtx","WebGLRenderPassContext","Instancing","width","drawingBufferWidth","height","drawingBufferHeight","buffer","desc","texture","sampler","shader","pipeline","pass","render","props","color","length","tex","bindFramebuffer","FRAMEBUFFER","glfb","viewport","depthRange","scissor","disable","SCISSOR_TEST","blend","pipe","depth","stencil","clearMask","clearColor","COLOR_BUFFER_BIT","colorMask","All","isNaN","clearDepth","DEPTH_BUFFER_BIT","write","clearStencil","STENCIL_BUFFER_BIT","writeMask","clear","getExtension","assign","initState","extInst","pipeObj","glp","useProgram","prevPipeState","stencilRef","bufs","Array","buffers","newAttrs","fill","oldAttrs","attrs","slot","stride","instanced","bufAttrs","glb","format","offset","shaderLoc","push","buf","ptr","step","i","enableVertexAttribArray","disableVertexAttribArray","idxFmt","indexFormat","mode","index","idx","bindBuffer","ELEMENT_ARRAY_BUFFER","vertex","ARRAY_BUFFER","vertexAttribPointer","vertexAttribDivisor","vertexAttribDivisorANGLE","uniforms","bindings","binding","uniformInfo","cache","name","console","warn","type","Value","valueFormat","Mat4","uniformMatrix4fv","loc","Mat3","uniformMatrix3fv","Mat2","uniformMatrix2fv","Vec4","uniform4fv","Vec3","uniform3fv","Vec2","uniform2fv","Float","uniform1fv","value","uniform1f","Tex","activeTexture","TEXTURE0","bindTexture","glt","uniform1i","Buffer","UNIFORM_BUFFER","bufferOffset","bindBufferRange","bufferSize","size","draw","vertexCount","instanceCount","firstVertex","drawArraysInstanced","drawArraysInstancedANGLE","drawArrays","drawIndexed","indexCount","firstIndex","drawElementsInstanced","drawElementsInstancedANGLE","drawElements","x","y","minDepth","maxDepth","enable","blendColor","ref","frontCompare","backCompare","readMask","stencilFuncSeparate","FRONT","BACK","end","resolve","UInt16","Tri"],"mappings":"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","sourcesContent":["import { MUGL_DEBUG } from '../../common/config';\r\nimport {\r\n  BYTE_MASK, BufferDescriptor, ColorMask, GLenum, IndexFormat, indexSize, PipelineDescriptor, PrimitiveType,\r\n  RenderPassContext, RenderPassDescriptor, SamplerDescriptor, ShaderDescriptor, TextureDescriptor, UniformBindings,\r\n  vertexNormalized, vertexSize, vertexType, UniformType, FloatList\r\n} from '../../common';\r\nimport {\r\n  Canvas, GL1Feature, GL2Feature, GLRenderingDevice, GLRenderingDeviceFactory, GLRenderingDeviceOptions, ReadonlyColor, UniformFormat\r\n} from '../device';\r\nimport { MAX_VERTEX_ATTRIBS } from './const';\r\nimport { GLBuffer } from './buffer';\r\nimport { GLPipeline } from './pipeline';\r\nimport {\r\n  applyColorMask, applyDepthMask, applyPipelineState, applyStencilMask, DEFAULT_BLEND_STATE, DEFAULT_DEPTH_STATE,\r\n  DEFAULT_STENCIL_STATE, GLPipelineState, mergePipelineState, newGLPipelineState\r\n} from './pipestate';\r\nimport { GLRenderPass } from './renderpass';\r\nimport { GLTexture } from './texture';\r\nimport { GLShader } from './shader';\r\n\r\n/**\r\n * Create a {@link GLRenderingDevice}.\r\n * @param canvas the canvas to be used\r\n * @param options context initialization options\r\n * @returns rendering device instance, or null if WebGL is not supported\r\n */\r\nexport const getGLDevice: GLRenderingDeviceFactory =\r\n  (canvas: Canvas, options: GLRenderingDeviceOptions = {}): GLRenderingDevice | null => {\r\n    let gl: WebGLRenderingContext | null = null;\r\n    let isWebGL2 = false;\r\n    if (options.webgl2) {\r\n      isWebGL2 = !!(gl = canvas.getContext('webgl2', options));\r\n    }\r\n    if (!gl) {\r\n      gl = canvas.getContext('webgl', options) ||\r\n        // @ts-ignore: try experimental-webgl for older browsers\r\n        canvas.getContext('experimental-webgl', options);\r\n    }\r\n    if (!gl) {\r\n      return null;\r\n    }\r\n    return new WebGLRenderingDevice(gl, isWebGL2);\r\n  }\r\n\r\n/**\r\n * The WebGL rendering context, in WebGPU API style.\r\n */\r\nclass WebGLRenderingDevice implements GLRenderingDevice {\r\n  public readonly canvas: Canvas;\r\n\r\n  private readonly renderCtx: WebGLRenderPassContext;\r\n  private readonly state: WebGLState;\r\n  private readonly maxAttr: number;\r\n\r\n  constructor(public readonly gl: WebGLRenderingContext, public readonly webgl2: boolean) {\r\n    this.canvas = gl.canvas;\r\n    this.maxAttr = Math.min(gl.getParameter(GLenum.MAX_VERTEX_ATTRIBS), MAX_VERTEX_ATTRIBS);\r\n\r\n    // Try to enable all used extensions by default\r\n    for (const ext of Object.values(webgl2 ? GL2Feature : GL1Feature)) {\r\n      this.feature(ext);\r\n    }\r\n\r\n    this.state = this.reset();\r\n    this.renderCtx = new WebGLRenderPassContext(\r\n      gl, webgl2, this.state, this.maxAttr, this.feature(GL1Feature.Instancing)\r\n    );\r\n  }\r\n\r\n  public get width(): number {\r\n    return this.gl.drawingBufferWidth;\r\n  }\r\n\r\n  public get height(): number {\r\n    return this.gl.drawingBufferHeight;\r\n  }\r\n\r\n  public buffer(desc: BufferDescriptor): GLBuffer {\r\n    return new GLBuffer(this, desc);\r\n  }\r\n\r\n  public texture(desc: TextureDescriptor, sampler?: SamplerDescriptor): GLTexture {\r\n    return new GLTexture(this, desc, sampler);\r\n  }\r\n\r\n  public shader(desc: ShaderDescriptor): GLShader {\r\n    return new GLShader(this, desc);\r\n  }\r\n\r\n  public pipeline(desc: PipelineDescriptor): GLPipeline {\r\n    return new GLPipeline(this, desc);\r\n  }\r\n\r\n  public pass(desc?: RenderPassDescriptor): GLRenderPass {\r\n    return new GLRenderPass(this, desc);\r\n  }\r\n\r\n  public render(pass: GLRenderPass): RenderPassContext {\r\n    let width = this.width;\r\n    let height = this.height;\r\n    if (pass.props.color.length) { // Offscreen pass\r\n      width = pass.props.color[0].tex.props.width;\r\n      height = pass.props.color[0].tex.props.height;\r\n    }\r\n\r\n    // Bind the pass framebuffer\r\n    this.gl.bindFramebuffer(GLenum.FRAMEBUFFER, pass.glfb);\r\n\r\n    // Reset viewport and scissor\r\n    this.gl.viewport(0, 0, width, height);\r\n    this.gl.depthRange(0, 1);\r\n\r\n    if (this.state.scissor) {\r\n      this.state.scissor = false;\r\n      this.gl.disable(GLenum.SCISSOR_TEST);\r\n    }\r\n\r\n    // Clear buffers, temporarily override color/depth/stencil masks as necessary\r\n    const blend = this.state.pipe.blend || DEFAULT_BLEND_STATE;\r\n    const depth = this.state.pipe.depth || DEFAULT_DEPTH_STATE\r\n    const stencil = this.state.pipe.stencil || DEFAULT_STENCIL_STATE;\r\n    let clearMask = 0;\r\n    if (pass.props.clearColor) {\r\n      clearMask |= GLenum.COLOR_BUFFER_BIT;\r\n      this.gl.clearColor(...pass.props.clearColor);\r\n      applyColorMask(this.gl, blend.colorMask, ColorMask.All);\r\n    }\r\n    if (!isNaN(pass.props.clearDepth)) {\r\n      clearMask |= GLenum.DEPTH_BUFFER_BIT;\r\n      this.gl.clearDepth(pass.props.clearDepth);\r\n      applyDepthMask(this.gl, depth.write, true);\r\n    }\r\n    if (!isNaN(pass.props.clearStencil)) {\r\n      clearMask |= GLenum.STENCIL_BUFFER_BIT;\r\n      this.gl.clearStencil(pass.props.clearStencil);\r\n      applyStencilMask(this.gl, stencil.writeMask, BYTE_MASK);\r\n    }\r\n    if (clearMask) {\r\n      this.gl.clear(clearMask);\r\n\r\n      // Restore masks\r\n      if (clearMask & GLenum.COLOR_BUFFER_BIT) {\r\n        applyColorMask(this.gl, ColorMask.All, blend.colorMask);\r\n      }\r\n      if (clearMask & GLenum.DEPTH_BUFFER_BIT) {\r\n        applyDepthMask(this.gl, true, depth.write);\r\n      }\r\n      if (clearMask & GLenum.STENCIL_BUFFER_BIT) {\r\n        applyStencilMask(this.gl, BYTE_MASK, stencil.writeMask);\r\n      }\r\n    }\r\n\r\n    this.renderCtx.pass = pass;\r\n    return this.renderCtx;\r\n  }\r\n\r\n  public feature<F>(feature: string): F {\r\n    return this.gl.getExtension(feature);\r\n  }\r\n\r\n  public reset(): WebGLState {\r\n    return Object.assign(this.state || {}, initState(this.gl, this.maxAttr));\r\n  }\r\n}\r\n\r\nclass WebGLRenderPassContext implements RenderPassContext {\r\n  public pass: GLRenderPass | null = null;\r\n\r\n  constructor(\r\n    private readonly gl: WebGLRenderingContext,\r\n    private readonly webgl2: boolean,\r\n    private readonly state: WebGLState,\r\n    private readonly maxAttr: number,\r\n    private readonly extInst?: ANGLE_instanced_arrays\r\n  ) { }\r\n\r\n  public pipeline(pipeline: GLPipeline): RenderPassContext {\r\n    // Optimization: pipeline unchanged, skip other updates\r\n    if (this.state.pipeObj === pipeline) {\r\n      return this;\r\n    }\r\n\r\n    // Update shader program\r\n    if (!this.state.pipeObj || this.state.pipeObj.glp !== pipeline.glp) {\r\n      this.gl.useProgram(pipeline.glp);\r\n    }\r\n    this.state.pipeObj = pipeline;\r\n\r\n    // Update pipeline state cache\r\n    const prevPipeState = this.state.pipe;\r\n    applyPipelineState(this.gl, prevPipeState, pipeline.props, this.state.stencilRef);\r\n    mergePipelineState(prevPipeState, pipeline.props);\r\n\r\n    // Update buffer and vertex attribute cache\r\n    const bufs = this.state.bufs = Array(pipeline.props.buffers.length);\r\n    const newAttrs: (GLAttr | null)[] = Array(this.maxAttr).fill(null);\r\n    const oldAttrs = this.state.attrs;\r\n    this.state.attrs = newAttrs;\r\n    for (let slot = 0; slot < pipeline.props.buffers.length; ++slot) {\r\n      const { attrs, stride, instanced } = pipeline.props.buffers[slot];\r\n      const bufAttrs: GLAttr[] = [];\r\n      bufs[slot] = { glb: null, attrs: bufAttrs };\r\n      for (const { format, offset, shaderLoc } of attrs) {\r\n        bufAttrs.push(newAttrs[shaderLoc] = {\r\n          buf: slot,\r\n          ptr: [\r\n            shaderLoc,\r\n            vertexSize(format),\r\n            vertexType(format),\r\n            vertexNormalized(format),\r\n            stride,\r\n            offset\r\n          ],\r\n          step: instanced ? 1 : 0\r\n        });\r\n      }\r\n    }\r\n\r\n    // Enable / disable vertex attributes\r\n    for (let i = 0; i < this.maxAttr; ++i) {\r\n      if (newAttrs[i] && !oldAttrs[i]) {\r\n        this.gl.enableVertexAttribArray(i);\r\n      } else if (!newAttrs[i] && oldAttrs[i]) {\r\n        this.gl.disableVertexAttribArray(i);\r\n      }\r\n    }\r\n\r\n    // Update index format\r\n    this.state.idxFmt = pipeline.props.indexFormat;\r\n\r\n    // Cache primitive rendering mode\r\n    this.state.mode = pipeline.props.mode;\r\n\r\n    return this;\r\n  }\r\n\r\n  public index({ glb }: GLBuffer): RenderPassContext {\r\n    if (glb !== this.state.idx) {\r\n      this.gl.bindBuffer(GLenum.ELEMENT_ARRAY_BUFFER, (this.state.idx = glb));\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  public vertex(slot: number, { glb }: GLBuffer): RenderPassContext {\r\n    const buf = this.state.bufs[slot];\r\n    if (buf && buf.glb !== glb) {\r\n      this.gl.bindBuffer(GLenum.ARRAY_BUFFER, (buf.glb = glb));\r\n      for (let i = 0; i < buf.attrs.length; ++i) {\r\n        const { ptr, step } = buf.attrs[i];\r\n        this.gl.vertexAttribPointer(...ptr);\r\n        if (this.webgl2) {\r\n          (this.gl as WebGL2RenderingContext).vertexAttribDivisor(ptr[0], step);\r\n        } else {\r\n          this.extInst?.vertexAttribDivisorANGLE(ptr[0], step);\r\n        }\r\n      }\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  public uniforms(bindings: UniformBindings): RenderPassContext {\r\n    if (!this.state.pipeObj) {\r\n      return this; // Skipping updates. No effect if pipeline not bound\r\n    }\r\n\r\n    for (let i = 0; i < bindings.length; ++i) {\r\n      const binding = bindings[i];\r\n      const uniformInfo = this.state.pipeObj.cache[binding.name];\r\n      if (!uniformInfo) { // No such uniform\r\n        if (MUGL_DEBUG) {\r\n          console.warn(`Unknown uniform: ${binding.name}`);\r\n        }\r\n        continue;\r\n      }\r\n\r\n      if (uniformInfo.type === UniformType.Value) {\r\n        if (binding.values) { // Array types\r\n          switch (uniformInfo.valueFormat) {\r\n            case UniformFormat.Mat4: this.gl.uniformMatrix4fv(uniformInfo.loc, false, binding.values as FloatList); break;\r\n            case UniformFormat.Mat3: this.gl.uniformMatrix3fv(uniformInfo.loc, false, binding.values as FloatList); break;\r\n            case UniformFormat.Mat2: this.gl.uniformMatrix2fv(uniformInfo.loc, false, binding.values as FloatList); break;\r\n            case UniformFormat.Vec4: this.gl.uniform4fv(uniformInfo.loc, binding.values as FloatList); break;\r\n            case UniformFormat.Vec3: this.gl.uniform3fv(uniformInfo.loc, binding.values as FloatList); break;\r\n            case UniformFormat.Vec2: this.gl.uniform2fv(uniformInfo.loc, binding.values as FloatList); break;\r\n            case UniformFormat.Float: this.gl.uniform1fv(uniformInfo.loc, binding.values as FloatList); break;\r\n            default:\r\n              if (MUGL_DEBUG) {\r\n                console.warn(`Cannot bind a number array to uniform: ${binding.name}`);\r\n              }\r\n          }\r\n        } else if (binding.value || binding.value === 0) { // Single number\r\n          if (uniformInfo.valueFormat === UniformFormat.Float) {\r\n            this.gl.uniform1f(uniformInfo.loc, binding.value);\r\n          } else if (MUGL_DEBUG) {\r\n            console.warn(`Cannot bind a number to uniform: ${binding.name}`);\r\n          }\r\n        } else if (MUGL_DEBUG) {\r\n          console.warn(`Invalid value bound to value uniform: ${binding.name}`);\r\n        }\r\n      } else if (uniformInfo.type === UniformType.Tex) {\r\n        if (binding.tex) {\r\n          this.gl.activeTexture(GLenum.TEXTURE0 + uniformInfo.binding);\r\n          this.gl.bindTexture(binding.tex.props.type, (binding.tex as GLTexture).glt);\r\n          this.gl.uniform1i(uniformInfo.loc, uniformInfo.binding);\r\n        } else if (MUGL_DEBUG) {\r\n          console.warn(`Invalid value bound to texture uniform: ${binding.name}`);\r\n        }\r\n      } else if (uniformInfo.type === UniformType.Buffer) { // Uniform buffer\r\n        if (binding.buffer?.props.type === GLenum.UNIFORM_BUFFER) {\r\n          const offset = binding.bufferOffset || 0;\r\n          (this.gl as WebGL2RenderingContext)\r\n            .bindBufferRange(\r\n              GLenum.UNIFORM_BUFFER,\r\n              uniformInfo.index,\r\n              (binding.buffer as GLBuffer).glb,\r\n              offset,\r\n              binding.bufferSize || ((binding.buffer as GLBuffer).props.size - offset)\r\n            );\r\n        } else if (MUGL_DEBUG) {\r\n          console.warn(`Invalid value bound to uniform buffer: ${binding.name}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  public draw(vertexCount: number, instanceCount = 1, firstVertex = 0): RenderPassContext {\r\n    if (!this.state.pipeObj) {\r\n      return this; // Skipping draw call. No effect if pipeline not bound\r\n    }\r\n\r\n    if (this.state.pipeObj.instanced && (this.webgl2 || this.extInst)) {\r\n      if (this.webgl2) {\r\n        (this.gl as WebGL2RenderingContext)\r\n          .drawArraysInstanced(this.state.mode, firstVertex, vertexCount, instanceCount);\r\n      } else {\r\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n        this.extInst!.drawArraysInstancedANGLE(this.state.mode, firstVertex, vertexCount, instanceCount);\r\n      }\r\n    } else {\r\n      this.gl.drawArrays(this.state.mode, firstVertex, vertexCount);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  public drawIndexed(indexCount: number, instanceCount = 1, firstIndex = 0): RenderPassContext {\r\n    if (!this.state.pipeObj) {\r\n      return this; // Skipping draw call. No effect if pipeline not bound\r\n    }\r\n\r\n    const { mode, idxFmt } = this.state;\r\n    const offset = firstIndex * indexSize(idxFmt);\r\n    if (this.state.pipeObj.instanced && (this.webgl2 || this.extInst)) {\r\n      if (this.webgl2) {\r\n        (this.gl as WebGL2RenderingContext)\r\n          .drawElementsInstanced(mode, indexCount, idxFmt, offset, instanceCount);\r\n      } else {\r\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\r\n        this.extInst!.drawElementsInstancedANGLE(mode, indexCount, idxFmt, offset, instanceCount);\r\n      }\r\n    } else {\r\n      this.gl.drawElements(mode, indexCount, idxFmt, offset);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  public viewport(x: number, y: number, width: number, height: number, minDepth = 0, maxDepth = 1): RenderPassContext {\r\n    this.gl.viewport(x, y, width, height);\r\n    this.gl.depthRange(minDepth, maxDepth);\r\n    return this;\r\n  }\r\n\r\n  public scissor(x: number, y: number, width: number, height: number): RenderPassContext {\r\n    if (!this.state.scissor) {\r\n      this.gl.enable(GLenum.SCISSOR_TEST);\r\n      this.state.scissor = true;\r\n    }\r\n    this.gl.scissor(x, y, width, height);\r\n    return this;\r\n  }\r\n\r\n  public blendColor(color: ReadonlyColor): RenderPassContext {\r\n    this.gl.blendColor(...color);\r\n    return this;\r\n  }\r\n\r\n  public stencilRef(ref: number): RenderPassContext {\r\n    if (this.state.stencilRef !== ref) {\r\n      const { frontCompare, backCompare, readMask } = this.state.pipe.stencil || DEFAULT_STENCIL_STATE;\r\n      this.gl.stencilFuncSeparate(GLenum.FRONT, frontCompare, ref, readMask);\r\n      this.gl.stencilFuncSeparate(GLenum.BACK, backCompare, ref, readMask);\r\n      this.state.stencilRef = ref;\r\n    }\r\n    return this;\r\n  }\r\n\r\n  public end(): void {\r\n    this.pass?.resolve();\r\n    this.pass = null;\r\n  }\r\n}\r\n\r\ninterface WebGLState {\r\n  pipeObj: GLPipeline | null;\r\n  bufs: GLBuf[];\r\n  attrs: (GLAttr | null)[];\r\n  idx: WebGLBuffer | null;\r\n  idxFmt: IndexFormat;\r\n  mode: PrimitiveType;\r\n  pipe: GLPipelineState;\r\n  blend: ReadonlyColor;\r\n  stencilRef: number;\r\n  scissor: boolean;\r\n}\r\n\r\ntype GLAttr = {\r\n  buf: number,\r\n  ptr: [\r\n    loc: number,\r\n    size: number,\r\n    type: number,\r\n    normalized: boolean,\r\n    stride: number,\r\n    offset: number\r\n  ],\r\n  step: number\r\n};\r\n\r\ntype GLBuf = {\r\n  glb: WebGLBuffer | null,\r\n  attrs: GLAttr[]\r\n};\r\n\r\nfunction initState(gl: WebGLRenderingContext, maxAttr: number): WebGLState {\r\n  const pipe = newGLPipelineState();\r\n  const blend: ReadonlyColor = [1, 1, 1, 1];\r\n  const stencilRef = 0;\r\n\r\n  // Apply the default states\r\n  gl.useProgram(null);\r\n  gl.blendColor(...blend);\r\n  applyPipelineState(gl, pipe, pipe, stencilRef, true);\r\n  for (let i = 0; i < maxAttr; ++i) {\r\n    gl.disableVertexAttribArray(i);\r\n  }\r\n\r\n  return {\r\n    pipeObj: null,\r\n    bufs: [],\r\n    attrs: [],\r\n    idx: null,\r\n    idxFmt: IndexFormat.UInt16,\r\n    mode: PrimitiveType.Tri,\r\n    pipe,\r\n    blend,\r\n    stencilRef,\r\n    scissor: false\r\n  }\r\n}\r\n"],"file":"device.js"}