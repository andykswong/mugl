{"version":3,"sources":["../../../src/js/nano/resources.ts"],"names":["MUGL_DEBUG","BYTE_MASK","vertexByteSize","GLenum","COLOR_PIXEL_FORMAT","DEPTH_PIXEL_FORMAT","NGL_ENABLE_OFFSCREEN","NGL_ENABLE_STENCIL","NGL_ENABLE_RASTER","NGL_ENABLE_BLEND","NGL_ENABLE_MRT","GLBuffer","constructor","gl","props","type","ARRAY_BUFFER","usage","STATIC_DRAW","bindBuffer","glb","createBuffer","bufferData","size","data","offset","bufferSubData","destroy","deleteBuffer","GLTexture","sampler","glt","glrb","p","TEXTURE_2D","format","width","height","s","wrapU","CLAMP_TO_EDGE","wrapV","magFilter","NEAREST","minFilter","bindRenderbuffer","RENDERBUFFER","createRenderbuffer","renderbufferStorage","DEPTH_STENCIL","DEPTH_COMPONENT16","bindTexture","createTexture","texParameteri","TEXTURE_MIN_FILTER","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","TEXTURE_WRAP_T","texImage2D","RGBA","UNSIGNED_BYTE","x","y","buffer","texSubImage2D","image","mipmap","generateMipmap","deleteTexture","deleteRenderbuffer","GLRenderPass","drawBuffersExt","glfb","color","length","bindFramebuffer","FRAMEBUFFER","createFramebuffer","count","i","framebufferTexture2D","COLOR_ATTACHMENT0","tex","drawBuffersWEBGL","map","_","depth","framebufferRenderbuffer","DEPTH_STENCIL_ATTACHMENT","DEPTH_ATTACHMENT","console","assert","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","isContextLost","deleteFramebuffer","resolve","GLShader","shader","gls","createShader","shaderSource","source","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","deleteShader","GLPipeline","curShaderLoc","mode","TRIANGLES","indexFormat","UNSIGNED_SHORT","buffers","attrs","descAttrs","stride","instanced","Array","maxOffset","j","name","shaderLoc","Math","max","glp","createProgram","vert","frag","deleteProgram","applyPipelineState","state","stencilRef","blend","stencil","raster","glToggle","SAMPLE_ALPHA_TO_COVERAGE","alphaToCoverage","CULL_FACE","cullMode","POLYGON_OFFSET_FILL","depthBiasSlopeScale","depthBias","polygonOffset","cullFace","frontFace","CCW","DEPTH_TEST","depthMask","write","depthFunc","compare","ALWAYS","STENCIL_TEST","stencilMask","writeMask","mask","readMask","stencilFuncSeparate","FRONT","frontCompare","BACK","backCompare","stencilOpSeparate","frontFailOp","KEEP","frontZFailOp","frontPassOp","backFailOp","backZFailOp","backPassOp","BLEND","colorMask","blendFuncSeparate","srcFactorRGB","ONE","dstFactorRGB","ZERO","srcFactorAlpha","dstFactorAlpha","blendEquationSeparate","opRGB","FUNC_ADD","opAlpha","flag","enable","disable","vs","fs","program","attachShader","attr","bindAttribLocation","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-non-null-assertion */\r\n\r\nimport { MUGL_DEBUG } from '../../common/config';\r\nimport {\r\n  BufferDescriptor, BufferProperties, BYTE_MASK, GLBuffer as IGLBuffer, GLPipeline as IGLPipeline, GLRenderPass as IGLRenderPass, GLShader as IGLShader,\r\n  GLTexture as IGLTexture, PipelineDescriptor, PipelineState, ReadonlyExtent3D, ReadonlyOrigin3D, RenderPassDescriptor, SamplerDescriptor,\r\n  SamplerProperties, ShaderDescriptor, ShaderType, TextureData, TextureDescriptor, TextureProperties, VertexAttribute, vertexByteSize\r\n} from '../device';\r\nimport { GLenum } from '../../common/gl';\r\nimport { COLOR_PIXEL_FORMAT, DEPTH_PIXEL_FORMAT } from './const';\r\nimport {\r\n  NGL_ENABLE_OFFSCREEN, NGL_ENABLE_STENCIL, NGL_ENABLE_RASTER, NGL_ENABLE_BLEND, NGL_ENABLE_MRT\r\n} from './config';\r\nimport { PipelineProperties, ReadonlyVertexBufferLayout } from '../../common/device/descriptor';\r\nimport { RenderPassProperties } from '../../common/device/descriptor';\r\n\r\nexport class GLBuffer implements IGLBuffer {\r\n  public readonly props: BufferProperties;\r\n\r\n  public glb: WebGLBuffer | null;\r\n\r\n  public constructor(private readonly gl: WebGLRenderingContext, props: BufferDescriptor) {\r\n    this.props = {\r\n      type: GLenum.ARRAY_BUFFER,\r\n      usage: GLenum.STATIC_DRAW,\r\n      ...props\r\n    };\r\n    gl.bindBuffer(this.props.type, this.glb = gl.createBuffer());\r\n    gl.bufferData(this.props.type, this.props.size, this.props.usage);\r\n  }\r\n\r\n  public data(data: ArrayBufferView, offset = 0): GLBuffer {\r\n    this.gl.bindBuffer(this.props.type, this.glb);\r\n    this.gl.bufferSubData(this.props.type, offset, data);\r\n    return this;\r\n  }\r\n\r\n  public destroy(): void {\r\n    this.gl.deleteBuffer(this.glb);\r\n  }\r\n}\r\n\r\nexport class GLTexture implements IGLTexture {\r\n  public readonly props: TextureProperties;\r\n  public readonly sampler: SamplerProperties;\r\n\r\n  public glt: WebGLTexture | null = null;\r\n  public glrb: WebGLRenderbuffer | null = null;\r\n\r\n  public constructor(\r\n    private readonly gl: WebGLRenderingContext,\r\n    props: TextureDescriptor,\r\n    sampler?: SamplerDescriptor\r\n  ) {\r\n    const p = this.props = {\r\n      type: GLenum.TEXTURE_2D,\r\n      format: COLOR_PIXEL_FORMAT,\r\n      width: 1,\r\n      height: 1,\r\n      ...props\r\n    } as TextureProperties;\r\n    const s = this.sampler = {\r\n      wrapU: GLenum.CLAMP_TO_EDGE,\r\n      wrapV: GLenum.CLAMP_TO_EDGE,\r\n      magFilter: GLenum.NEAREST,\r\n      minFilter: GLenum.NEAREST,\r\n      ...sampler\r\n    } as SamplerProperties;\r\n\r\n    // CAVEAT: Only supports RGBA8 vs DEPTH_STENCIL. No depth texture support\r\n    if (p.format <= DEPTH_PIXEL_FORMAT) { // depth/stencil renderbuffer\r\n      if (NGL_ENABLE_OFFSCREEN) {\r\n        gl.bindRenderbuffer(GLenum.RENDERBUFFER, this.glrb = gl.createRenderbuffer());\r\n        gl.renderbufferStorage(GLenum.RENDERBUFFER, NGL_ENABLE_STENCIL ? GLenum.DEPTH_STENCIL : GLenum.DEPTH_COMPONENT16,\r\n          p.width, p.height);\r\n      }\r\n    } else { // RGBA8 texture\r\n      gl.bindTexture(p.type, this.glt = gl.createTexture());\r\n      gl.texParameteri(p.type, GLenum.TEXTURE_MIN_FILTER, s.minFilter);\r\n      gl.texParameteri(p.type, GLenum.TEXTURE_MAG_FILTER, s.magFilter);\r\n      gl.texParameteri(p.type, GLenum.TEXTURE_WRAP_S, s.wrapU);\r\n      gl.texParameteri(p.type, GLenum.TEXTURE_WRAP_T, s.wrapV);\r\n      gl.texImage2D(p.type, 0, GLenum.RGBA, p.width, p.height, 0, GLenum.RGBA, GLenum.UNSIGNED_BYTE, null);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Write data to the texture.\r\n   * CAVEAT: Only writing to 2D RGBA8 texture is supported. No support for mipLevel\r\n   */\r\n  data(\r\n    data: TextureData,\r\n    [x, y]: ReadonlyOrigin3D = [0, 0, 0],\r\n    [width, height]: ReadonlyExtent3D = [this.props.width - x,  this.props.height - y, 0]\r\n  ): GLTexture {\r\n    this.gl.bindTexture(this.props.type, this.glt);\r\n    if (data.buffer) {\r\n      this.gl.texSubImage2D(this.props.type, 0, x, y, width, height, GLenum.RGBA, GLenum.UNSIGNED_BYTE, data.buffer);\r\n    } else if (data.image) {\r\n      this.gl.texSubImage2D(this.props.type, 0, x, y, GLenum.RGBA, GLenum.UNSIGNED_BYTE, data.image);\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Generate mipmap for a texture object. CAVEAT: no support for mipmap hint.\r\n   */\r\n  mipmap(): GLTexture {\r\n    this.gl.bindTexture(this.props.type!, this.glt);\r\n    this.gl.generateMipmap(this.props.type!);\r\n    return this;\r\n  }\r\n\r\n  destroy(): void {\r\n    this.gl.deleteTexture(this.glt);\r\n    this.gl.deleteRenderbuffer(this.glrb);\r\n  }\r\n}\r\n\r\nexport class GLRenderPass implements IGLRenderPass {\r\n  public readonly props: RenderPassProperties;\r\n\r\n  public glfb: WebGLFramebuffer | null = null;\r\n\r\n  // CAVEAT: MSAA resolve unsupported\r\n  public glrfb!: readonly WebGLFramebuffer[];\r\n\r\n  public constructor(\r\n    private readonly gl: WebGLRenderingContext,\r\n    props: RenderPassDescriptor,\r\n    drawBuffersExt?: WEBGL_draw_buffers\r\n  ) {\r\n    this.props = props as RenderPassProperties;\r\n    if (props.color && props.color.length) {\r\n      // An offscreen pass, need to create a framebuffer with color and depth attachments\r\n      gl.bindFramebuffer(GLenum.FRAMEBUFFER, this.glfb = gl.createFramebuffer());\r\n\r\n      const count = (NGL_ENABLE_MRT && drawBuffersExt) ? props.color.length : 1;\r\n      for (let i = 0; i < count; ++i) {\r\n        gl.framebufferTexture2D(\r\n          GLenum.FRAMEBUFFER, GLenum.COLOR_ATTACHMENT0 + i, props.color[i].tex.props.type,\r\n          (props.color[i].tex as GLTexture).glt, 0\r\n        );\r\n      }\r\n\r\n      if (NGL_ENABLE_MRT && count > 1) {\r\n        drawBuffersExt!.drawBuffersWEBGL(props.color.map((_, i) => GLenum.COLOR_ATTACHMENT0 + i));\r\n      }\r\n\r\n      // Attach optional depth-stencil buffer to framebuffer\r\n      // CAVEAT: Depth texture is not supported\r\n      if (props.depth) {\r\n        gl.framebufferRenderbuffer(GLenum.FRAMEBUFFER, NGL_ENABLE_STENCIL ? GLenum.DEPTH_STENCIL_ATTACHMENT : GLenum.DEPTH_ATTACHMENT,\r\n          GLenum.RENDERBUFFER, (props.depth.tex as GLTexture).glrb);\r\n      }\r\n\r\n      if (MUGL_DEBUG) {\r\n        console.assert(\r\n          gl.checkFramebufferStatus(GLenum.FRAMEBUFFER) === GLenum.FRAMEBUFFER_COMPLETE || gl.isContextLost(),\r\n          'Framebuffer completeness check failed'\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public destroy(): void {\r\n    this.gl.deleteFramebuffer(this.glfb);\r\n  }\r\n\r\n  public resolve(): void {\r\n    // CAVEAT: MSAA resolve not supported for WebGL1\r\n  }\r\n}\r\n\r\nexport class GLShader implements IGLShader {\r\n  public readonly type: ShaderType;\r\n  public readonly source: string;\r\n\r\n  public gls: WebGLShader;\r\n\r\n  public constructor(\r\n    private readonly gl: WebGLRenderingContext,\r\n    props: ShaderDescriptor\r\n  ) {\r\n    const shader = this.gls = gl.createShader(this.type = props.type)!;\r\n    gl.shaderSource(shader, this.source = props.source);\r\n    gl.compileShader(shader);\r\n\r\n    if (MUGL_DEBUG) {\r\n      console.assert(\r\n        gl.getShaderParameter(shader, GLenum.COMPILE_STATUS) || gl.isContextLost(),\r\n        `Failed to compile shader: ${gl.getShaderInfoLog(shader)}`\r\n      );\r\n    }\r\n  }\r\n\r\n  destroy(): void {\r\n    this.gl.deleteShader(this.gls);\r\n  }\r\n}\r\n\r\nexport class GLPipeline implements IGLPipeline {\r\n  public readonly props: PipelineProperties;\r\n\r\n  public glp: WebGLProgram | null;\r\n\r\n  /** Indicates if pipeline has instanced attribute. */\r\n  public i!: boolean;\r\n\r\n  public constructor(private readonly gl: WebGLRenderingContext, props: PipelineDescriptor) {\r\n    // CAVEAT: Auto calculated buffer offsets, stride and shaderLoc may not be what you expected.\r\n    // TODO: Consider moving auto calculation to a shared util method\r\n    let curShaderLoc = 0;\r\n    this.props = {\r\n      mode: GLenum.TRIANGLES,\r\n      indexFormat: GLenum.UNSIGNED_SHORT,\r\n      ...props,\r\n      buffers: props.buffers.map(({ attrs: descAttrs, stride, instanced = false }) => {\r\n        this.i = this.i || instanced;\r\n        const attrs: Required<VertexAttribute>[] = Array(descAttrs.length);\r\n        let maxOffset = 0;\r\n        for (let j = 0; j < descAttrs.length; ++j, ++curShaderLoc) {\r\n          const { name, format, offset = maxOffset, shaderLoc = curShaderLoc } = descAttrs[j];\r\n          attrs[j] = { name, format, offset, shaderLoc };\r\n          maxOffset = Math.max(maxOffset, offset) + vertexByteSize(format);\r\n        }\r\n        return { attrs, stride: stride || maxOffset, instanced };\r\n      })\r\n    } as PipelineProperties;\r\n\r\n    this.glp = createProgram(gl, props.vert as IGLShader, props.frag as IGLShader, this.props.buffers);\r\n  }\r\n\r\n  destroy(): void {\r\n    this.gl.deleteProgram(this.glp);\r\n  }\r\n}\r\n\r\nexport function applyPipelineState(\r\n  gl: WebGLRenderingContext, state: PipelineState, stencilRef = 0\r\n): void {\r\n  const { blend, depth, stencil } = state;\r\n  const raster = state.raster || {};\r\n\r\n  // 1. Apply rasterizer state\r\n  if (NGL_ENABLE_RASTER) {\r\n    glToggle(gl, GLenum.SAMPLE_ALPHA_TO_COVERAGE, !!raster.alphaToCoverage);\r\n    glToggle(gl, GLenum.CULL_FACE, !!raster.cullMode);\r\n    glToggle(gl, GLenum.POLYGON_OFFSET_FILL, !!(raster.depthBiasSlopeScale || raster.depthBias));\r\n\r\n    gl.polygonOffset(raster.depthBiasSlopeScale || 0, raster.depthBias || 0);\r\n\r\n    if (raster.cullMode) {\r\n      gl.cullFace(raster.cullMode);\r\n    }\r\n    gl.frontFace(raster.frontFace || GLenum.CCW);\r\n  }\r\n\r\n  // 2. Apply depth state changes\r\n  glToggle(gl, GLenum.DEPTH_TEST, !!depth);\r\n\r\n  if (depth) {\r\n    gl.depthMask(!!depth.write);\r\n    gl.depthFunc(depth.compare || GLenum.ALWAYS);\r\n  }\r\n\r\n  // 3. Apply stencil state changes\r\n  if (NGL_ENABLE_STENCIL) {\r\n    glToggle(gl, GLenum.STENCIL_TEST, !!stencil);\r\n\r\n    if (stencil) {\r\n      gl.stencilMask(stencil.writeMask ?? BYTE_MASK);\r\n      const mask = stencil.readMask ?? BYTE_MASK;\r\n      gl.stencilFuncSeparate(GLenum.FRONT, stencil.frontCompare || GLenum.ALWAYS, stencilRef, mask);\r\n      gl.stencilFuncSeparate(GLenum.BACK, stencil.backCompare || GLenum.ALWAYS, stencilRef, mask);\r\n      gl.stencilOpSeparate(GLenum.FRONT, stencil.frontFailOp || GLenum.KEEP, stencil.frontZFailOp || GLenum.KEEP,\r\n        stencil.frontPassOp || GLenum.KEEP);\r\n      gl.stencilOpSeparate(GLenum.BACK, stencil.backFailOp || GLenum.KEEP, stencil.backZFailOp || GLenum.KEEP,\r\n        stencil.backPassOp || GLenum.KEEP);\r\n    }\r\n  }\r\n\r\n  // 4. Apply blend state changes\r\n  if (NGL_ENABLE_BLEND) {\r\n    glToggle(gl, GLenum.BLEND, !!blend);\r\n\r\n    if (blend) {\r\n      const mask = blend.colorMask || BYTE_MASK;\r\n      gl.colorMask(!!(mask & 1), !!(mask & 2), !!(mask & 4), !!(mask & 8));\r\n      gl.blendFuncSeparate(\r\n        blend.srcFactorRGB || GLenum.ONE, blend.dstFactorRGB || GLenum.ZERO,\r\n        blend.srcFactorAlpha || GLenum.ONE, blend.dstFactorAlpha || GLenum.ZERO);\r\n      gl.blendEquationSeparate(blend.opRGB || GLenum.FUNC_ADD, blend.opAlpha || GLenum.FUNC_ADD);\r\n    }\r\n  }\r\n}\r\n\r\nfunction glToggle(gl: WebGLRenderingContext, flag: GLenum, enable: boolean): void {\r\n  enable ? gl.enable(flag) : gl.disable(flag);\r\n}\r\n\r\nexport function createProgram(\r\n  gl: WebGLRenderingContext, vs: IGLShader, fs: IGLShader, buffers: readonly ReadonlyVertexBufferLayout[]\r\n): WebGLProgram {\r\n  const program = gl.createProgram()!;\r\n  gl.attachShader(program, vs.gls!);\r\n  gl.attachShader(program, fs.gls!);\r\n\r\n  // Bind attribute locations\r\n  for (const { attrs } of buffers) {\r\n    for (const attr of attrs) {\r\n      gl.bindAttribLocation(program, attr.shaderLoc, attr.name);\r\n    }\r\n  }\r\n\r\n  // Link program\r\n  gl.linkProgram(program);\r\n\r\n  if (MUGL_DEBUG) {\r\n    console.assert(\r\n      gl.getProgramParameter(program, GLenum.LINK_STATUS) || gl.isContextLost(),\r\n      `Failed to link program: ${gl.getProgramInfoLog(program)}`\r\n    );\r\n  }\r\n\r\n  return program;\r\n}\r\n"],"file":"resources.js"}