(()=>{const e=16384,t=1028,i=1029,s=7680,r=34067,n=34069,o=33984,a=36160,l=36161,c=36064,h=36096,f=33306,p=34962,u=34963,d=515,v=1029,m=263169,g=35676,x=512,b=768,y=[0,33189,34041,34041,32856,34836,34842,33326,33325,33328,33327],w=[0,6402,34041,34041,6408,6403,33319],P=[0,5121,5126,36193,5125,34042],F=[5126,5120,5121,5122,5123],k=[4,1,1,2,2],B=255;function M(e){return 32879===e||35866===e}const A=e=>e>0&&e>>16<=3,T=e=>e>>8&B,C=e=>F[e&B],O=e=>!!(e>>16),S=e=>w[e>>8&B];function _(e,t=!1){const i=P[e&B];return t&&36193===i?5131:i}const D={Aniso:"EXT_texture_filter_anisotropic",TexFP16Lin:"OES_texture_half_float_linear",TexFPLin:"OES_texture_float_linear"},U={DFfx:"OES_standard_derivatives",Instancing:"ANGLE_instanced_arrays",UintIndex:"OES_element_index_uint",BlendMinMax:"EXT_blend_minmax",DrawBuffers:"WEBGL_draw_buffers",DepthTex:"WEBGL_depth_texture",TexFP16:"OES_texture_half_float",TexFP:"OES_texture_float",...D},I={BufFP:"EXT_color_buffer_float",...D};class E{constructor(e,{size:t,type:i=34962,usage:s=35044}){const r=this.gl=e.gl;this.type=i,this.usage=s,this.size=t,r.bindBuffer(i,this.glb=r.createBuffer()),r.bufferData(i,t,s)}data(e,t=0){return this.gl.bindBuffer(this.type,this.glb),this.gl.bufferSubData(this.type,t,e),this}destroy(){this.gl.deleteBuffer(this.glb),this.glb=null}}const L={frontFace:2305,cullMode:0,depthBias:0,depthBiasSlopeScale:0,alphaToCoverage:!1},R={writeEnabled:!1,compare:519},z={frontCompare:519,frontFailOp:s,frontZFailOp:s,frontPassOp:s,backCompare:519,backFailOp:s,backZFailOp:s,backPassOp:s,readMask:B,writeMask:B},G={srcFactorRGB:1,dstFactorRGB:0,opRGB:32774,srcFactorAlpha:1,dstFactorAlpha:0,opAlpha:32774,colorMask:15};function q(e,s,r,n=0,o=!1){const{raster:a,depth:l,stencil:c,blend:h}=r;let f=!1,p=0,u=0,d=0,v=0;const m=s.raster||L,g=a||L;if(p=g.frontFace,(o||m.frontFace!==p)&&e.frontFace(p),p=g.cullMode,(o||m.cullMode!==p)&&((f=0!==p)&&e.cullFace(p),N(e,2884,f)),p=g.depthBiasSlopeScale,u=g.depthBias,(o||m.depthBiasSlopeScale!==p||m.depthBias!==u)&&(N(e,32823,!(!p&&!u)),e.polygonOffset(p,u)),f=g.alphaToCoverage,(o||m.alphaToCoverage!==f)&&N(e,32926,f),f=!!l,(o||s.depthOn!==f)&&N(e,2929,f),o||f){const t=s.depth||R,i=l||R;j(e,t.writeEnabled,i.writeEnabled,o),p=i.compare,(o||t.compare!==p)&&e.depthFunc(p)}if(f=!!c,(o||s.stencilOn!==f)&&N(e,2960,f),o||f){const r=s.stencil||z,a=c||z;p=a.readMask,f=o||r.readMask!==p,u=a.frontCompare,(f||r.frontCompare!==u)&&e.stencilFuncSeparate(t,u,n,p),u=a.backCompare,(f||r.backCompare!==u)&&e.stencilFuncSeparate(i,u,n,p),p=a.frontFailOp,u=a.frontZFailOp,d=a.frontPassOp,(o||r.frontFailOp!==p||r.frontZFailOp!==u||r.frontPassOp!==d)&&e.stencilOpSeparate(t,p,u,d),p=a.backFailOp,u=a.backZFailOp,d=a.backPassOp,(o||r.backFailOp!==p||r.backZFailOp!==u||r.backPassOp!==d)&&e.stencilOpSeparate(i,p,u,d),W(e,r.writeMask,a.writeMask,o)}if(f=!!h,(o||s.blendOn!==f)&&N(e,3042,f),o||f){const t=s.blend||G,i=h||G;p=i.srcFactorRGB,u=i.dstFactorRGB,d=i.srcFactorAlpha,v=i.dstFactorAlpha,(o||t.srcFactorRGB!==p||t.dstFactorRGB!==u||t.srcFactorAlpha!==d||t.dstFactorAlpha!==v)&&e.blendFuncSeparate(p,u,d,v),p=i.opRGB,u=i.opAlpha,(o||t.opRGB!==p||t.opAlpha!==u)&&e.blendEquationSeparate(p,u),V(e,t.colorMask,i.colorMask,o)}}function V(e,t,i,s=!1){(t!==i||s)&&e.colorMask(!!(1&i),!!(2&i),!!(4&i),!!(8&i))}function j(e,t,i,s=!1){(t!==i||s)&&e.depthMask(i)}function W(e,t,i,s=!1){(t!==i||s)&&e.stencilMask(i)}function N(e,t,i){i?e.enable(t):e.disable(t)}const Z=(e,t)=>!(!t&&!e)&&Object.assign(e||{},t);function X(e,t,i){const s=e.createShader(t);return e.shaderSource(s,i),e.compileShader(s),s}class K{constructor(e,{vert:t,frag:i,indexFormat:s=5123,mode:r=4,buffers:n,uniforms:o,raster:a,depth:l=!1,stencil:c=!1,blend:h=!1}){const f=this.gl=e.gl;this.vert=t,this.frag=i,this.indexFormat=s,this.mode=r;const p=Array(16);let u=0;const d=this.buffers=n.map((({attrs:e,stride:t=0,instanced:i=!1})=>{const s=Array(e.length);let r=0;for(let t=0;t<e.length;++t){const{offset:i=r,shaderLoc:o=u}=e[t];for(s[t]={...e[t],offset:i,shaderLoc:o},p[u=o]=!0;p[++u];);r=i+(n=s[t].format,k[n&B]*T(n))}var n;return{attrs:s,stride:Math.max(t,r),instanced:i}})),v=this.glp=function(e,t,i,s){const r=X(e,35633,t),n=X(e,35632,i),o=e.createProgram();e.attachShader(o,r),e.attachShader(o,n);for(const{attrs:t}of s)for(const i of t)e.bindAttribLocation(o,i.shaderLoc,i.name);return e.linkProgram(o),e.deleteShader(r),e.deleteShader(n),o}(f,t,i,d);this.uniforms=o?Object.keys(o).reduce(((e,t)=>(e[t]={...o[t]},e)),{}):{};const m=this.cache={};let g=0;for(const e in o){const t=f.getUniformLocation(v,e);if(t){const i=o[e];m[e]={...i,loc:t,texId:2===i.type?g++:-1}}}this.raster={...L,...a},this.depth=!!l&&{...R,...l},this.stencil=!!c&&{...z,...c},this.blend=!!h&&{...G,...h}}destroy(){this.gl.deleteProgram(this.glp),this.glp=null}}const $={},H=[];class J{constructor(e,{color:t=H,depth:i,clearColor:s=!1,clearDepth:r=!1,clearStencil:n=!1}=$){this.glrfb=[];const o=this.gl=e.gl,p=e.feature(U.DrawBuffers),u=this.color=t.map(Q),d=this.depth=i?Q(i):null,v=!!d&&5==(d.tex.format&B);this.clearColor=s,this.clearDepth=r,this.clearStencil=n,this.glfb=null;const m=this.glrfb=[];if(u.length){this.glfb=o.createFramebuffer(),o.bindFramebuffer(a,this.glfb);const t=p||e.webgl2?u.length:1;for(let i=0;i<t;++i)e.webgl2&&u[i].tex.samples>1?o.framebufferRenderbuffer(a,c+i,l,u[i].tex.glrb):Y(o,c+i,u[i]);if(t>1&&(e.webgl2?o.drawBuffers(u.map(((e,t)=>c+t))):p&&p.drawBuffersWEBGL(u.map(((e,t)=>c+t)))),d&&(d.tex.renderTarget||e.webgl2&&d.tex.samples>1?o.framebufferRenderbuffer(a,v?f:h,l,d.tex.glrb):A(d.tex.format)&&Y(o,v?f:h,d)),e.webgl2){for(let e=0;e<t;++e)m.push(u[e].tex.samples>1?ee(o,c,u[e]):null);m.push(d&&d.tex.samples>1?ee(o,v?f:h,d):null)}}}destroy(){this.gl.deleteFramebuffer(this.glfb),this.glfb=null;for(const e of this.glrfb)this.gl.deleteFramebuffer(e);this.glrfb=[]}resolve(){for(let t=0;t<this.glrfb.length-1;++t)this.glrfb[t]&&te(this.gl,this.glfb,this.glrfb[t],this.color[t],e,c+t);const t=this.glrfb[this.glrfb.length-1];this.depth&&t&&te(this.gl,this.glfb,t,this.depth,1280)}}const Q=e=>({mipLevel:0,slice:0,...e});function Y(e,t,i){const s=i.tex;if(M(s.type))e.framebufferTextureLayer(a,t,s.glt,i.mipLevel,i.slice);else{const o=s.type===r?n+i.slice:s.type;e.framebufferTexture2D(a,t,o,s.glt,i.mipLevel)}}function ee(e,t,i){const s=e.createFramebuffer();return e.bindFramebuffer(a,s),Y(e,t,i),s}function te(e,t,i,{tex:s},r,n){e.bindFramebuffer(36008,t),e.bindFramebuffer(36009,i),n&&e.readBuffer(n),e.blitFramebuffer(0,0,s.size[0],s.size[1],0,0,s.size[0],s.size[1],r,9728)}const ie={},se=[];class re{constructor(e,{size:[t,i,s=1],type:a=3553,format:c=263169,mipLevels:h=1,samples:f=1,renderTarget:p=!0},{wrapU:u=33071,wrapV:d=33071,wrapW:v=33071,magFilter:m=9729,minFilter:g=9729,maxLOD:x=Number.MAX_VALUE,minLOD:b=0,maxAniso:w=1}=ie){const P=this.gl=e.gl;this.webgl2=e.webgl2;const F=a===r;this.size=[t,i,F?6:s],this.type=a,this.format=c,this.mipLevels=h,this.samples=f,this.wrapU=u,this.wrapV=d,this.wrapW=v,this.magFilter=m,this.minFilter=g,this.maxLOD=x,this.minLOD=b,this.maxAniso=w;const k=this.renderTarget=A(c)&&p,B=function(e,t=!1){return t||A(e)?y[e>>16]:S(e)}(c,this.webgl2);let T=null,C=null;if((k||f>1)&&(C=P.createRenderbuffer(),P.bindRenderbuffer(l,C),f>1?P.renderbufferStorageMultisample(l,f,B,t,i):P.renderbufferStorage(l,B,t,i)),!k)if(T=P.createTexture(),P.activeTexture(o),P.bindTexture(a,T),P.texParameteri(a,10241,g),P.texParameteri(a,10240,m),P.texParameteri(a,10242,u),P.texParameteri(a,10243,d),e.webgl2&&(P.texParameteri(a,32882,v),P.texParameterf(a,33083,x),P.texParameterf(a,33082,b)),w>1&&P.texParameterf(a,34046,Math.min(w,P.getParameter(34047))),this.webgl2)M(a)?P.texStorage3D(a,h,B,t,i,s):P.texStorage2D(a,h,B,t,i);else{const e=S(c),s=_(c,this.webgl2),r=F?n:a,o=F?6:1;for(let n=0;n<o;++n)for(let o=0;o<h;++o)P.texImage2D(r+n,o,B,t>>o||1,i>>o||1,0,e,s,null)}this.glt=T,this.glrb=C}data(e,[t=0,i=0,s=0]=se,[a=this.size[0]-t,l=this.size[1]-i,c=this.size[2]-s]=se,h=0){const{gl:f,glt:p,type:u,format:d}=this,v=S(d),m=_(d,this.webgl2),g=u===r,x=35866===u,b=Array.isArray(e)?e:[e],y=g||x?b.length:1,w=g?n+s:u;f.activeTexture(o),f.bindTexture(u,p);for(let r=0;r<y;++r)M(u)?f.texSubImage3D(w,h,t,i,s+r*c,a,l,c,v,m,b[r]):this.webgl2||ArrayBuffer.isView(e)?f.texSubImage2D(w+r,h,t,i,a,l,v,m,b[r]):f.texSubImage2D(w+r,h,t,i,v,m,b[r]);return this}mipmap(e=4352){return this.gl.activeTexture(o),this.gl.bindTexture(this.type,this.glt),this.gl.hint(33170,e),this.gl.generateMipmap(this.type),this}destroy(){this.gl.deleteTexture(this.glt),this.gl.deleteRenderbuffer(this.glrb),this.glt=this.glrb=null}}class ne{constructor(e,t){this.gl=e,this.webgl2=t,this.canvas=e.canvas,this.maxAttr=Math.min(e.getParameter(34921),16);const i=this.exts={};for(const s of Object.values(t?I:U))i[s]=e.getExtension(s);this.state=this.reset(),this.renderCtx=new oe(e,t,this.state,this.maxAttr,this.feature(U.Instancing))}buffer(e){return new E(this,e)}texture(e,t){return new re(this,e,t)}pipeline(e){return new K(this,e)}pass(e){return new J(this,e)}render(t){let{width:i,height:s}=this.gl.canvas;t.color.length&&([i,s]=t.color[0].tex.size),this.gl.bindFramebuffer(a,t.glfb),this.gl.viewport(0,0,i,s),this.gl.depthRange(0,1),this.state.scissor&&(this.state.scissor=!1,this.gl.disable(3089));const r=this.state.pipe.blend||G,n=this.state.pipe.depth||R,o=this.state.pipe.stencil||z;let l=0;return t.clearColor&&(l|=e,this.gl.clearColor(...t.clearColor),V(this.gl,r.colorMask,15)),!1!==t.clearDepth&&(l|=256,this.gl.clearDepth(t.clearDepth),j(this.gl,n.writeEnabled,!0)),!1!==t.clearStencil&&(l|=1024,this.gl.clearStencil(t.clearStencil),W(this.gl,o.writeMask,B)),l&&(this.gl.clear(l),l&e&&V(this.gl,15,r.colorMask),256&l&&j(this.gl,!0,n.writeEnabled),1024&l&&W(this.gl,B,o.writeMask)),this.renderCtx.pass=t,this.renderCtx}feature(e){return this.exts[e]}reset(){return Object.assign(this.state||{},function(e,t){const i={blend:!1,blendOn:!1,depth:!1,depthOn:!1,stencil:!1,stencilOn:!1,raster:{...L}},s=[1,1,1,1];e.useProgram(null),e.blendColor(...s),q(e,i,i,0,!0);for(let i=0;i<t;++i)e.disableVertexAttribArray(i);return{pipeObj:null,bufs:[],attrs:[],idx:null,idxFmt:5123,mode:4,pipe:i,blend:s,stencilRef:0,scissor:!1}}(this.gl,this.maxAttr))}}class oe{constructor(e,t,i,s,r){this.gl=e,this.webgl2=t,this.state=i,this.maxAttr=s,this.extInst=r,this.pass=null}pipeline(e){if(this.state.pipeObj===e)return this;this.state.pipeObj&&this.state.pipeObj.glp===e.glp||this.gl.useProgram(e.glp),this.state.pipeObj=e;const t=this.state.pipe;q(this.gl,t,e,this.state.stencilRef),function(e,{blend:t,depth:i,stencil:s,raster:r}){e.blend=Z(e.blend,t),e.blendOn=!!t,e.depth=Z(e.depth,i),e.depthOn=!!i,e.stencil=Z(e.stencil,s),e.stencilOn=!!s,Object.assign(e.raster,r)}(t,e);const i=this.state.bufs=Array(e.buffers.length),s=Array(this.maxAttr).fill(null),r=this.state.attrs;this.state.attrs=s;for(let t=0;t<e.buffers.length;++t){const{attrs:r,stride:n,instanced:o}=e.buffers[t],a=[];i[t]={glb:null,attrs:a};for(const{format:e,offset:i,shaderLoc:l}of r)a.push(s[l]={buf:t,ptr:[l,T(e),C(e),O(e),n,i],step:o?1:0})}for(let e=0;e<this.maxAttr;++e)s[e]&&!r[e]?this.gl.enableVertexAttribArray(e):!s[e]&&r[e]&&this.gl.disableVertexAttribArray(e);return this.state.idxFmt=e.indexFormat,this.state.mode=e.mode,this}index({glb:e}){return e!==this.state.idx&&this.gl.bindBuffer(34963,this.state.idx=e),this}vertex(e,{glb:t}){const i=this.state.bufs[e];if(i&&i.glb!==t){this.gl.bindBuffer(34962,i.glb=t);for(let e=0;e<i.attrs.length;++e){const{ptr:t,step:s}=i.attrs[e];this.gl.vertexAttribPointer(...t),this.webgl2?this.gl.vertexAttribDivisor(t[0],s):this.extInst?.vertexAttribDivisorANGLE(t[0],s)}}return this}uniforms(e){if(!this.state.pipeObj)return this;for(const t in e){const i=this.state.pipeObj.cache[t];if(!i)continue;const s=e[t];if(Array.isArray(s)||ArrayBuffer.isView(s))switch(i.format){case 35676:this.gl.uniformMatrix4fv(i.loc,!1,s);break;case 35675:this.gl.uniformMatrix3fv(i.loc,!1,s);break;case 35666:this.gl.uniform4fv(i.loc,s);break;case 35665:this.gl.uniform3fv(i.loc,s);break;case 35664:this.gl.uniform2fv(i.loc,s);break;case 5126:this.gl.uniform1fv(i.loc,s)}else"number"==typeof s?5126===i.format&&this.gl.uniform1f(i.loc,s):2===i.type&&(this.gl.activeTexture(o+i.texId),this.gl.bindTexture(s.type,s.glt),this.gl.uniform1i(i.loc,i.texId))}return this}draw(e,t=1,i=0){return t>1&&(this.webgl2||this.extInst)?this.webgl2?this.gl.drawArraysInstanced(this.state.mode,i,e,t):this.extInst.drawArraysInstancedANGLE(this.state.mode,i,e,t):this.gl.drawArrays(this.state.mode,i,e),this}drawIndexed(e,t=1,i=0){const{mode:s,idxFmt:r}=this.state,n=i*((o=r)?o-5123+2:0);var o;return t>1&&(this.webgl2||this.extInst)?this.webgl2?this.gl.drawElementsInstanced(s,e,r,n,t):this.extInst.drawElementsInstancedANGLE(s,e,r,n,t):this.gl.drawElements(s,e,r,n),this}viewport(e,t,i,s,r=0,n=1){return this.gl.viewport(e,t,i,s),this.gl.depthRange(r,n),this}scissor(e,t,i,s){return this.state.scissor||(this.gl.enable(3089),this.state.scissor=!0),this.gl.scissor(e,t,i,s),this}blendColor(e){return this.gl.blendColor(...e),this}stencilRef(e){if(this.state.stencilRef!==e){const{frontCompare:s,backCompare:r,readMask:n}=this.state.pipe.stencil||z;this.gl.stencilFuncSeparate(t,s,e,n),this.gl.stencilFuncSeparate(i,r,e,n),this.state.stencilRef=e}return this}end(){this.pass?.resolve(),this.pass=null}}class ae{constructor(e){this.device=e,this.resources=[]}register(...e){this.resources.push(...e)}destroy(){for(const e of this.resources)e.destroy()}}function le(e,t,i,s=35044){return e.buffer({type:t,usage:s,size:i.byteLength}).data(i)}function ce(e){return new Promise(((t,i)=>{const s=new Image;s.onload=()=>t(s),s.onerror=i,s.src=e}))}function he(e,t){return e.reduce(((e,i,s)=>(e.push(...t(i,s)),e)),[])}const fe=new Float32Array([0,.5,1,0,0,1,.5,-.5,0,1,0,1,-.5,-.5,0,0,1,1]);var pe=1e-6,ue="undefined"!=typeof Float32Array?Float32Array:Array;function de(){var e=new ue(16);return ue!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function ve(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function me(e,t,i,s,r){var n,o=1/Math.tan(t/2);return e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(n=1/(s-r),e[10]=(r+s)*n,e[14]=2*r*s*n):(e[10]=-1,e[14]=-2*s),e}function ge(e,t,i,s){var r,n,o,a,l,c,h,f,p,u,d=t[0],v=t[1],m=t[2],g=s[0],x=s[1],b=s[2],y=i[0],w=i[1],P=i[2];return Math.abs(d-y)<pe&&Math.abs(v-w)<pe&&Math.abs(m-P)<pe?function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e):(h=d-y,f=v-w,p=m-P,r=x*(p*=u=1/Math.hypot(h,f,p))-b*(f*=u),n=b*(h*=u)-g*p,o=g*f-x*h,(u=Math.hypot(r,n,o))?(r*=u=1/u,n*=u,o*=u):(r=0,n=0,o=0),a=f*o-p*n,l=p*r-h*o,c=h*n-f*r,(u=Math.hypot(a,l,c))?(a*=u=1/u,l*=u,c*=u):(a=0,l=0,c=0),e[0]=r,e[1]=a,e[2]=h,e[3]=0,e[4]=n,e[5]=l,e[6]=f,e[7]=0,e[8]=o,e[9]=c,e[10]=p,e[11]=0,e[12]=-(r*d+n*v+o*m),e[13]=-(a*d+l*v+c*m),e[14]=-(h*d+f*v+p*m),e[15]=1,e)}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var xe=function(e,t,i){var s=t[0],r=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],f=t[8],p=t[9],u=t[10],d=t[11],v=t[12],m=t[13],g=t[14],x=t[15],b=i[0],y=i[1],w=i[2],P=i[3];return e[0]=b*s+y*a+w*f+P*v,e[1]=b*r+y*l+w*p+P*m,e[2]=b*n+y*c+w*u+P*g,e[3]=b*o+y*h+w*d+P*x,b=i[4],y=i[5],w=i[6],P=i[7],e[4]=b*s+y*a+w*f+P*v,e[5]=b*r+y*l+w*p+P*m,e[6]=b*n+y*c+w*u+P*g,e[7]=b*o+y*h+w*d+P*x,b=i[8],y=i[9],w=i[10],P=i[11],e[8]=b*s+y*a+w*f+P*v,e[9]=b*r+y*l+w*p+P*m,e[10]=b*n+y*c+w*u+P*g,e[11]=b*o+y*h+w*d+P*x,b=i[12],y=i[13],w=i[14],P=i[15],e[12]=b*s+y*a+w*f+P*v,e[13]=b*r+y*l+w*p+P*m,e[14]=b*n+y*c+w*u+P*g,e[15]=b*o+y*h+w*d+P*x,e};const be={positions:[[-1,-1,1],[1,-1,1],[1,1,1],[-1,-1,1],[1,1,1],[-1,1,1]],uvs:[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]]},ye={indices:[[2,1,0],[2,0,3],[6,5,4],[6,4,7],[10,9,8],[10,8,11],[14,13,12],[14,12,15],[18,17,16],[18,16,19],[20,21,22],[23,20,22]],positions:[[-1,1,1],[1,1,1],[1,-1,1],[-1,-1,1],[1,1,-1],[-1,1,-1],[-1,-1,-1],[1,-1,-1],[1,1,1],[1,1,-1],[1,-1,-1],[1,-1,1],[-1,1,-1],[-1,1,1],[-1,-1,1],[-1,-1,-1],[-1,1,-1],[1,1,-1],[1,1,1],[-1,1,1],[-1,-1,-1],[1,-1,-1],[1,-1,1],[-1,-1,1]],uvs:[[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1]],normals:[[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,-1],[0,0,-1],[0,0,-1],[0,0,-1],[1,0,0],[1,0,0],[1,0,0],[1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,-1,0],[0,-1,0],[0,-1,0],[0,-1,0]],colors:[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[0,1,0,1],[0,1,0,1],[0,1,0,1],[0,1,0,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[1,1,0,1],[1,1,0,1],[1,1,0,1],[1,1,0,1],[0,1,1,1],[0,1,1,1],[0,1,1,1],[0,1,1,1],[1,0,1,1],[1,0,1,1],[1,0,1,1],[1,0,1,1]]},we=512,Pe=new Float32Array(he(ye.positions,((e,t)=>[...e,2*ye.uvs[t][0],2*ye.uvs[t][1]]))),Fe=new Uint16Array(he(ye.indices,(e=>e)));function ke(e){return new Promise((t=>e.canvas.toBlob((e=>{const i=new Image;i.src=URL.createObjectURL(e),i.onload=()=>t(i)}))))}function Be(){const e=document.createElement("canvas");e.width=e.height=we;const t=e.getContext("2d"),i="#28ccdf",s="#39314b",r=t.createLinearGradient(0,0,0,we);r.addColorStop(0,i),r.addColorStop(.4,"#8aebf1"),r.addColorStop(.99,"#dff6f5"),r.addColorStop(1,s),t.fillStyle=i,t.fillRect(0,0,we,we);const n=ke(t);t.fillStyle=s,t.fillRect(0,0,we,we);const o=ke(t);t.fillStyle=r,t.fillRect(0,0,we,we);const a=ke(t);return Promise.all([a,n,o])}const Me=10,Ae=new Float32Array([0,-.05,-.05,0,.05,.05]),Te=new Float32Array(500),Ce=new Float32Array(100);for(let e=0;e<100;e++){Ce[e]=Math.random()*(2*Math.PI),Te[5*e]=2*Math.floor(e/Me)/Me-1+.1,Te[5*e+1]=e%Me*2/Me-1+.1;const t=Math.floor(e/Me)/Me,i=e%Me/Me,s=t*i+.2;Te[5*e+2]=t,Te[5*e+3]=i,Te[5*e+4]=s}const Oe=1024,Se=[[-1,-1,-1,-1,8,-1,-1,-1,-1],[-2,-1,0,-1,1,1,0,1,2],[0,0,0,0,1,0,0,0,0]],_e=new Float32Array(he(ye.positions,((e,t)=>[...e,...ye.colors[t]]))),De=new Uint16Array(he(ye.indices,(e=>e))),Ue=new Float32Array(he(be.positions,((e,t)=>[...e,...be.uvs[t]])));function Ie(){var e=new ue(3);return ue!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}Ie();const Ee=new Float32Array(he(ye.positions,((e,t)=>[...e,...ye.uvs[t]]))),Le=new Uint16Array(he(ye.indices,(e=>e))),Re=new Float32Array(he(be.positions,((e,t)=>[...e,...be.uvs[t]]))),ze=new Float32Array(he(ye.positions,((e,t)=>[...e,...ye.uvs[t]]))),Ge=new Uint16Array(he(ye.indices,(e=>e))),qe=new Uint16Array(he(ye.indices,(e=>[...e].reverse()))),Ve={basic:{title:"Hello World",factory:class extends ae{constructor(e){super(e),this.angle=0,this.rotate=()=>{this.angle+=Math.PI/12,this.render()}}init(){this.buffer=le(this.device,p,fe),this.pass=this.device.pass(),this.pipeline=this.device.pipeline({vert:"\nuniform float angle;\nattribute vec2 position;\nattribute vec4 color;\nvarying lowp vec4 vColor;\nvoid main () {\n  gl_Position = vec4(\n    cos(angle) * position.x - sin(angle) * position.y,\n    sin(angle) * position.x + cos(angle) * position.y,\n    0, 1\n  );\n  vColor = color;\n}\n",frag:"\nvarying lowp vec4 vColor;\nvoid main () {\n  gl_FragColor = vColor;\n}\n",buffers:[{attrs:[{name:"position",format:x},{name:"color",format:1024}]}],uniforms:{angle:{type:1,format:5126}}}),this.device.canvas.addEventListener("click",this.rotate),this.register(this.buffer,this.pipeline,this.pass)}render(){return this.device.render(this.pass).pipeline(this.pipeline).vertex(0,this.buffer).uniforms({angle:this.angle}).draw(3).end(),!1}destroy(){super.destroy(),this.device.canvas.removeEventListener("click",this.rotate)}}},instancing:{title:"Instancing",factory:class extends ae{constructor(e){super(e),this.t=0}init(){const e=this.device;this.position=le(e,p,Ae),this.offsetColor=le(e,p,Te),this.angle=le(e,p,Ce,35040),this.pass=e.pass({clearColor:[0,0,0,1]}),this.pipeline=e.pipeline({vert:"\nprecision mediump float;\nattribute vec2 position;\nattribute vec3 color;\nattribute vec2 offset;\nattribute float angle;\nvarying vec3 vColor;\nvoid main() {\n  gl_Position = vec4(\n    cos(angle) * position.x + sin(angle) * position.y + offset.x,\n    -sin(angle) * position.x + cos(angle) * position.y + offset.y,\n    0, 1);\n  vColor = color;\n}\n",frag:"\nprecision mediump float;\nuniform vec3 ambient;\nvarying vec3 vColor;\nvoid main () {\n  gl_FragColor = vec4(ambient + vColor, 1.0);\n}\n",buffers:[{attrs:[{name:"position",format:x}]},{attrs:[{name:"offset",format:x},{name:"color",format:b}],instanced:!0},{attrs:[{name:"angle",format:256}],instanced:!0}],uniforms:{ambient:{type:1,format:35665}}}),this.register(this.position,this.offsetColor,this.angle,this.pipeline,this.pass)}render(e){for(let t=0;t<100;t++)Ce[t]+=this.t-e-2*Math.PI*(Ce[t]/Math.PI/2|0);this.t=e,this.angle.data(Ce);const t=Math.sin(e)/2;return this.device.render(this.pass).pipeline(this.pipeline).uniforms({ambient:[t,t,t]}).vertex(0,this.position).vertex(1,this.offsetColor).vertex(2,this.angle).draw(3,100).end(),!0}}},cube:{title:"Textures",factory:class extends ae{constructor(e){super(e),this.loaded=!1}init(){const e=this.device;this.vertBuffer=le(e,p,Pe),this.indexBuffer=le(e,u,Fe),this.cubeTex=e.texture({type:3553,format:m,size:[we,we]},{minFilter:9987,wrapU:10497,wrapV:10497,maxAniso:16});const t={vert:"\nprecision mediump float;\nuniform mat4 mvp;\nattribute vec3 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvarying vec3 vNormal;\nvoid main(void) {\n  vUv = uv;\n  vNormal = normalize(position);\n  gl_Position = mvp * vec4(position, 1.0);\n}\n",frag:"\nprecision mediump float;\nvarying vec2 vUv;\nuniform sampler2D tex;\nvoid main () {\n  gl_FragColor = texture2D(tex, vUv);\n}\n",buffers:[{attrs:[{name:"position",format:b},{name:"uv",format:x}]}],uniforms:{mvp:{type:1,format:g},tex:{type:2,format:this.cubeTex.type}},depth:{compare:d,writeEnabled:!0},raster:{cullMode:v}};this.cubePipeline=e.pipeline(t),this.skyTex=e.texture({type:34067,format:m,size:[we,we]}),this.skyPipeline=e.pipeline({...t,frag:"\nprecision mediump float;\nvarying vec3 vNormal;\nuniform samplerCube tex;\nvoid main () {\n  gl_FragColor = textureCube(tex, normalize(vNormal));\n}\n",uniforms:{mvp:{type:1,format:g},tex:{type:2,format:this.skyTex.type}},raster:{cullMode:1028}}),this.pass=e.pass({clearDepth:1}),this.loaded=!1,Promise.all([ce("./airplane.png"),Be()]).then((([e,t])=>{this.skyTex.data([t[0],...t,t[0],t[0]]),this.cubeTex.data(e).mipmap(),this.loaded=!0})),this.register(this.pass,this.vertBuffer,this.cubePipeline,this.indexBuffer,this.cubeTex,this.skyPipeline,this.skyTex)}render(e){if(!this.loaded)return!0;const t=me(de(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),i=ge(de(),[10*Math.cos(e),5*Math.sin(e),10*Math.sin(e)],[0,0,0],[0,1,0]),s=xe(i,t,i),r=this.device.render(this.pass);let n=s;return r.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:n,tex:this.cubeTex}).drawIndexed(Fe.length),n=xe(s,s,ve(de(),[10,10,10])),r.pipeline(this.skyPipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:n,tex:this.skyTex}).drawIndexed(Fe.length).end(),!0}}},postprocess:{title:"Post-processing",factory:class extends ae{constructor(e){super(e),this.kernel=0,this.nextKernel=()=>{this.kernel=(this.kernel+1)%Se.length}}init(){const e=this.device;this.vertBuffer=le(e,p,_e),this.indexBuffer=le(e,u,De),this.cubePipeline=e.pipeline({vert:"\nuniform mat4 mvp;\nattribute vec4 position;\nattribute vec4 color;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_Position = mvp * position;\n  vColor = color;\n}",frag:"\nprecision mediump float;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_FragColor = vColor;\n}",buffers:[{attrs:[{name:"position",format:b},{name:"color",format:1024}]}],uniforms:{mvp:{type:1,format:g}},depth:{compare:d,writeEnabled:!0},raster:{cullMode:v}}),this.offscreenTex=e.texture({size:[Oe,Oe]}),this.quadVertBuffer=le(e,p,Ue),this.quadPipeline=e.pipeline({vert:"\nattribute vec4 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvoid main(void) {\n  gl_Position = position;\n  vUv = uv;\n}\n",frag:"\nprecision mediump float; \nuniform sampler2D tex;\nuniform vec2 texSize;\nuniform mat3 kernel;\nuniform float kernelWeight;\nvarying vec2 vUv;\nvoid main(void) {\n  vec2 onePixel = vec2(1.0, 1.0) / texSize;\n  vec4 colorSum =\n    texture2D(tex, vUv + onePixel * vec2(-1, -1)) * kernel[0][0] +\n    texture2D(tex, vUv + onePixel * vec2( 0, -1)) * kernel[0][1] +\n    texture2D(tex, vUv + onePixel * vec2( 1, -1)) * kernel[0][2] +\n    texture2D(tex, vUv + onePixel * vec2(-1,  0)) * kernel[1][0] +\n    texture2D(tex, vUv + onePixel * vec2( 0,  0)) * kernel[1][1] +\n    texture2D(tex, vUv + onePixel * vec2( 1,  0)) * kernel[1][2] +\n    texture2D(tex, vUv + onePixel * vec2(-1,  1)) * kernel[2][0] +\n    texture2D(tex, vUv + onePixel * vec2( 0,  1)) * kernel[2][1] +\n    texture2D(tex, vUv + onePixel * vec2( 1,  1)) * kernel[2][2] ;\n  gl_FragColor = vec4((colorSum / kernelWeight).rgb, 1);\n}\n",buffers:[{attrs:[{name:"position",format:b},{name:"uv",format:x}]}],uniforms:{tex:{type:2,format:this.offscreenTex.type},texSize:{type:1,format:35664},kernel:{type:1,format:35675},kernelWeight:{type:1,format:5126}}}),this.depthTex=e.texture({format:65796,size:[Oe,Oe]}),this.defaultPass=e.pass({clearColor:[0,0,0,1],clearDepth:1}),this.offscreenPass=e.pass({color:[{tex:this.offscreenTex}],depth:{tex:this.depthTex},clearColor:[.25,.25,.25,1],clearDepth:1}),e.canvas.addEventListener("click",this.nextKernel),this.register(this.defaultPass,this.offscreenPass,this.cubePipeline,this.vertBuffer,this.indexBuffer,this.quadPipeline,this.quadVertBuffer,this.offscreenTex,this.depthTex)}render(e){const t=me(de(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),i=ge(de(),[10*Math.cos(e),5*Math.sin(e),10*Math.sin(e)],[0,0,0],[0,1,0]),s=xe(i,t,i);this.device.render(this.offscreenPass).pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:s}).drawIndexed(De.length).end();const r=Se[this.kernel];let n=r.reduce(((e,t)=>e+t));return n=n<=0?1:n,this.device.render(this.defaultPass).pipeline(this.quadPipeline).vertex(0,this.quadVertBuffer).uniforms({tex:this.offscreenTex,texSize:[this.offscreenTex.size[0],this.offscreenTex.size[1]],kernel:r,kernelWeight:n}).draw(6).end(),!0}destroy(){super.destroy(),this.device.canvas.removeEventListener("click",this.nextKernel)}}},mrt:{title:"Multi Render Targets",factory:class extends ae{constructor(e){super(e)}init(){this.vertBuffer=le(this.device,p,Ee),this.indexBuffer=le(this.device,u,Le),this.cubePipeline=this.device.pipeline({vert:this.device.webgl2?"#version 300 es\nprecision mediump float;\nuniform mat4 model, vp;\nin vec3 position;\nin vec2 uv;\nout vec3 vPosition;\nout vec2 vUv;\nvoid main(void) {\n  vec4 worldPos = model * vec4(position, 1.0);\n  vPosition = worldPos.xyz;\n  vUv = uv;\n  gl_Position = vp * worldPos;\n}":"\nprecision mediump float;\nuniform mat4 model, vp;\nattribute vec3 position;\nattribute vec2 uv;\nvarying vec3 vPosition;\nvarying vec2 vUv;\nvoid main(void) {\n  vec4 worldPos = model * vec4(position, 1.0);\n  vPosition = worldPos.xyz;\n  vUv = uv;\n  gl_Position = vp * worldPos;\n}",frag:this.device.webgl2?"#version 300 es\nprecision mediump float;\nuniform vec3 color;\nin vec3 vPosition;\nin vec2 vUv;\nlayout(location = 0) out vec4 out0;\nlayout(location = 1) out vec4 out1;\nlayout(location = 2) out vec4 out2;\nvoid main(void) {\n  out0 = vec4(color, 1.0);\n  out1 = vec4(vUv, 0.0, 0.0);\n  out2 = vec4(vPosition, 0.0);\n}":"\n#extension GL_EXT_draw_buffers : require\nprecision mediump float;\nvarying vec3 vPosition;\nvarying vec2 vUv;\nuniform vec3 color;\nvoid main(void) {\n  gl_FragData[0] = vec4(color, 1.0);\n  gl_FragData[1] = vec4(vUv, 0.0, 0.0);\n  gl_FragData[2] = vec4(vPosition, 0.0);\n}",buffers:[{attrs:[{name:"position",format:b},{name:"uv",format:x}]}],uniforms:{model:{type:1,format:g},vp:{type:1,format:g},color:{type:1,format:35665}},depth:{compare:d,writeEnabled:!0},raster:{cullMode:v}});const e={size:[1024,1024]};this.colorTex=this.device.texture(e),this.uvTex=this.device.texture(e),this.positionTex=this.device.texture(e),this.depthTex=this.device.texture({...e,format:65796}),this.quadVertBuffer=le(this.device,p,Re),this.quadPipeline=this.device.pipeline({vert:"\nattribute vec4 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvoid main(void) {\n  gl_Position = position;\n  vUv = uv;\n}\n",frag:"\nprecision mediump float;\nuniform sampler2D tex0;\nuniform sampler2D tex1;\nuniform sampler2D tex2;\nvarying vec2 vUv;\nvoid main(void) {\n  vec4 colorSum =\n    texture2D(tex0, vUv * 2.0 - vec2(0.0, 1.0)) * step(0.5, 1.0 - vUv.x) * step(0.5, vUv.y) +\n    texture2D(tex1, vUv * 2.0 - vec2(0.0, 0.0)) * step(0.5, 1.0 - vUv.x) * step(0.5, 1.0 - vUv.y) +\n    texture2D(tex2, vUv * 2.0 - vec2(1.0, 1.0)) * step(0.5, vUv.x) * step(0.5, vUv.y);\n  gl_FragColor = vec4(colorSum.rgb, 1.0);\n}\n",buffers:[{attrs:[{name:"position",format:b},{name:"uv",format:x}]}],uniforms:{tex0:{type:2,format:this.colorTex.type},tex1:{type:2,format:this.uvTex.type},tex2:{type:2,format:this.positionTex.type}}}),this.defaultPass=this.device.pass({clearColor:[0,0,0,1],clearDepth:1}),this.offscreenPass=this.device.pass({color:[{tex:this.colorTex},{tex:this.uvTex},{tex:this.positionTex}],depth:{tex:this.depthTex},clearColor:[0,0,0,1],clearDepth:1}),this.register(this.defaultPass,this.offscreenPass,this.cubePipeline,this.vertBuffer,this.indexBuffer,this.quadPipeline,this.quadVertBuffer,this.colorTex,this.uvTex,this.positionTex,this.depthTex)}render(e){const t=[.5,.5,.5],i=me(de(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),s=ge(de(),(r=Ie(),n=[5*Math.cos(e),2.5*Math.sin(e),5*Math.sin(e)],o=t,r[0]=n[0]+o[0],r[1]=n[1]+o[1],r[2]=n[2]+o[2],r),t,[0,1,0]);var r,n,o;const a=xe(s,i,s);let l=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}(de(),t);return l=xe(l,l,ve(de(),[.5,.5,.5])),this.device.render(this.offscreenPass).pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({model:l,vp:a,color:[1,1,1]}).drawIndexed(Le.length).end(),this.device.render(this.defaultPass).pipeline(this.quadPipeline).vertex(0,this.quadVertBuffer).uniforms({tex0:this.colorTex,tex1:this.uvTex,tex2:this.positionTex}).draw(6).end(),!0}}},stencil:{title:"Stencil",factory:class extends ae{constructor(e){super(e)}init(){const e=this.device;this.tex=e.texture({size:[512,512]}),ce("./airplane.png").then((e=>{this.tex.data(e)})),this.vertBuffer=le(e,p,ze),this.indexBuffer=le(e,u,Ge),this.skyIndexBuffer=le(e,u,qe);const t={vert:"\nprecision mediump float;\nuniform mat4 mvp;\nattribute vec3 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvoid main(void) {\n  vUv = uv;\n  gl_Position = mvp * vec4(position, 1.0);\n}\n",frag:"\nprecision mediump float;\nvarying vec2 vUv;\nuniform sampler2D tex;\nvoid main () {\n  gl_FragColor = texture2D(tex, vUv);\n}\n",buffers:[{attrs:[{name:"position",format:b},{name:"uv",format:x}],stride:20}],uniforms:{mvp:{type:1,format:g},tex:{type:2,format:this.tex.type}},depth:{compare:d,writeEnabled:!0},stencil:{backCompare:519,backPassOp:7681,frontCompare:519,frontPassOp:7681},raster:{cullMode:v}};this.cubePipeline=e.pipeline(t),this.cubeOutlinePipeline=e.pipeline({...t,frag:"\nprecision mediump float;\nuniform vec4 color;\nvoid main () {\n  gl_FragColor = color;\n}\n",uniforms:{mvp:{type:1,format:g},color:{type:1,format:35666}},depth:{writeEnabled:!0},stencil:{backCompare:517,frontCompare:517,writeMask:0}}),this.pass=e.pass({clearDepth:1,clearStencil:0}),this.register(this.pass,this.vertBuffer,this.indexBuffer,this.skyIndexBuffer,this.tex,this.cubePipeline,this.cubeOutlinePipeline)}render(e){const t=me(de(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),i=ge(de(),[10*Math.cos(e),5*Math.sin(e),10*Math.sin(e)],[0,0,0],[0,1,0]),s=xe(i,t,i),r=this.device.render(this.pass);let n=s;return r.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:n,tex:this.tex}).stencilRef(1).drawIndexed(Ge.length),n=xe(de(),s,ve(de(),[1.1,1.1,1.1])),r.pipeline(this.cubeOutlinePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:n,color:[.1,.3,.25,1]}).stencilRef(1).drawIndexed(Ge.length),n=xe(de(),s,ve(de(),[10,10,10])),r.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.skyIndexBuffer).uniforms({mvp:n,tex:this.tex}).drawIndexed(qe.length).end(),!0}}}},je=document.getElementById("menu");for(const e in Ve){const t=document.createElement("li"),i=document.createElement("a");i.id=e,i.href=`#${e}`,i.innerText=Ve[e].title,t.appendChild(i),je.appendChild(t)}const We=document.querySelector("canvas"),Ne=window.devicePixelRatio||1;if(Ne>1){const{width:e,height:t}=We;We.width=e*Ne,We.height=t*Ne,We.style.width=`${e}px`,We.style.height=`${t}px`}const Ze=((e,t)=>{let i=null,s=!1;return t?.webgl2&&(s=!!(i=e.getContext("webgl2",t))),i||(i=e.getContext("webgl",t)||e.getContext("experimental-webgl",t)),i?new ne(i,s):null})(We,{stencil:!0,powerPreference:"low-power",webgl2:!0});let Xe,Ke=0;function $e(e=0){Ke=requestAnimationFrame($e),Xe.render(e/1e3)||cancelAnimationFrame(Ke)}window.loadExample=function(e=location.hash){const t=Ve[e.replace("#","")];t&&(cancelAnimationFrame(Ke),Xe&&(Xe.destroy(),Ze.reset()),Xe=new t.factory(Ze),Xe.init(),$e())},location.hash=location.hash||"#basic",window.loadExample()})();