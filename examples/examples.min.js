(()=>{const e=16384,t=1028,i=1029,n=5126,r=7680,s=34067,o=34069,a=33984,l=36160,c=36161,h=34041,f=36064,u=36096,p=33306,v=34962,d=34963,m=515,g=i,x=263169,b=35665,y=35676,w=512,P=768,F=[0,33189,h,h,32856,34836,34842,33326,33325,33328,33327],B=[0,6402,h,h,6408,6403,33319],D=[0,5121,n,36193,5125,34042],k=[n,5120,5121,5122,5123],C=[4,1,1,2,2],M=255;function T(e){return 32879===e||35866===e}const A=e=>e>0&&e>>16<=3,S=e=>e>>8&M,U=e=>k[e&M],O=e=>!!(e>>16),_=e=>B[e>>8&M];function I(e,t=!1){const i=D[e&M];return t&&36193===i?5131:i}const E={Aniso:"EXT_texture_filter_anisotropic",TexFP16Lin:"OES_texture_half_float_linear",TexFPLin:"OES_texture_float_linear"},L={DFfx:"OES_standard_derivatives",Instancing:"ANGLE_instanced_arrays",UintIndex:"OES_element_index_uint",BlendMinMax:"EXT_blend_minmax",DrawBuffers:"WEBGL_draw_buffers",DepthTex:"WEBGL_depth_texture",TexFP16:"OES_texture_half_float",TexFP:"OES_texture_float",...E},z={BufFP:"EXT_color_buffer_float",...E};class R{constructor(e,{size:t,type:i=34962,usage:n=35044}){const r=this.gl=e.gl;this.type=i,this.usage=n,this.size=t,r.bindBuffer(i,this.glb=r.createBuffer()),r.bufferData(i,t,n)}data(e,t=0){return this.gl.bindBuffer(this.type,this.glb),this.gl.bufferSubData(this.type,t,e),this}destroy(){this.gl.deleteBuffer(this.glb),this.glb=null}}const q={frontFace:2305,cullMode:0,depthBias:0,depthBiasSlopeScale:0,alphaToCoverage:!1},V={writeEnabled:!1,compare:519},G={frontCompare:519,frontFailOp:r,frontZFailOp:r,frontPassOp:r,backCompare:519,backFailOp:r,backZFailOp:r,backPassOp:r,readMask:M,writeMask:M},j={srcFactorRGB:1,dstFactorRGB:0,opRGB:32774,srcFactorAlpha:1,dstFactorAlpha:0,opAlpha:32774,colorMask:15};function N(e,n,r,s=0,o=!1){const{raster:a,depth:l,stencil:c,blend:h}=r;let f=!1,u=0,p=0,v=0,d=0;const m=n.raster||q,g=a||q;if(u=g.frontFace,(o||m.frontFace!==u)&&e.frontFace(u),u=g.cullMode,(o||m.cullMode!==u)&&((f=0!==u)&&e.cullFace(u),X(e,2884,f)),u=g.depthBiasSlopeScale,p=g.depthBias,(o||m.depthBiasSlopeScale!==u||m.depthBias!==p)&&(X(e,32823,!(!u&&!p)),e.polygonOffset(u,p)),f=g.alphaToCoverage,(o||m.alphaToCoverage!==f)&&X(e,32926,f),f=!!l,(o||n.depthOn!==f)&&X(e,2929,f),o||f){const t=n.depth||V,i=l||V;W(e,t.writeEnabled,i.writeEnabled,o),u=i.compare,(o||t.compare!==u)&&e.depthFunc(u)}if(f=!!c,(o||n.stencilOn!==f)&&X(e,2960,f),o||f){const r=n.stencil||G,a=c||G;u=a.readMask,f=o||r.readMask!==u,p=a.frontCompare,(f||r.frontCompare!==p)&&e.stencilFuncSeparate(t,p,s,u),p=a.backCompare,(f||r.backCompare!==p)&&e.stencilFuncSeparate(i,p,s,u),u=a.frontFailOp,p=a.frontZFailOp,v=a.frontPassOp,(o||r.frontFailOp!==u||r.frontZFailOp!==p||r.frontPassOp!==v)&&e.stencilOpSeparate(t,u,p,v),u=a.backFailOp,p=a.backZFailOp,v=a.backPassOp,(o||r.backFailOp!==u||r.backZFailOp!==p||r.backPassOp!==v)&&e.stencilOpSeparate(i,u,p,v),Z(e,r.writeMask,a.writeMask,o)}if(f=!!h,(o||n.blendOn!==f)&&X(e,3042,f),o||f){const t=n.blend||j,i=h||j;u=i.srcFactorRGB,p=i.dstFactorRGB,v=i.srcFactorAlpha,d=i.dstFactorAlpha,(o||t.srcFactorRGB!==u||t.dstFactorRGB!==p||t.srcFactorAlpha!==v||t.dstFactorAlpha!==d)&&e.blendFuncSeparate(u,p,v,d),u=i.opRGB,p=i.opAlpha,(o||t.opRGB!==u||t.opAlpha!==p)&&e.blendEquationSeparate(u,p),H(e,t.colorMask,i.colorMask,o)}}function H(e,t,i,n=!1){(t!==i||n)&&e.colorMask(!!(1&i),!!(2&i),!!(4&i),!!(8&i))}function W(e,t,i,n=!1){(t!==i||n)&&e.depthMask(i)}function Z(e,t,i,n=!1){(t!==i||n)&&e.stencilMask(i)}function X(e,t,i){i?e.enable(t):e.disable(t)}const K=(e,t)=>!(!t&&!e)&&Object.assign(e||{},t);function $(e,t,i){const n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),n}class J{constructor(e,{vert:t,frag:i,indexFormat:n=5123,mode:r=4,buffers:s,uniforms:o,raster:a,depth:l=!1,stencil:c=!1,blend:h=!1}){const f=this.gl=e.gl;this.vert=t,this.frag=i,this.indexFormat=n,this.mode=r;const u=Array(16);let p=0;const v=this.buffers=s.map((({attrs:e,stride:t=0,instanced:i=!1})=>{const n=Array(e.length);let r=0,s=e.length>0?1/0:0;for(let t=0;t<e.length;++t){const{offset:i=r,shaderLoc:a=p}=e[t];for(n[t]={...e[t],offset:i,shaderLoc:a},u[p=a]=!0;u[++p];);r=Math.max(r,i+(o=n[t].format,C[o&M]*S(o))),s=Math.min(s,i)}var o;return{attrs:n,stride:t||r-s,instanced:i}})),d=this.glp=function(e,t,i,n){const r=$(e,35633,t),s=$(e,35632,i),o=e.createProgram();e.attachShader(o,r),e.attachShader(o,s);for(const{attrs:t}of n)for(const i of t)e.bindAttribLocation(o,i.shaderLoc,i.name);return e.linkProgram(o),e.deleteShader(r),e.deleteShader(s),o}(f,t,i,v);this.uniforms=o?Object.keys(o).reduce(((e,t)=>(e[t]={...o[t]},e)),{}):{};const m=this.cache={};let g=0,x=0;for(const e in o){const t=o[e];let i;4===t.type?(i=f.getUniformBlockIndex(d,e),f.uniformBlockBinding(d,i,g++)):i=f.getUniformLocation(d,e),null!==i&&4294967295!==i&&(m[e]={...t,loc:i,binding:2===t.type?x++:4===t.type?g:-1})}this.raster={...q,...a},this.depth=!!l&&{...V,...l},this.stencil=!!c&&{...G,...c},this.blend=!!h&&{...j,...h}}destroy(){this.gl.deleteProgram(this.glp),this.glp=null}}const Q={},Y=[];class ee{constructor(e,{color:t=Y,depth:i,clearColor:n=!1,clearDepth:r=!1,clearStencil:s=!1}=Q){this.glrfb=[];const o=this.gl=e.gl,a=e.feature(L.DrawBuffers),h=this.color=t.map(te),v=this.depth=i?te(i):null,d=!!v&&5==(v.tex.format&M);this.clearColor=n,this.clearDepth=r,this.clearStencil=s,this.glfb=null;const m=this.glrfb=[];if(h.length){this.glfb=o.createFramebuffer(),o.bindFramebuffer(l,this.glfb);const t=a||e.webgl2?h.length:1;for(let i=0;i<t;++i)e.webgl2&&h[i].tex.samples>1?o.framebufferRenderbuffer(l,f+i,c,h[i].tex.glrb):ie(o,f+i,h[i]);if(t>1&&(e.webgl2?o.drawBuffers(h.map(((e,t)=>f+t))):a&&a.drawBuffersWEBGL(h.map(((e,t)=>f+t)))),v&&(v.tex.renderTarget||e.webgl2&&v.tex.samples>1?o.framebufferRenderbuffer(l,d?p:u,c,v.tex.glrb):A(v.tex.format)&&ie(o,d?p:u,v)),e.webgl2){for(let e=0;e<t;++e)m.push(h[e].tex.samples>1?ne(o,f,h[e]):null);m.push(v&&v.tex.samples>1?ne(o,d?p:u,v):null)}}}destroy(){this.gl.deleteFramebuffer(this.glfb),this.glfb=null;for(const e of this.glrfb)this.gl.deleteFramebuffer(e);this.glrfb=[]}resolve(){for(let t=0;t<this.glrfb.length-1;++t)this.glrfb[t]&&re(this.gl,this.glfb,this.glrfb[t],this.color[t],e,f+t);const t=this.glrfb[this.glrfb.length-1];this.depth&&t&&re(this.gl,this.glfb,t,this.depth,1280)}}const te=e=>({mipLevel:0,slice:0,...e});function ie(e,t,i){const n=i.tex;if(T(n.type))e.framebufferTextureLayer(l,t,n.glt,i.mipLevel,i.slice);else{const r=n.type===s?o+i.slice:n.type;e.framebufferTexture2D(l,t,r,n.glt,i.mipLevel)}}function ne(e,t,i){const n=e.createFramebuffer();return e.bindFramebuffer(l,n),ie(e,t,i),n}function re(e,t,i,{tex:n},r,s){e.bindFramebuffer(36008,t),e.bindFramebuffer(36009,i),s&&e.readBuffer(s),e.blitFramebuffer(0,0,n.size[0],n.size[1],0,0,n.size[0],n.size[1],r,9728)}const se={},oe=[];class ae{constructor(e,{size:[t,i,n=1],type:r=3553,format:l=263169,mipLevels:h=1,samples:f=1,renderTarget:u=!0},{wrapU:p=33071,wrapV:v=33071,wrapW:d=33071,magFilter:m=9729,minFilter:g=9729,maxLOD:x=Number.MAX_VALUE,minLOD:b=0,maxAniso:y=1}=se){const w=this.gl=e.gl;this.webgl2=e.webgl2;const P=r===s;this.size=[t,i,P?6:n],this.type=r,this.format=l,this.mipLevels=h,this.samples=f,this.wrapU=p,this.wrapV=v,this.wrapW=d,this.magFilter=m,this.minFilter=g,this.maxLOD=x,this.minLOD=b,this.maxAniso=y;const B=this.renderTarget=A(l)&&u,D=function(e,t=!1){return t||A(e)?F[e>>16]:_(e)}(l,this.webgl2);let k=null,C=null;if((B||f>1)&&(C=w.createRenderbuffer(),w.bindRenderbuffer(c,C),f>1?w.renderbufferStorageMultisample(c,f,D,t,i):w.renderbufferStorage(c,D,t,i)),!B)if(k=w.createTexture(),w.activeTexture(a),w.bindTexture(r,k),w.texParameteri(r,10241,g),w.texParameteri(r,10240,m),w.texParameteri(r,10242,p),w.texParameteri(r,10243,v),e.webgl2&&(w.texParameteri(r,32882,d),w.texParameterf(r,33083,x),w.texParameterf(r,33082,b)),y>1&&w.texParameterf(r,34046,Math.min(y,w.getParameter(34047))),this.webgl2)T(r)?w.texStorage3D(r,h,D,t,i,n):w.texStorage2D(r,h,D,t,i);else{const e=_(l),n=I(l,this.webgl2),s=P?o:r,a=P?6:1;for(let r=0;r<a;++r)for(let o=0;o<h;++o)w.texImage2D(s+r,o,D,t>>o||1,i>>o||1,0,e,n,null)}this.glt=k,this.glrb=C}data(e,[t=0,i=0,n=0]=oe,[r=this.size[0]-t,l=this.size[1]-i,c=this.size[2]-n]=oe,h=0){const{gl:f,glt:u,type:p,format:v}=this,d=_(v),m=I(v,this.webgl2),g=p===s,x=35866===p,b=Array.isArray(e)?e:[e],y=g||x?b.length:1,w=g?o+n:p;f.activeTexture(a),f.bindTexture(p,u);for(let s=0;s<y;++s)T(p)?f.texSubImage3D(w,h,t,i,n+s*c,r,l,c,d,m,b[s]):this.webgl2||ArrayBuffer.isView(e)?f.texSubImage2D(w+s,h,t,i,r,l,d,m,b[s]):f.texSubImage2D(w+s,h,t,i,d,m,b[s]);return this}mipmap(e=4352){return this.gl.activeTexture(a),this.gl.bindTexture(this.type,this.glt),this.gl.hint(33170,e),this.gl.generateMipmap(this.type),this}destroy(){this.gl.deleteTexture(this.glt),this.gl.deleteRenderbuffer(this.glrb),this.glt=this.glrb=null}}class le{constructor(e,t){this.gl=e,this.webgl2=t,this.exts={},this.canvas=e.canvas,this.maxAttr=Math.min(e.getParameter(34921),16);for(const e of Object.values(t?z:L))this.feature(e);this.state=this.reset(),this.renderCtx=new ce(e,t,this.state,this.maxAttr,this.feature(L.Instancing))}buffer(e){return new R(this,e)}texture(e,t){return new ae(this,e,t)}pipeline(e){return new J(this,e)}pass(e){return new ee(this,e)}render(t){let{width:i,height:n}=this.gl.canvas;t.color.length&&([i,n]=t.color[0].tex.size),this.gl.bindFramebuffer(l,t.glfb),this.gl.viewport(0,0,i,n),this.gl.depthRange(0,1),this.state.scissor&&(this.state.scissor=!1,this.gl.disable(3089));const r=this.state.pipe.blend||j,s=this.state.pipe.depth||V,o=this.state.pipe.stencil||G;let a=0;return t.clearColor&&(a|=e,this.gl.clearColor(...t.clearColor),H(this.gl,r.colorMask,15)),!1!==t.clearDepth&&(a|=256,this.gl.clearDepth(t.clearDepth),W(this.gl,s.writeEnabled,!0)),!1!==t.clearStencil&&(a|=1024,this.gl.clearStencil(t.clearStencil),Z(this.gl,o.writeMask,M)),a&&(this.gl.clear(a),a&e&&H(this.gl,15,r.colorMask),256&a&&W(this.gl,!0,s.writeEnabled),1024&a&&Z(this.gl,M,o.writeMask)),this.renderCtx.pass=t,this.renderCtx}feature(e){return this.exts[e]=this.exts[e]||this.gl.getExtension(e)}reset(){return Object.assign(this.state||{},function(e,t){const i={blend:!1,blendOn:!1,depth:!1,depthOn:!1,stencil:!1,stencilOn:!1,raster:{...q}},n=[1,1,1,1];e.useProgram(null),e.blendColor(...n),N(e,i,i,0,!0);for(let i=0;i<t;++i)e.disableVertexAttribArray(i);return{pipeObj:null,bufs:[],attrs:[],idx:null,idxFmt:5123,mode:4,pipe:i,blend:n,stencilRef:0,scissor:!1}}(this.gl,this.maxAttr))}}class ce{constructor(e,t,i,n,r){this.gl=e,this.webgl2=t,this.state=i,this.maxAttr=n,this.extInst=r,this.pass=null}pipeline(e){if(this.state.pipeObj===e)return this;this.state.pipeObj&&this.state.pipeObj.glp===e.glp||this.gl.useProgram(e.glp),this.state.pipeObj=e;const t=this.state.pipe;N(this.gl,t,e,this.state.stencilRef),function(e,{blend:t,depth:i,stencil:n,raster:r}){e.blend=K(e.blend,t),e.blendOn=!!t,e.depth=K(e.depth,i),e.depthOn=!!i,e.stencil=K(e.stencil,n),e.stencilOn=!!n,Object.assign(e.raster,r)}(t,e);const i=this.state.bufs=Array(e.buffers.length),n=Array(this.maxAttr).fill(null),r=this.state.attrs;this.state.attrs=n;for(let t=0;t<e.buffers.length;++t){const{attrs:r,stride:s,instanced:o}=e.buffers[t],a=[];i[t]={glb:null,attrs:a};for(const{format:e,offset:i,shaderLoc:l}of r)a.push(n[l]={buf:t,ptr:[l,S(e),U(e),O(e),s,i],step:o?1:0})}for(let e=0;e<this.maxAttr;++e)n[e]&&!r[e]?this.gl.enableVertexAttribArray(e):!n[e]&&r[e]&&this.gl.disableVertexAttribArray(e);return this.state.idxFmt=e.indexFormat,this.state.mode=e.mode,this}index({glb:e}){return e!==this.state.idx&&this.gl.bindBuffer(34963,this.state.idx=e),this}vertex(e,{glb:t}){const i=this.state.bufs[e];if(i&&i.glb!==t){this.gl.bindBuffer(34962,i.glb=t);for(let e=0;e<i.attrs.length;++e){const{ptr:t,step:n}=i.attrs[e];this.gl.vertexAttribPointer(...t),this.webgl2?this.gl.vertexAttribDivisor(t[0],n):this.extInst?.vertexAttribDivisorANGLE(t[0],n)}}return this}uniforms(e){if(!this.state.pipeObj)return this;for(const t in e){const i=this.state.pipeObj.cache[t];if(!i)continue;const r=e[t];if(1===i.type)if(Array.isArray(r)||ArrayBuffer.isView(r))switch(i.format){case 35676:this.gl.uniformMatrix4fv(i.loc,!1,r);break;case 35675:this.gl.uniformMatrix3fv(i.loc,!1,r);break;case 35666:this.gl.uniform4fv(i.loc,r);break;case 35665:this.gl.uniform3fv(i.loc,r);break;case 35664:this.gl.uniform2fv(i.loc,r);break;case n:this.gl.uniform1fv(i.loc,r)}else"number"==typeof r&&i.format===n&&this.gl.uniform1f(i.loc,r);else if(2===i.type)r?.glt&&(this.gl.activeTexture(a+i.binding),this.gl.bindTexture(r.type,r.glt),this.gl.uniform1i(i.loc,i.binding));else if(35345===r?.buffer?.type){const e=r.offset||0;this.gl.bindBufferRange(35345,i.loc,r.buffer.glb,e,r.size||r.buffer.size-e)}}return this}draw(e,t=1,i=0){return t>1&&(this.webgl2||this.extInst)?this.webgl2?this.gl.drawArraysInstanced(this.state.mode,i,e,t):this.extInst.drawArraysInstancedANGLE(this.state.mode,i,e,t):this.gl.drawArrays(this.state.mode,i,e),this}drawIndexed(e,t=1,i=0){const{mode:n,idxFmt:r}=this.state,s=i*((o=r)?o-5123+2:0);var o;return t>1&&(this.webgl2||this.extInst)?this.webgl2?this.gl.drawElementsInstanced(n,e,r,s,t):this.extInst.drawElementsInstancedANGLE(n,e,r,s,t):this.gl.drawElements(n,e,r,s),this}viewport(e,t,i,n,r=0,s=1){return this.gl.viewport(e,t,i,n),this.gl.depthRange(r,s),this}scissor(e,t,i,n){return this.state.scissor||(this.gl.enable(3089),this.state.scissor=!0),this.gl.scissor(e,t,i,n),this}blendColor(e){return this.gl.blendColor(...e),this}stencilRef(e){if(this.state.stencilRef!==e){const{frontCompare:n,backCompare:r,readMask:s}=this.state.pipe.stencil||G;this.gl.stencilFuncSeparate(t,n,e,s),this.gl.stencilFuncSeparate(i,r,e,s),this.state.stencilRef=e}return this}end(){this.pass?.resolve(),this.pass=null}}class he{constructor(){this.resources=[]}register(...e){this.resources.push(...e)}destroy(){for(const e of this.resources)e.destroy()}}function fe(e,t,i,n=35044){return e.buffer({type:t,usage:n,size:i.byteLength}).data(i)}function ue(e,t){return e.reduce(((e,i,n)=>(e.push(...t(i,n)),e)),[])}function pe(e){return new Promise((t=>e.canvas.toBlob((e=>{const i=new Image;i.src=URL.createObjectURL(e),i.onload=()=>t(i)}))))}const ve=new Float32Array([0,.5,1,0,0,1,.5,-.5,0,1,0,1,-.5,-.5,0,0,1,1]);var de=1e-6,me="undefined"!=typeof Float32Array?Float32Array:Array;function ge(){var e=new me(16);return me!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function xe(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function be(e,t,i,n,r){var s,o=1/Math.tan(t/2);return e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(s=1/(n-r),e[10]=(r+n)*s,e[14]=2*r*n*s):(e[10]=-1,e[14]=-2*n),e}function ye(e,t,i,n){var r,s,o,a,l,c,h,f,u,p,v=t[0],d=t[1],m=t[2],g=n[0],x=n[1],b=n[2],y=i[0],w=i[1],P=i[2];return Math.abs(v-y)<de&&Math.abs(d-w)<de&&Math.abs(m-P)<de?function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e):(h=v-y,f=d-w,u=m-P,r=x*(u*=p=1/Math.hypot(h,f,u))-b*(f*=p),s=b*(h*=p)-g*u,o=g*f-x*h,(p=Math.hypot(r,s,o))?(r*=p=1/p,s*=p,o*=p):(r=0,s=0,o=0),a=f*o-u*s,l=u*r-h*o,c=h*s-f*r,(p=Math.hypot(a,l,c))?(a*=p=1/p,l*=p,c*=p):(a=0,l=0,c=0),e[0]=r,e[1]=a,e[2]=h,e[3]=0,e[4]=s,e[5]=l,e[6]=f,e[7]=0,e[8]=o,e[9]=c,e[10]=u,e[11]=0,e[12]=-(r*v+s*d+o*m),e[13]=-(a*v+l*d+c*m),e[14]=-(h*v+f*d+u*m),e[15]=1,e)}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var we=function(e,t,i){var n=t[0],r=t[1],s=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],f=t[8],u=t[9],p=t[10],v=t[11],d=t[12],m=t[13],g=t[14],x=t[15],b=i[0],y=i[1],w=i[2],P=i[3];return e[0]=b*n+y*a+w*f+P*d,e[1]=b*r+y*l+w*u+P*m,e[2]=b*s+y*c+w*p+P*g,e[3]=b*o+y*h+w*v+P*x,b=i[4],y=i[5],w=i[6],P=i[7],e[4]=b*n+y*a+w*f+P*d,e[5]=b*r+y*l+w*u+P*m,e[6]=b*s+y*c+w*p+P*g,e[7]=b*o+y*h+w*v+P*x,b=i[8],y=i[9],w=i[10],P=i[11],e[8]=b*n+y*a+w*f+P*d,e[9]=b*r+y*l+w*u+P*m,e[10]=b*s+y*c+w*p+P*g,e[11]=b*o+y*h+w*v+P*x,b=i[12],y=i[13],w=i[14],P=i[15],e[12]=b*n+y*a+w*f+P*d,e[13]=b*r+y*l+w*u+P*m,e[14]=b*s+y*c+w*p+P*g,e[15]=b*o+y*h+w*v+P*x,e};const Pe={positions:[[-1,-1,1],[1,-1,1],[1,1,1],[-1,-1,1],[1,1,1],[-1,1,1]],uvs:[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]]},Fe={indices:[[2,1,0],[2,0,3],[6,5,4],[6,4,7],[10,9,8],[10,8,11],[14,13,12],[14,12,15],[18,17,16],[18,16,19],[20,21,22],[23,20,22]],positions:[[-1,1,1],[1,1,1],[1,-1,1],[-1,-1,1],[1,1,-1],[-1,1,-1],[-1,-1,-1],[1,-1,-1],[1,1,1],[1,1,-1],[1,-1,-1],[1,-1,1],[-1,1,-1],[-1,1,1],[-1,-1,1],[-1,-1,-1],[-1,1,-1],[1,1,-1],[1,1,1],[-1,1,1],[-1,-1,-1],[1,-1,-1],[1,-1,1],[-1,-1,1]],uvs:[[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1],[0,0],[1,0],[1,1],[0,1]],normals:[[0,0,1],[0,0,1],[0,0,1],[0,0,1],[0,0,-1],[0,0,-1],[0,0,-1],[0,0,-1],[1,0,0],[1,0,0],[1,0,0],[1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[-1,0,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,-1,0],[0,-1,0],[0,-1,0],[0,-1,0]],colors:[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[0,1,0,1],[0,1,0,1],[0,1,0,1],[0,1,0,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[0,0,1,1],[1,1,0,1],[1,1,0,1],[1,1,0,1],[1,1,0,1],[0,1,1,1],[0,1,1,1],[0,1,1,1],[0,1,1,1],[1,0,1,1],[1,0,1,1],[1,0,1,1],[1,0,1,1]]};function Be(e){const t=document.createElement("canvas");t.width=t.height=e;const i=t.getContext("2d"),n="#28ccdf",r="#39314b",s=i.createLinearGradient(0,0,0,e);s.addColorStop(0,n),s.addColorStop(.4,"#8aebf1"),s.addColorStop(.99,"#dff6f5"),s.addColorStop(1,r),i.fillStyle=n,i.fillRect(0,0,e,e);const o=pe(i);i.fillStyle=r,i.fillRect(0,0,e,e);const a=pe(i);i.fillStyle=s,i.fillRect(0,0,e,e);const l=pe(i);return Promise.all([l,o,a])}const De=()=>new Promise(((e,t)=>{const i=new Image;i.onload=()=>e(i),i.onerror=t,i.src="./airplane.png"})),ke=512,Ce=new Float32Array(ue(Fe.positions,((e,t)=>[...e,2*Fe.uvs[t][0],2*Fe.uvs[t][1]]))),Me=new Uint16Array(ue(Fe.indices,(e=>e))),Te=10,Ae=new Float32Array([0,-.05,-.05,0,.05,.05]),Se=new Float32Array(500),Ue=new Float32Array(100);for(let e=0;e<100;e++){Ue[e]=Math.random()*(2*Math.PI),Se[5*e]=2*Math.floor(e/Te)/Te-1+.1,Se[5*e+1]=e%Te*2/Te-1+.1;const t=Math.floor(e/Te)/Te,i=e%Te/Te,n=t*i+.2;Se[5*e+2]=t,Se[5*e+3]=i,Se[5*e+4]=n}const Oe=1024,_e=[[-1,-1,-1,-1,8,-1,-1,-1,-1],[-2,-1,0,-1,1,1,0,1,2],[0,0,0,0,1,0,0,0,0]],Ie=new Float32Array(ue(Fe.positions,((e,t)=>[...e,...Fe.colors[t]]))),Ee=new Uint16Array(ue(Fe.indices,(e=>e))),Le=new Float32Array(ue(Pe.positions,((e,t)=>[...e,...Pe.uvs[t]])));function ze(){var e=new me(3);return me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}ze();const Re=new Float32Array(ue(Fe.positions,((e,t)=>[...e,...Fe.uvs[t]]))),qe=new Uint16Array(ue(Fe.indices,(e=>e))),Ve=new Float32Array(ue(Pe.positions,((e,t)=>[...e,...Pe.uvs[t]]))),Ge=new Float32Array(ue(Fe.positions,((e,t)=>[...e,...Fe.uvs[t]]))),je=new Uint16Array(ue(Fe.indices,(e=>e))),Ne=new Uint16Array(ue(Fe.indices,(e=>[...e].reverse()))),He=512,We=new Float32Array(ue(Fe.positions,((e,t)=>[...e,...Fe.uvs[t]]))),Ze=new Uint16Array(ue(Fe.indices,(e=>e))),Xe={basic:{title:"Hello World",factory:class extends he{constructor(e){super(),this.device=e,this.angle=0,this.rotate=()=>{this.angle+=Math.PI/12,this.render()}}init(){this.buffer=fe(this.device,v,ve),this.pass=this.device.pass(),this.pipeline=this.device.pipeline({vert:"\nuniform float angle;\nattribute vec2 position;\nattribute vec4 color;\nvarying lowp vec4 vColor;\nvoid main () {\n  gl_Position = vec4(\n    cos(angle) * position.x - sin(angle) * position.y,\n    sin(angle) * position.x + cos(angle) * position.y,\n    0, 1\n  );\n  vColor = color;\n}\n",frag:"\nvarying lowp vec4 vColor;\nvoid main () {\n  gl_FragColor = vColor;\n}\n",buffers:[{attrs:[{name:"position",format:w},{name:"color",format:1024}]}],uniforms:{angle:{type:1,format:5126}}}),this.device.canvas.addEventListener("click",this.rotate),this.register(this.buffer,this.pipeline,this.pass)}render(){return this.device.render(this.pass).pipeline(this.pipeline).vertex(0,this.buffer).uniforms({angle:this.angle}).draw(3).end(),!1}destroy(){super.destroy(),this.device.canvas.removeEventListener("click",this.rotate)}}},instancing:{title:"Instancing",factory:class extends he{constructor(e){super(),this.device=e,this.t=0}init(){const e=this.device;this.position=fe(e,v,Ae),this.offsetColor=fe(e,v,Se),this.angle=fe(e,v,Ue,35040),this.pass=e.pass({clearColor:[0,0,0,1]}),this.pipeline=e.pipeline({vert:"\nprecision mediump float;\nattribute vec2 position;\nattribute vec3 color;\nattribute vec2 offset;\nattribute float angle;\nvarying vec3 vColor;\nvoid main() {\n  gl_Position = vec4(\n    cos(angle) * position.x + sin(angle) * position.y + offset.x,\n    -sin(angle) * position.x + cos(angle) * position.y + offset.y,\n    0, 1);\n  vColor = color;\n}\n",frag:"\nprecision mediump float;\nuniform vec3 ambient;\nvarying vec3 vColor;\nvoid main () {\n  gl_FragColor = vec4(ambient + vColor, 1.0);\n}\n",buffers:[{attrs:[{name:"position",format:w}]},{attrs:[{name:"offset",format:w},{name:"color",format:P}],instanced:!0},{attrs:[{name:"angle",format:256}],instanced:!0}],uniforms:{ambient:{type:1,format:b}}}),this.register(this.position,this.offsetColor,this.angle,this.pipeline,this.pass)}render(e){for(let t=0;t<100;t++)Ue[t]+=this.t-e-2*Math.PI*(Ue[t]/Math.PI/2|0);this.t=e,this.angle.data(Ue);const t=Math.sin(e)/2;return this.device.render(this.pass).pipeline(this.pipeline).uniforms({ambient:[t,t,t]}).vertex(0,this.position).vertex(1,this.offsetColor).vertex(2,this.angle).draw(3,100).end(),!0}}},cube:{title:"Textures",factory:class extends he{constructor(e){super(),this.device=e,this.loaded=!1}init(){const e=this.device;this.vertBuffer=fe(e,v,Ce),this.indexBuffer=fe(e,d,Me),this.cubeTex=e.texture({type:3553,format:x,size:[ke,ke]},{minFilter:9987,wrapU:10497,wrapV:10497,maxAniso:16});const t={vert:"\nprecision mediump float;\nuniform mat4 mvp;\nattribute vec3 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvarying vec3 vNormal;\nvoid main(void) {\n  vUv = uv;\n  vNormal = normalize(position);\n  gl_Position = mvp * vec4(position, 1.0);\n}\n",frag:"\nprecision mediump float;\nvarying vec2 vUv;\nuniform sampler2D tex;\nvoid main () {\n  gl_FragColor = texture2D(tex, vUv);\n}\n",buffers:[{attrs:[{name:"position",format:P},{name:"uv",format:w}]}],uniforms:{mvp:{type:1,format:y},tex:{type:2,format:this.cubeTex.type}},depth:{compare:m,writeEnabled:!0},raster:{cullMode:g}};this.cubePipeline=e.pipeline(t),this.skyTex=e.texture({type:34067,format:x,size:[ke,ke]}),this.skyPipeline=e.pipeline({...t,frag:"\nprecision mediump float;\nvarying vec3 vNormal;\nuniform samplerCube tex;\nvoid main () {\n  gl_FragColor = textureCube(tex, normalize(vNormal));\n}\n",uniforms:{mvp:{type:1,format:y},tex:{type:2,format:this.skyTex.type}},raster:{cullMode:1028}}),this.pass=e.pass({clearDepth:1}),this.loaded=!1,Promise.all([De(),Be(ke)]).then((([e,t])=>{this.skyTex.data([t[0],...t,t[0],t[0]]),this.cubeTex.data(e).mipmap(),this.loaded=!0})),this.register(this.pass,this.vertBuffer,this.cubePipeline,this.indexBuffer,this.cubeTex,this.skyPipeline,this.skyTex)}render(e){if(!this.loaded)return!0;const t=be(ge(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),i=ye(ge(),[10*Math.cos(e),5*Math.sin(e),10*Math.sin(e)],[0,0,0],[0,1,0]),n=we(i,t,i),r=this.device.render(this.pass);let s=n;return r.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:s,tex:this.cubeTex}).drawIndexed(Me.length),s=we(n,n,xe(ge(),[10,10,10])),r.pipeline(this.skyPipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:s,tex:this.skyTex}).drawIndexed(Me.length).end(),!0}}},postprocess:{title:"Post-processing",factory:class extends he{constructor(e){super(),this.device=e,this.kernel=0,this.nextKernel=()=>{this.kernel=(this.kernel+1)%_e.length}}init(){const e=this.device;this.vertBuffer=fe(e,v,Ie),this.indexBuffer=fe(e,d,Ee),this.cubePipeline=e.pipeline({vert:"\nuniform mat4 mvp;\nattribute vec4 position;\nattribute vec4 color;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_Position = mvp * position;\n  vColor = color;\n}",frag:"\nprecision mediump float;\nvarying vec4 vColor;\nvoid main(void) {\n  gl_FragColor = vColor;\n}",buffers:[{attrs:[{name:"position",format:P},{name:"color",format:1024}]}],uniforms:{mvp:{type:1,format:y}},depth:{compare:m,writeEnabled:!0},raster:{cullMode:g}}),this.offscreenTex=e.texture({size:[Oe,Oe]}),this.quadVertBuffer=fe(e,v,Le),this.quadPipeline=e.pipeline({vert:"\nattribute vec4 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvoid main(void) {\n  gl_Position = position;\n  vUv = uv;\n}\n",frag:"\nprecision mediump float; \nuniform sampler2D tex;\nuniform vec2 texSize;\nuniform mat3 kernel;\nuniform float kernelWeight;\nvarying vec2 vUv;\nvoid main(void) {\n  vec2 onePixel = vec2(1.0, 1.0) / texSize;\n  vec4 colorSum =\n    texture2D(tex, vUv + onePixel * vec2(-1, -1)) * kernel[0][0] +\n    texture2D(tex, vUv + onePixel * vec2( 0, -1)) * kernel[0][1] +\n    texture2D(tex, vUv + onePixel * vec2( 1, -1)) * kernel[0][2] +\n    texture2D(tex, vUv + onePixel * vec2(-1,  0)) * kernel[1][0] +\n    texture2D(tex, vUv + onePixel * vec2( 0,  0)) * kernel[1][1] +\n    texture2D(tex, vUv + onePixel * vec2( 1,  0)) * kernel[1][2] +\n    texture2D(tex, vUv + onePixel * vec2(-1,  1)) * kernel[2][0] +\n    texture2D(tex, vUv + onePixel * vec2( 0,  1)) * kernel[2][1] +\n    texture2D(tex, vUv + onePixel * vec2( 1,  1)) * kernel[2][2] ;\n  gl_FragColor = vec4((colorSum / kernelWeight).rgb, 1);\n}\n",buffers:[{attrs:[{name:"position",format:P},{name:"uv",format:w}]}],uniforms:{tex:{type:2,format:this.offscreenTex.type},texSize:{type:1,format:35664},kernel:{type:1,format:35675},kernelWeight:{type:1,format:5126}}}),this.depthTex=e.texture({format:65796,size:[Oe,Oe]}),this.defaultPass=e.pass({clearColor:[0,0,0,1],clearDepth:1}),this.offscreenPass=e.pass({color:[{tex:this.offscreenTex}],depth:{tex:this.depthTex},clearColor:[.25,.25,.25,1],clearDepth:1}),e.canvas.addEventListener("click",this.nextKernel),this.register(this.defaultPass,this.offscreenPass,this.cubePipeline,this.vertBuffer,this.indexBuffer,this.quadPipeline,this.quadVertBuffer,this.offscreenTex,this.depthTex)}render(e){const t=be(ge(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),i=ye(ge(),[10*Math.cos(e),5*Math.sin(e),10*Math.sin(e)],[0,0,0],[0,1,0]),n=we(i,t,i);this.device.render(this.offscreenPass).pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:n}).drawIndexed(Ee.length).end();const r=_e[this.kernel];let s=r.reduce(((e,t)=>e+t));return s=s<=0?1:s,this.device.render(this.defaultPass).pipeline(this.quadPipeline).vertex(0,this.quadVertBuffer).uniforms({tex:this.offscreenTex,texSize:[this.offscreenTex.size[0],this.offscreenTex.size[1]],kernel:r,kernelWeight:s}).draw(6).end(),!0}destroy(){super.destroy(),this.device.canvas.removeEventListener("click",this.nextKernel)}}},mrt:{title:"Multi Render Targets",factory:class extends he{constructor(e){super(),this.device=e}init(){this.vertBuffer=fe(this.device,v,Re),this.indexBuffer=fe(this.device,d,qe),this.cubePipeline=this.device.pipeline({vert:this.device.webgl2?"#version 300 es\nprecision mediump float;\nuniform mat4 model, vp;\nin vec3 position;\nin vec2 uv;\nout vec3 vPosition;\nout vec2 vUv;\nvoid main(void) {\n  vec4 worldPos = model * vec4(position, 1.0);\n  vPosition = worldPos.xyz;\n  vUv = uv;\n  gl_Position = vp * worldPos;\n}":"\nprecision mediump float;\nuniform mat4 model, vp;\nattribute vec3 position;\nattribute vec2 uv;\nvarying vec3 vPosition;\nvarying vec2 vUv;\nvoid main(void) {\n  vec4 worldPos = model * vec4(position, 1.0);\n  vPosition = worldPos.xyz;\n  vUv = uv;\n  gl_Position = vp * worldPos;\n}",frag:this.device.webgl2?"#version 300 es\nprecision mediump float;\nuniform vec3 color;\nin vec3 vPosition;\nin vec2 vUv;\nlayout(location = 0) out vec4 out0;\nlayout(location = 1) out vec4 out1;\nlayout(location = 2) out vec4 out2;\nvoid main(void) {\n  out0 = vec4(color, 1.0);\n  out1 = vec4(vUv, 0.0, 0.0);\n  out2 = vec4(vPosition, 0.0);\n}":"\n#extension GL_EXT_draw_buffers : require\nprecision mediump float;\nvarying vec3 vPosition;\nvarying vec2 vUv;\nuniform vec3 color;\nvoid main(void) {\n  gl_FragData[0] = vec4(color, 1.0);\n  gl_FragData[1] = vec4(vUv, 0.0, 0.0);\n  gl_FragData[2] = vec4(vPosition, 0.0);\n}",buffers:[{attrs:[{name:"position",format:P},{name:"uv",format:w}]}],uniforms:{model:{type:1,format:y},vp:{type:1,format:y},color:{type:1,format:b}},depth:{compare:m,writeEnabled:!0},raster:{cullMode:g}});const e={size:[1024,1024]};this.colorTex=this.device.texture(e),this.uvTex=this.device.texture(e),this.positionTex=this.device.texture(e),this.depthTex=this.device.texture({...e,format:65796}),this.quadVertBuffer=fe(this.device,v,Ve),this.quadPipeline=this.device.pipeline({vert:"\nattribute vec4 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvoid main(void) {\n  gl_Position = position;\n  vUv = uv;\n}\n",frag:"\nprecision mediump float;\nuniform sampler2D tex0;\nuniform sampler2D tex1;\nuniform sampler2D tex2;\nvarying vec2 vUv;\nvoid main(void) {\n  vec4 colorSum =\n    texture2D(tex0, vUv * 2.0 - vec2(0.0, 1.0)) * step(0.5, 1.0 - vUv.x) * step(0.5, vUv.y) +\n    texture2D(tex1, vUv * 2.0 - vec2(0.0, 0.0)) * step(0.5, 1.0 - vUv.x) * step(0.5, 1.0 - vUv.y) +\n    texture2D(tex2, vUv * 2.0 - vec2(1.0, 1.0)) * step(0.5, vUv.x) * step(0.5, vUv.y);\n  gl_FragColor = vec4(colorSum.rgb, 1.0);\n}\n",buffers:[{attrs:[{name:"position",format:P},{name:"uv",format:w}]}],uniforms:{tex0:{type:2,format:this.colorTex.type},tex1:{type:2,format:this.uvTex.type},tex2:{type:2,format:this.positionTex.type}}}),this.defaultPass=this.device.pass({clearColor:[0,0,0,1],clearDepth:1}),this.offscreenPass=this.device.pass({color:[{tex:this.colorTex},{tex:this.uvTex},{tex:this.positionTex}],depth:{tex:this.depthTex},clearColor:[0,0,0,1],clearDepth:1}),this.register(this.defaultPass,this.offscreenPass,this.cubePipeline,this.vertBuffer,this.indexBuffer,this.quadPipeline,this.quadVertBuffer,this.colorTex,this.uvTex,this.positionTex,this.depthTex)}render(e){const t=[.5,.5,.5],i=be(ge(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),n=ye(ge(),(r=ze(),s=[5*Math.cos(e),2.5*Math.sin(e),5*Math.sin(e)],o=t,r[0]=s[0]+o[0],r[1]=s[1]+o[1],r[2]=s[2]+o[2],r),t,[0,1,0]);var r,s,o;const a=we(n,i,n);let l=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}(ge(),t);return l=we(l,l,xe(ge(),[.5,.5,.5])),this.device.render(this.offscreenPass).pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({model:l,vp:a,color:[1,1,1]}).drawIndexed(qe.length).end(),this.device.render(this.defaultPass).pipeline(this.quadPipeline).vertex(0,this.quadVertBuffer).uniforms({tex0:this.colorTex,tex1:this.uvTex,tex2:this.positionTex}).draw(6).end(),!0}}},stencil:{title:"Stencil",factory:class extends he{constructor(e){super(),this.device=e}init(){const e=this.device;this.tex=e.texture({size:[512,512]}),De().then((e=>{this.tex.data(e)})),this.vertBuffer=fe(e,v,Ge),this.indexBuffer=fe(e,d,je),this.skyIndexBuffer=fe(e,d,Ne);const t={vert:"\nprecision mediump float;\nuniform mat4 mvp;\nattribute vec3 position;\nattribute vec2 uv;\nvarying vec2 vUv;\nvoid main(void) {\n  vUv = uv;\n  gl_Position = mvp * vec4(position, 1.0);\n}\n",frag:"\nprecision mediump float;\nvarying vec2 vUv;\nuniform sampler2D tex;\nvoid main () {\n  gl_FragColor = texture2D(tex, vUv);\n}\n",buffers:[{attrs:[{name:"position",format:P},{name:"uv",format:w}],stride:20}],uniforms:{mvp:{type:1,format:y},tex:{type:2,format:this.tex.type}},depth:{compare:m,writeEnabled:!0},stencil:{backCompare:519,backPassOp:7681,frontCompare:519,frontPassOp:7681},raster:{cullMode:g}};this.cubePipeline=e.pipeline(t),this.cubeOutlinePipeline=e.pipeline({...t,frag:"\nprecision mediump float;\nuniform vec4 color;\nvoid main () {\n  gl_FragColor = color;\n}\n",uniforms:{mvp:{type:1,format:y},color:{type:1,format:35666}},depth:{writeEnabled:!0},stencil:{backCompare:517,frontCompare:517,writeMask:0}}),this.pass=e.pass({clearDepth:1,clearStencil:0}),this.register(this.pass,this.vertBuffer,this.indexBuffer,this.skyIndexBuffer,this.tex,this.cubePipeline,this.cubeOutlinePipeline)}render(e){const t=be(ge(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),i=ye(ge(),[10*Math.cos(e),5*Math.sin(e),10*Math.sin(e)],[0,0,0],[0,1,0]),n=we(i,t,i),r=this.device.render(this.pass);let s=n;return r.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:s,tex:this.tex}).stencilRef(1).drawIndexed(je.length),s=we(ge(),n,xe(ge(),[1.1,1.1,1.1])),r.pipeline(this.cubeOutlinePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({mvp:s,color:[.1,.3,.25,1]}).stencilRef(1).drawIndexed(je.length),s=we(ge(),n,xe(ge(),[10,10,10])),r.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.skyIndexBuffer).uniforms({mvp:s,tex:this.tex}).drawIndexed(Ne.length).end(),!0}}},pbr:{title:"PBR Uniform Buffer",factory:class extends he{constructor(e){super(),this.device=e,this.loaded=!1}init(){const e=this.device;this.vertBuffer=fe(e,v,We),this.indexBuffer=fe(e,d,Ze),this.cubeTex=e.texture({type:3553,size:[He,He]}),this.matBuffer=fe(e,35345,new Float32Array([1,1,1,1,.2,.5,0,0])),this.envBuffer=fe(e,35345,new Float32Array([223/255*.75,246/255*.75,245/255*.75,1,1,-3,1,0,252/255,203/255,203/255,2]));const t={vert:"#version 300 es\nprecision mediump float;\nuniform mat4 model, viewProj;\nin vec3 position;\nin vec2 uv;\nout vec3 vPosition;\nout vec2 vUv;\nout vec3 vNormal;\n\nvoid main(void) {\n  vec4 worldPos = model * vec4(position, 1.0);\n  vPosition = worldPos.xyz / worldPos.w;\n  vNormal = mat3(model) * normalize(position);\n  vUv = uv;\n  gl_Position = viewProj * worldPos;\n}\n",frag:"#version 300 es\nprecision mediump float;\nuniform sampler2D tex;\nuniform vec3 camPos;\nlayout (std140) uniform material {\n  vec4 albedo;\n  float metallic;\n  float roughness;\n};\nlayout (std140) uniform env {\n  vec4 ambient;\n  vec4 lightDir;\n  vec4 lightColor;\n};\n\nin vec3 vPosition;\nin vec2 vUv;\nin vec3 vNormal;\nout vec4 color;\n\nconst float PI = 3.14159265359;\n\nvec3 toSrgb(vec3 color) {\n  return pow(color, vec3(1.0/2.2));\n}\n\nvec4 toLinear(vec4 srgbIn) {\n  return vec4(pow(srgbIn.rgb, vec3(2.2)), srgbIn.a);\n}\n\nvec3 diffuse(vec3 color) {\n  return color / PI;\n}\n\nfloat specularD(float aSqr, float nDotH) {\n  float f = (nDotH * nDotH) * (aSqr - 1.0) + 1.0;\n  return aSqr / (PI * f * f);\n}\n\nvec3 specularF(vec3 r0, vec3 r90, float vDotH) {\n  return r0 + (r90 - r0) * pow(clamp(1.0 - vDotH, 0.0, 1.0), 5.0);\n}\n\nfloat specularG(float aSqr, float nDotL, float nDotV) {\n  float gl = 2.0 * nDotL / (nDotL + sqrt(aSqr + (1.0 - aSqr) * (nDotL * nDotL)));\n  float gv = 2.0 * nDotV / (nDotV + sqrt(aSqr + (1.0 - aSqr) * (nDotV * nDotV)));\n  return gl * gv;\n}\n\nvoid main () {\n  vec3 n = normalize(vNormal);\n  vec3 v = normalize(camPos - vPosition);\n  vec3 l = normalize(-lightDir.xyz);\n  vec3 h = normalize(l + v);\n\n  float nDotL = clamp(dot(n, l), 0.001, 1.0);\n  float nDotV = clamp(abs(dot(n, v)), 0.001, 1.0);\n  float nDotH = clamp(dot(n, h), 0.0, 1.0);\n  float vDotH = clamp(dot(v, h), 0.0, 1.0);\n\n  vec4 baseColor = toLinear(texture(tex, vUv)) * albedo;\n\n  vec3 f0 = vec3(0.04);\n  vec3 diffuseColor = baseColor.rgb * (vec3(1.0) - f0) * (1.0 - metallic);\n  vec3 specularColor = mix(f0, baseColor.rgb, metallic);\n\n  float r0 = max(max(specularColor.r, specularColor.g), specularColor.b);\n  float r90 = clamp(r0 * 25.0, 0.0, 1.0);\n  vec3 specularEnvR0 = specularColor.rgb;\n  vec3 specularEnvR90 = vec3(1.0, 1.0, 1.0) * r90;\n\n  float a = clamp(roughness, 0.04, 1.0);\n  a *= a;\n  float aSqr = a * a;\n\n  vec3 color0 = vec3(0.0);\n\n  vec3 F = specularF(specularEnvR0, specularEnvR90, vDotH);\n  float D = specularD(aSqr, nDotH);\n  float G = specularG(aSqr, nDotL, nDotV);\n\n  vec3 diffuse = (1.0 - F) * diffuse(diffuseColor);\n  vec3 specular = F * G * D / (4.0 * nDotL * nDotV);\n\n  color0 += nDotL * lightColor.rgb * lightColor.a * (diffuse + specular);\n\n  color0 += ambient.rgb * diffuseColor;\n\n  color = vec4(toSrgb(color0), baseColor.a);\n}\n",buffers:[{attrs:[{name:"position",format:P},{name:"uv",format:w}]}],uniforms:{model:{type:1,format:y},viewProj:{type:1,format:y},tex:{type:2,format:this.cubeTex.type},camPos:{type:1,format:b},material:{type:4},env:{type:4}},depth:{compare:m,writeEnabled:!0},raster:{cullMode:g}};this.cubePipeline=e.pipeline(t),this.skyTex=e.texture({type:34067,size:[He,He]}),this.skyPipeline=e.pipeline({...t,frag:"#version 300 es\nprecision mediump float;\nuniform samplerCube tex;\nin vec3 vNormal;\nout vec4 color;\n\nvoid main () {\n  color = texture(tex, normalize(vNormal));\n}\n",uniforms:{model:{type:1,format:y},viewProj:{type:1,format:y},tex:{type:2,format:this.skyTex.type}},raster:{cullMode:1028}}),this.pass=e.pass({clearDepth:1}),this.loaded=!1,Promise.all([De(),Be(He)]).then((([e,t])=>{this.skyTex.data([t[0],...t,t[0],t[0]]),this.cubeTex.data(e),this.loaded=!0})),this.register(this.pass,this.vertBuffer,this.cubePipeline,this.indexBuffer,this.cubeTex,this.skyPipeline,this.skyTex,this.matBuffer,this.envBuffer)}render(e){if(!this.loaded)return!0;const t=(i=10*Math.cos(e),n=5*Math.sin(e),r=10*Math.sin(e),(s=new me(3))[0]=i,s[1]=n,s[2]=r,s);var i,n,r,s;const o=be(ge(),Math.PI/4,this.device.canvas.width/this.device.canvas.height,.01,100),a=ye(ge(),t,[0,0,0],[0,1,0]),l=we(a,o,a),c=this.device.render(this.pass);return c.pipeline(this.cubePipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({model:ge(),viewProj:l,tex:this.cubeTex,camPos:t,material:{buffer:this.matBuffer},env:{buffer:this.envBuffer}}).drawIndexed(Ze.length),c.pipeline(this.skyPipeline).vertex(0,this.vertBuffer).index(this.indexBuffer).uniforms({model:xe(ge(),[10,10,10]),viewProj:l,tex:this.skyTex}).drawIndexed(Ze.length).end(),!0}}},gltf:{title:"glTF Model Viewer",factory:class{init(){}render(){return window.location.replace("./gltf.html"),!1}destroy(){}}}},Ke=document.getElementById("menu");for(const e in Xe){const t=document.createElement("li"),i=document.createElement("a");i.id=e,i.href=`#${e}`,i.innerText=Xe[e].title,t.appendChild(i),Ke.appendChild(t)}const $e=document.querySelector("canvas"),Je=window.devicePixelRatio||1;if(Je>1){const{width:e,height:t}=$e;$e.width=e*Je,$e.height=t*Je,$e.style.width=`${e}px`,$e.style.height=`${t}px`}const Qe=((e,t)=>{let i=null,n=!1;return t?.webgl2&&(n=!!(i=e.getContext("webgl2",t))),i||(i=e.getContext("webgl",t)||e.getContext("experimental-webgl",t)),i?new le(i,n):null})($e,{stencil:!0,powerPreference:"low-power",webgl2:!0});let Ye,et=0;function tt(e=0){et=requestAnimationFrame(tt),Ye.render(e/1e3)||cancelAnimationFrame(et)}window.loadExample=function(e=location.hash){const t=Xe[e.replace("#","")];t&&(cancelAnimationFrame(et),Ye&&(Ye.destroy(),Qe.reset()),Ye=new t.factory(Qe),Ye.init(),tt())},location.hash=location.hash||"#basic",window.loadExample()})();