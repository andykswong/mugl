(()=>{const e=new Array(16);function t(e,t,n=0,r=0,i=e.length-n){for(let a=0;a<i;++a)t[r+a]=e[n+a];return t}function n(e,t,n){for(let r=0;r<e.length;++r)n[r]=e[r]*t;return n}function r(n,r,i,a){const o=r.length/n,s=i.length/n;let l=0;e.length=o*s;for(let t=0;t<s;++t)for(let a=0;a<o;++a){l=0;for(let e=0;e<n;++e)l+=r[e*o+a]*i[t*n+e];e[t*o+a]=l}return t(e,a,0,0,e.length),a}function i(e,t){let n=0;for(let r=0;r<e.length;++r)n+=e[r]*t[r];return n}function a(e=0,t=0,n=0,r=0){return[e,t,n,r]}function o(e,t,n=a()){return r(4,e,t,n)}function s(e=0,t=0,n=0){return[e,t,n]}function l(e,t,n=s()){return function(e,t,n){for(let r=0;r<e.length;++r)n[r]=e[r]+t[r];return n}(e,t,n)}function c(e,t,n=s()){return function(e,t,n){for(let r=0;r<e.length;++r)n[r]=e[r]-t[r];return n}(e,t,n)}function f(e,t,r=s()){return n(e,t,r)}function u(e){return Math.sqrt(i(e,e))}function d(e,t=s()){return n(e,1/(u(e)||1),t)}function p(e,t,n=s()){const r=e[2]*t[0]-t[2]*e[0],i=e[0]*t[1]-t[0]*e[1];return n[0]=e[1]*t[2]-t[1]*e[2],n[1]=r,n[2]=i,n}s(),a(),a();const g=5123,m=5126,b=7680,h=9728,A=34067,v=33984,y=33071,x=36161,T=33189,O=3315,S=32856,F=32857,w=33190,_=35907,E=34836,M=34842,N=35898,C=36208,U=36214,I=36220,L=36226,P=36232,R=36238,B=36012,k=36013,z=35056,D=33321,G=33323,V=33325,j=33326,W=33327,H=33328,q=33329,$=33330,K=33331,X=33332,J=33333,Z=33334,Q=33335,Y=33336,ee=33337,te=33338,ne=33339,re=33340,ie=36756,ae=36757,oe=36759,se=h,le=9729,ce={1:"EXT_texture_filter_anisotropic",2:"OES_texture_half_float_linear",4:"OES_texture_float_linear",8:"EXT_color_buffer_float"};function fe(e){return 32879===e||35866===e}function ue(e){return 15&e}function de(e){switch(e>>4&511){case 36:return m;case 34:return 5131;case 274:return 5122;case 273:return 5120;case 18:return g;case 17:return 5121}return 0}function pe(e){return!!(e>>13)}function ge(e){switch(e){case D:case ie:case V:case j:return 6403;case $:case q:case X:case K:case Z:case J:return 36244;case G:case ae:case W:case H:return 33319;case Y:case Q:case te:case ee:case re:case ne:return 33320;case S:case _:case oe:case F:case M:case E:return 6408;case I:case R:case U:case C:case P:case L:return 36249;case N:return 6407;case T:case w:case B:return 6402;case z:case k:return 34041}return 0}function me(e){switch(e){case D:case $:case G:case Y:case S:case _:case I:return 5121;case ie:case q:case ae:case Q:case oe:case R:return 5120;case X:case te:case U:return g;case K:case ee:case P:return 5122;case Z:case re:case C:return 5125;case J:case ne:case L:return 5124;case F:return 33640;case V:case W:case M:return 5131;case j:case H:case E:return m;case N:return 35899;case T:return g;case w:return 5125;case z:return 34042;case B:return m;case k:return 36269}return 0}const be=4294967295;let he=null;function Ae(e,t){const n=64&t.usage?35345:16&t.usage?34963:34962,r=8192&t.usage?35040:4096&t.usage?35048:35044,i=e.gl.createBuffer();e.gl.bindBuffer(n,i),e.gl.bufferData(n,t.size,r);const a=e=>{e.deleteBuffer(i)},o={gl:e.gl,glb:i,type:n,size:t.size,destroy(){a(this.gl)}};return he.register(o,{finalizer:a,gl:e.gl}),o}function ve(e,t){const n=t.sampleCount||1,r=t.dimension||3553,i=t.format||S,a=!function(e){switch(e){case T:case w:case z:case B:case k:return!0}return!1}(i)||4&(t.usage||0),[o,s,l]=t.size||[1,1,1],c=r===A?6:3553===r?1:l;let f=null,u=null;(n>1||!a)&&(u=e.gl.createRenderbuffer(),e.gl.bindRenderbuffer(x,u),n>1?e.gl.renderbufferStorageMultisample(x,n,i,o,s):e.gl.renderbufferStorage(x,i,o,s)),a&&(f=e.gl.createTexture(),e.gl.activeTexture(v),e.gl.bindTexture(r,f),fe(r)?e.gl.texStorage3D(r,t.mipLevelCount||1,i,o,s,c):e.gl.texStorage2D(r,t.mipLevelCount||1,i,o,s));const d=e=>{e.deleteTexture(f),e.deleteRenderbuffer(u)},p={gl:e.gl,glt:f,glrb:u,type:r,format:i,width:o,height:s,depth:c,samples:n,destroy(){d(this.gl)}};return he.register(p,{finalizer:d,gl:e.gl}),p}function ye(e,t={}){const n=e.gl.createSampler();let r=t.minFilter||h;t.mipmapFilter&&(r=t.mipmapFilter===h?r===h?9984:9985:r===h?9986:9987),e.gl.samplerParameteri(n,10241,r),e.gl.samplerParameteri(n,10240,t.magFilter||h),e.gl.samplerParameteri(n,10242,t.addressModeU||y),e.gl.samplerParameteri(n,10243,t.addressModeV||y),e.gl.samplerParameteri(n,32882,t.addressModeW||y),e.gl.samplerParameterf(n,33083,t.lodMaxClamp||32),e.gl.samplerParameterf(n,33082,t.lodMinClamp||0),t.compare&&(e.gl.samplerParameterf(n,34892,34894),e.gl.samplerParameterf(n,34893,t.compare)),(t.maxAnisotropy||1)>1&&e.gl.samplerParameterf(n,34046,Math.min(t.maxAnisotropy||1,e.gl.getParameter(34047)));const i=e=>{e.deleteSampler(n)},a={gls:n,gl:e.gl,destroy(){i(this.gl)}};return he.register(a,{finalizer:i,gl:e.gl}),a}function xe(e,t){const n=1===t.usage?35633:35632,r=e.gl.createShader(n);e.gl.shaderSource(r,t.code),e.gl.compileShader(r);const i=e=>{e.deleteShader(r)},a={gl:e.gl,gls:r,destroy(){i(this.gl)}};return he.register(a,{finalizer:i,gl:e.gl}),a}function Te(e,t){return{entries:t.entries.map(((e,t)=>({binding:t,...e}))),destroy(){}}}function Oe(e,t){return{entries:t.entries.map(((e,t)=>({binding:t,...e}))),destroy(){}}}function Se(e,t,n,r=0){e.gl.bindBuffer(t.type,t.glb),e.gl.bufferSubData(t.type,r,n)}function Fe(e,{texture:t,mipLevel:n=0,origin:[r,i,a]=[0,0,0]},o,{offset:s=0,bytesPerRow:l,rowsPerImage:c=0},[f,u,d]=[t.width-r,t.height-i,t.depth-a]){const p=ge(t.format),g=me(t.format),m=t.type===A,b=m?34069+a:t.type;e.gl.activeTexture(v),e.gl.bindTexture(t.type,t.glt);const h=function(e){switch(e){case D:case $:case ie:case q:return 1;case X:case K:case G:case Y:case ae:case Q:case V:return 2;case Z:case J:case j:case te:case ee:case W:case S:case _:case I:case oe:case R:case F:case N:return 4;case re:case ne:case H:case U:case P:case M:return 8;case C:case L:case E:return 16;case T:return 2;case w:case z:case B:return 4;case k:return 8}return 0}(t.format),y=c||u,x=Math.floor(l/h),se=s-s%l;if(e.gl.pixelStorei(32878,y),e.gl.pixelStorei(3314,x),e.gl.pixelStorei(3316,Math.floor(s%l/h)),e.gl.pixelStorei(O,0),e.gl.pixelStorei(32877,0),fe(t.type))e.gl.texSubImage3D(b,n,r,i,a,f,u,d,t.format,g,o,se);else if(m)for(let t=a;t<a+d;++t)e.gl.pixelStorei(O,t*x*y),e.gl.texSubImage2D(b+t,n,r,i,f,u,p,g,o,se);else e.gl.texSubImage2D(b,n,r,i,f,u,p,g,o,se)}function we(e,t,n,r=0){const i=e.state.buffers[t];!i||i.glb===n.glb&&i.offset===r||(i.glb=n.glb,i.offset=r,i.instanceOffset=0,Pe(e.gl,i,r))}function _e(e,t,n,r=[]){if(e.state.pipeline)for(let i=0,a=0;i<n.entries.length;++i){const o=n.entries[i],s=e.state.pipeline.cache[t]&&e.state.pipeline.cache[t][o.binding];if(s)if(o.buffer){let t=o.bufferOffset||0;s.bufferDynamicOffset&&(t+=r[a]||0,++a),e.gl.bindBufferRange(35345,s.slot,o.buffer.glb,t,o.bufferSize||o.buffer.size-t)}else o.texture?(e.gl.activeTexture(v+s.slot),e.gl.bindTexture(o.texture.type,o.texture.glt),e.gl.uniform1i(s.loc,s.slot)):o.sampler&&e.gl.bindSampler(s.slot,o.sampler.gls)}}function Ee(e,t,n,r,i,a=36064){e.bindFramebuffer(36008,t),e.bindFramebuffer(36009,n),e.readBuffer(a),e.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,i,h)}function Me(e={}){const t=e.primitive||{},n=e.depthStencil||{},{stencilFront:r={},stencilBack:i={}}=n,{sampleCount:a=1,alphaToCoverage:o=!1}=e.multisample||{},s=e.targets||{};let l=s.writeMask||15,c=s.blendColor||{},f=s.blendColor||{};return s.targets&&s.targets[0]&&(l=s.targets[0].writeMask||l,c=s.targets[0].blendColor||c,f=s.targets[0].blendAlpha||f),{sampleCount:a,alphaToCoverage:o,topology:t.topology||4,indexFormat:t.indexFormat||g,frontFace:t.frontFace||2305,cullMode:t.cullMode||0,depth:!!e.depthStencil,depthWrite:n.depthWrite||!1,depthFormat:n.format||T,depthCompare:n.depthCompare||519,depthBias:n.depthBias||0,depthBiasSlopeScale:n.depthBiasSlopeScale||0,stencil:!(!n.stencilFront&&!n.stencilBack),stencilFrontCompare:r.compare||519,stencilFrontFailOp:r.failOp||b,stencilFrontDepthFailOp:r.depthFailOp||b,stencilFrontPassOp:r.passOp||b,stencilBackCompare:i.compare||519,stencilBackFailOp:i.failOp||b,stencilBackDepthFailOp:i.depthFailOp||b,stencilBackPassOp:i.passOp||b,stencilReadMask:n.stencilReadMask||be,stencilWriteMask:n.stencilWriteMask||be,blend:!!e.targets,blendWriteMask:l,blendColorOp:c.operation||32774,blendColorSrcFactor:c.srcFactor||1,blendColorDstFactor:c.dstFactor||0,blendAlphaOp:f.operation||32774,blendAlphaSrcFactor:f.srcFactor||1,blendAlphaDstFactor:f.dstFactor||0}}function Ne(e,t,n,r=0,i=!1){let a=!1,o=0,s=0,l=0,c=0;o=n.frontFace,(i||t.frontFace!==o)&&e.frontFace(o),o=n.cullMode,(i||t.cullMode!==o)&&((a=0!==o)&&e.cullFace(o),Le(e,2884,a)),a=n.alphaToCoverage,(i||t.alphaToCoverage!==a)&&Le(e,32926,a),a=!!n.depth,(i||t.depth!==a)&&Le(e,2929,a),(i||a)&&(Ue(e,t.depthWrite,n.depthWrite,i),o=n.depthCompare,(i||t.depthCompare!==o)&&e.depthFunc(o)),o=n.depthBiasSlopeScale,s=n.depthBias,(i||t.depthBiasSlopeScale!==o||t.depthBias!==s)&&(Le(e,32823,!(!o&&!s)),e.polygonOffset(o,s)),a=!!n.stencil,(i||t.stencil!==a)&&Le(e,2960,a),(i||a)&&(o=n.stencilReadMask,a=i||t.stencilReadMask!==o,s=n.stencilFrontCompare,(a||t.stencilFrontCompare!==s)&&e.stencilFuncSeparate(1028,s,r,o),s=n.stencilBackCompare,(a||t.stencilBackCompare!==s)&&e.stencilFuncSeparate(1029,s,r,o),o=n.stencilFrontFailOp,s=n.stencilFrontDepthFailOp,l=n.stencilFrontPassOp,(i||t.stencilFrontFailOp!==o||t.stencilFrontDepthFailOp!==s||t.stencilFrontPassOp!==l)&&e.stencilOpSeparate(1028,o,s,l),o=n.stencilBackFailOp,s=n.stencilBackDepthFailOp,l=n.stencilBackPassOp,(i||t.stencilBackFailOp!==o||t.stencilBackDepthFailOp!==s||t.stencilBackPassOp!==l)&&e.stencilOpSeparate(1029,o,s,l),Ie(e,t.stencilWriteMask,n.stencilWriteMask,i)),a=n.blend,(i||t.blend!==a)&&Le(e,3042,a),(i||a)&&(o=n.blendColorSrcFactor,s=n.blendColorDstFactor,l=n.blendAlphaSrcFactor,c=n.blendAlphaDstFactor,(i||t.blendColorSrcFactor!==o||t.blendColorDstFactor!==s||t.blendAlphaSrcFactor!==l||t.blendAlphaDstFactor!==c)&&e.blendFuncSeparate(o,s,l,c),o=n.blendColorOp,s=n.blendAlphaOp,(i||t.blendColorOp!==o||t.blendAlphaOp!==s)&&e.blendEquationSeparate(o,s),Ce(e,t.blendWriteMask,n.blendWriteMask,i))}function Ce(e,t,n,r=!1){(r||t!==n)&&e.colorMask(!!(1&n),!!(2&n),!!(4&n),!!(8&n))}function Ue(e,t,n,r=!1){(r||t!==n)&&e.depthMask(n)}function Ie(e,t,n,r=!1){(r||t!==n)&&e.stencilMask(n)}function Le(e,t,n){n?e.enable(t):e.disable(t)}function Pe(e,t,n){e.bindBuffer(34962,t.glb);for(let r=0;r<t.attributes.length;++r){const{ptr:i,step:a}=t.attributes[r],o=[...i];o[5]+=n,e.vertexAttribPointer(...o),e.vertexAttribDivisor(i[0],a)}}he=new FinalizationRegistry((({finalizer:e,gl:t})=>{e(t)}));const Re=[1,0,0,0,1,0,0,0,1],Be=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function ke(e){for(let t=0;t<16;++t)e[t]=t%5?0:1;return e}function ze(e,t,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){return r(4,e,t,n)}function De(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const r=e[0]*e[5]-e[4]*e[1],i=e[0]*e[9]-e[8]*e[1],a=e[0]*e[13]-e[12]*e[1],o=e[4]*e[9]-e[8]*e[5],s=e[4]*e[13]-e[12]*e[5],l=e[8]*e[13]-e[12]*e[9],c=e[2]*e[7]-e[6]*e[3],f=e[2]*e[11]-e[10]*e[3],u=e[2]*e[15]-e[14]*e[3],d=e[6]*e[11]-e[10]*e[7],p=e[6]*e[15]-e[14]*e[7],g=e[10]*e[15]-e[14]*e[11],m=r*g-i*p+a*d+o*u-s*f+l*c;return m?(Be[0]=+e[5]*g-e[9]*p+e[13]*d,Be[1]=-e[1]*g+e[9]*u-e[13]*f,Be[2]=+e[1]*p-e[5]*u+e[13]*c,Be[3]=-e[1]*d+e[5]*f-e[9]*c,Be[4]=-e[4]*g+e[8]*p-e[12]*d,Be[5]=+e[0]*g-e[8]*u+e[12]*f,Be[6]=-e[0]*p+e[4]*u-e[12]*c,Be[7]=+e[0]*d-e[4]*f+e[8]*c,Be[8]=+e[7]*l-e[11]*s+e[15]*o,Be[9]=-e[3]*l+e[11]*a-e[15]*i,Be[10]=+e[3]*s-e[7]*a+e[15]*r,Be[11]=-e[3]*o+e[7]*i-e[11]*r,Be[12]=-e[6]*l+e[10]*s-e[14]*o,Be[13]=+e[2]*l-e[10]*a+e[14]*i,Be[14]=-e[2]*s+e[6]*a-e[14]*r,Be[15]=+e[2]*o-e[6]*i+e[10]*r,function(e,t,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){return n(e,t,r)}(Be,1/m,t)):null}const Ge=i;function Ve(e,t,n,r=[0,0,0,1]){let i=Ge(e,t),a=1;i<0&&(i*=-1,a=-1);let o=1-n,s=n;if(1-i>1e-6){const e=Math.acos(i),t=Math.sin(e);o=Math.sin((1-n)*e)/t,s=Math.sin(n*e)/t}return s*=a,r[0]=e[0]*o+t[0]*s,r[1]=e[1]*o+t[1]*s,r[2]=e[2]*o+t[2]*s,r[3]=e[3]*o+t[3]*s,r}const je=s(),We=s(),He=s();function qe(e,t,n,r=1/0,i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const a=1/Math.tan(t/2);if(ke(i),i[0]=a/e,i[5]=a,i[11]=-1,i[15]=0,isFinite(r)){const e=1/(n-r);i[10]=(n+r)*e,i[14]=2*n*r*e}else i[10]=-1,i[14]=-2*n;return i}function $e(e,n,r=s(0,1,0),i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const a=c(e,n,je);d(a,a);const o=p(r,a,We);d(o,o);const l=p(a,o,He);return d(l,l),t(o,i,0,0,3),t(l,i,0,4,3),t(a,i,0,8,3),t(e,i,0,12,3),i[3]=i[7]=i[11]=0,i[15]=1,i}const Ke=5121,Xe=5123,Je=5126;function Ze(e){return e.extras||(e.extras={}),e.extras}function Qe(e,t){let n=Ze(t).input||null;if(!n){const r=e.accessors?.[t.input];if(r){const{buffer:i,byteOffset:a=0}=tt(e,r);Ze(t).input=n=new Float32Array(i.buffer,a+i.byteOffset,(i.byteLength-a)/4)}}return n}function Ye(e,t){let n=Ze(t).output||null;if(!n){const r=e.accessors?.[t.output];if(r){const{buffer:i,byteOffset:a=0}=tt(e,r);let o=Float32Array;switch(r.componentType){case 5120:o=Int8Array;break;case Ke:o=Uint8Array;break;case 5122:case Xe:o=Uint16Array}Ze(t).output=n=new o(i.buffer,a+i.byteOffset,(i.byteLength-a)/o.BYTES_PER_ELEMENT)}}return n}function et(e){switch(e.type){case"VEC2":if(e.componentType===Je)return 578;if(e.componentType===Xe)return e.normalized?8482:290;if(e.componentType===Ke)return e.normalized?8466:274;break;case"VEC3":if(e.componentType===Je)return 579;break;case"VEC4":if(e.componentType===Je)return 580;if(e.componentType===Xe)return e.normalized?8484:292;if(e.componentType===Ke)return e.normalized?8468:276}return null}function tt(e,t){let n=Ze(t).buffer,r=Ze(t).byteOffset||0;if(n)return{buffer:n,byteOffset:r};const i=function(e){let t=0;switch(e.type){case"SCALAR":t=1;break;case"VEC2":t=2;break;case"VEC3":t=3;break;case"VEC4":case"MAT2":t=4;break;case"MAT3":t=9;break;case"MAT4":t=16}let n=0;switch(e.componentType){case 5120:case Ke:n=1;break;case 5122:case Xe:n=2;break;case 5125:case Je:n=4}return t*n}(t);let a=t.count*i;const o=e.bufferViews?.[t.bufferView];if(o){const s=nt(e,o),l=o.byteStride||1;r=(t.byteOffset||0)%l,a=t.count*(o.byteStride||i);const c=(t.byteOffset||0)-r;n=new Uint8Array(s.buffer,s.byteOffset+c,a)}if(t.sparse){const{count:o,indices:{bufferView:s,byteOffset:l=0,componentType:c},values:{bufferView:f,byteOffset:u=0}}=t.sparse,d=e.bufferViews?.[s],p=e.bufferViews?.[f];if(d&&p){const t=new Uint8Array(a);n&&t.set(n,r);const s=nt(e,d),f=nt(e,p),g=new(c===Ke?Uint8Array:c===Xe?Uint16Array:Uint32Array)(s.buffer,s.byteOffset+l,o),m=new Uint8Array(f.buffer,f.byteOffset+u,o*i);for(let e=0;e<o;++e){const n=g[e]*i;for(let r=0;r<i;++r)t[n+r]=m[e*i+r]}r=0,n=t}}return n?(Ze(t).buffer=n,Ze(t).byteOffset=r):n=new Uint8Array,{buffer:n,byteOffset:r}}function nt(e,t){let n=Ze(t).buffer;if(!n){const r=e.buffers?.[t.buffer];if(r){const e=r.extras.buffer;n=new Uint8Array(e.buffer,e.byteOffset+(t.byteOffset||0),t.byteLength)}else n=new Uint8Array;Ze(t).buffer=n}return n}const rt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],it=[0,0,0,1],at=s(1,1,1),ot=s();function st(e,n,r,i=null){const a=e.nodes?.[n];if(!a)return;i?.push(n);const o=Ze(a),s=o.matrix=o.matrix||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a.matrix?function(e,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){t(e,n)}(a.matrix,s):(a.rotation||a.scale||a.translation||o.rotation||o.scale||o.translation)&&function(e,n,r,i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){!function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){!function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const n=e[0]*e[0],r=e[0]*e[1],i=e[0]*e[2],a=e[1]*e[1],o=e[1]*e[2],s=e[2]*e[2],l=e[3]*e[0],c=e[3]*e[1],f=e[3]*e[2];t[0]=1-2*(a+s),t[1]=2*(r+f),t[2]=2*(i-c),t[4]=2*(r-f),t[5]=1-2*(n+s),t[6]=2*(o+l),t[8]=2*(i+c),t[9]=2*(o-l),t[10]=1-2*(n+a),t[3]=t[7]=t[11]=t[12]=t[13]=t[14]=0,t[15]=1}(e,t)}(n,i);for(let e=0;e<3;++e)for(let t=0;t<3;++t)i[4*e+t]*=r[e];t(e,i,0,12,3)}(o.translation||a.translation||ot,o.rotation||a.rotation||it,o.scale||a.scale||at,s);const l=o.model=ze(r,s,o.model||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);if(a.children)for(const t of a.children)st(e,t,l,i)}function lt(e,t){const n=e.cameras?.[t.camera];if(n){const e=Ze(t).model=Ze(t).model||rt;Ze(n).view=De(e,Ze(n).view||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Ze(n).translation=[e[12],e[13],e[14]]}}function ct(e,t){const n=e.skins?.[t.skin];if(n){const r=n.joints.length,i=Ze(t).jointMatrix=Ze(t).jointMatrix||new Float32Array(16*r),a=function(e,t){let n=Ze(t).inverseBindMatrices;if(!n){const r=e.accessors?.[t.inverseBindMatrices];if(r){const{buffer:i,byteOffset:a}=tt(e,r);n=new Float32Array(i.buffer,i.byteOffset+a,16*t.joints.length)}else n=new Float32Array(16*t.joints.length);Ze(t).inverseBindMatrices=n}return n}(e,n);for(let o=0;o<r;++o){const r=e.nodes[n.joints[o]],s=new Float32Array(i.buffer,i.byteOffset+64*o,16),l=new Float32Array(a.buffer,a.byteOffset+64*o,16);De(Ze(t).model||rt,s),ze(s,r&&Ze(r).model||rt,s),ze(s,l,s)}}}const ft=["POSITION","NORMAL","TANGENT","TEXCOORD_0","TEXCOORD_1","COLOR_0","JOINTS_0","WEIGHTS_0"],ut=["POSITION","NORMAL","TANGENT"],dt=[8,12,14],pt=/(POSITION|NORMAL|TANGENT)_(\d+)/,gt={addressModeU:10497,addressModeV:10497,magFilter:le,minFilter:le},mt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],bt=s(),ht=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function At(e,n,r,i,a){let o=!1,s=0,l=n.accessors?.[a.attributes.POSITION]?.count||0;if(!l)return;const c=function(e,t,n){let r=Ze(n).pipeline;if(r)return r;const i=n.mode||4,a=t.materials?.[n.material];let o="OPAQUE",s=!1,l=!1;a&&(s=a.doubleSided||!1,o=a.alphaMode||o,l=!!a.extensions?.KHR_materials_unlit);const c=vt(t,n),f=5125===t.accessors?.[n.indices]?.componentType?5125:5123,u=JSON.stringify([c,s,o,f,i,l]),d=Ze(t).pipelines=Ze(t).pipelines||{};if(r=d[u],r)return r;const p=[`ALPHAMODE_${o}`];for(const e of c)for(const t of e.attributes)p.push(`USE_${t.name}`),"COLOR_0"===t.name&&579===t.format&&p.push("COLOR_0_VEC3");l&&p.push("MATERIAL_UNLIT");const g=p.map((e=>`#define ${e}\n`)).join(""),m="#version 300 es\n",b=m+g+"#version 300 es\nprecision highp float;\nlayout(std140)uniform Model{mat4 A,B,C;vec4 D;};layout(std140)uniform Morph{vec4 E[2];};uniform sampler2D jointTexture;layout(location=0)in vec3 F;out vec3 vPosition;out vec2 vTexCoord0,vTexCoord1;\n#ifdef USE_NORMAL\nlayout(location=1)in vec3 G;\n#ifdef USE_TANGENT\nlayout(location=2)in vec4 H;out mat3 vTBN;\n#else\nout vec3 vNormal;\n#endif\n#endif \n#ifdef USE_TEXCOORD_0\nlayout(location=3)in vec2 I;\n#endif\n#ifdef USE_TEXCOORD_1\nlayout(location=4)in vec2 J;\n#endif\n#ifdef USE_COLOR_0\nout vec4 vColor0;\n#if defined(COLOR_0_VEC3)\nlayout(location=5)in vec3 K;\n#else\nlayout(location=5)in vec4 K;\n#endif\n#endif \n#if defined(USE_WEIGHTS_0) && defined(USE_JOINTS_0)\n#define USE_SKIN \nlayout(location=6)in vec4 L;layout(location=7)in vec4 M;mat4 N(int O){return mat4(texelFetch(jointTexture,ivec2(0,O),0),texelFetch(jointTexture,ivec2(1,O),0),texelFetch(jointTexture,ivec2(2,O),0),texelFetch(jointTexture,ivec2(3,O),0));}mat4 P(){mat4 Q=M.x*N(int(L.x))+M.y*N(int(L.y))+M.z*N(int(L.z))+M.w*N(int(L.w));return Q;}\n#endif \n#if defined(USE_POSITION_0)\n#define USE_MORPH \n#ifdef USE_POSITION_0\nlayout(location=8)in vec3 R;\n#endif\n#ifdef USE_POSITION_1\nlayout(location=9)in vec3 S;\n#endif\n#if !defined(USE_TANGENT_0)\n#ifdef USE_POSITION_2\nlayout(location=10)in vec3 T;\n#endif\n#ifdef USE_POSITION_3\nlayout(location=11)in vec3 U;\n#endif\n#if !defined(USE_NORMAL_0)\n#ifdef USE_POSITION_4\nlayout(location=12)in vec3 V;\n#endif\n#ifdef USE_POSITION_5\nlayout(location=13)in vec3 W;\n#endif\n#ifdef USE_POSITION_6\nlayout(location=14)in vec3 X;\n#endif\n#ifdef USE_POSITION_7\nlayout(location=15)in vec3 Y;\n#endif\n#endif \n#endif \n#ifdef USE_NORMAL_0\nlayout(location=12)in vec3 Z;\n#endif\n#ifdef USE_NORMAL_1\nlayout(location=13)in vec3 a;\n#endif\n#if !defined(USE_TANGENT_0)\n#ifdef USE_NORMAL_2\nlayout(location=14)in vec3 b;\n#endif\n#ifdef USE_NORMAL_3\nlayout(location=15)in vec3 c;\n#endif\n#endif \n#ifdef USE_TANGENT_0\nlayout(location=14)in vec3 d;\n#endif\n#ifdef USE_TANGENT_1\nlayout(location=15)in vec3 e;\n#endif\nvec3 f(){vec3 g=vec3(0.);\n#ifdef USE_POSITION_0\ng+=E[0].x*R;\n#endif\n#ifdef USE_POSITION_1\ng+=E[0].y*S;\n#endif\n#ifdef USE_POSITION_2\ng+=E[0].z*T;\n#endif\n#ifdef USE_POSITION_3\ng+=E[0].w*U;\n#endif\n#ifdef USE_POSITION_4\ng+=E[1].x*V;\n#endif\n#ifdef USE_POSITION_5\ng+=E[1].y*W;\n#endif\n#ifdef USE_POSITION_6\ng+=E[1].z*X;\n#endif\n#ifdef USE_POSITION_7\ng+=E[1].w*Y;\n#endif\nreturn g;}vec3 h(){vec3 g=vec3(0.);\n#ifdef USE_NORMAL_0\ng+=E[0].x*Z;\n#endif\n#ifdef USE_NORMAL_1\ng+=E[0].y*a;\n#endif\n#ifdef USE_NORMAL_2\ng+=E[0].z*b;\n#endif\n#ifdef USE_NORMAL_3\ng+=E[0].w*c;\n#endif\nreturn g;}vec3 i(){vec3 g=vec3(0.);\n#ifdef USE_TANGENT_0\ng+=E[0].x*d;\n#endif\n#ifdef USE_TANGENT_1\ng+=E[0].y*e;\n#endif\nreturn g;}\n#endif \nvec4 j(){vec4 k=vec4(F,1.);\n#ifdef USE_MORPH\nk+=vec4(f(),0.);\n#endif\n#ifdef USE_SKIN\nk=P()*k;\n#endif\nreturn k;}\n#ifdef USE_NORMAL\nvec3 l(){vec3 m=G;\n#ifdef USE_MORPH\nm+=h();\n#endif\n#ifdef USE_SKIN\nm=mat3(P())*m;\n#endif\nreturn normalize(m);}\n#ifdef USE_TANGENT\nvec3 n(){vec3 tan=H.xyz;\n#ifdef USE_MORPH\ntan+=i();\n#endif\n#ifdef USE_SKIN\ntan=mat3(P())*tan;\n#endif\nreturn normalize(tan);}\n#endif \n#endif \nvoid main(){vec4 k=A*j();vPosition=k.xyz/k.w;\n#ifdef USE_NORMAL\nmat3 o=mat3(B);\n#ifdef USE_TANGENT\nvec3 tan=n();vec3 p=normalize(o*l());vec3 q=normalize(o*tan);vec3 r=cross(p,q)*H.w;vTBN=mat3(q,r,p);\n#else\nvNormal=normalize(o*G);\n#endif \n#endif \n#ifdef USE_COLOR_0\n#if defined(COLOR_0_VEC3)\nvColor0=vec4(K,1.);\n#else\nvColor0=K;\n#endif\n#endif \nvTexCoord0=vec2(0.);vTexCoord1=vec2(0.);\n#ifdef USE_TEXCOORD_0\nvTexCoord0=I;\n#endif\n#ifdef USE_TEXCOORD_1\nvTexCoord1=J;\n#endif\ngl_Position=C*k;gl_PointSize=1.;}".replace(m,""),h=m+g+"#version 300 es\nprecision highp float;\nlayout(std140)uniform Model{mat4 A,B,C;vec4 D;};layout(std140)uniform Morph{vec4 E[2];};layout(std140)uniform Material{vec4 F;float G,H;float I,J;float K,L;float M,N;vec4 O;float P;};uniform sampler2D baseColorTexture;uniform sampler2D metallicRoughnessTexture;uniform sampler2D normalTexture;uniform sampler2D occlusionTexture;uniform sampler2D emissiveTexture;in vec3 vPosition;in vec2 vTexCoord0,vTexCoord1;\n#ifdef USE_COLOR_0\nin vec4 vColor0;\n#endif\n#ifdef USE_NORMAL\n#ifdef USE_TANGENT\nin mat3 vTBN;\n#else\nin vec3 vNormal;\n#endif\n#endif\nout vec4 fragColor;const float Q=2.2;const float R=3.141592653589793;vec3 S(vec3 T){return pow(T,vec3(1./Q));}vec2 U(float V){return mix(vTexCoord0,vTexCoord1,step(1.,V));}vec4 W(sampler2D X,float V){return texture(X,U(V));}vec4 W(sampler2D X,float V,vec4 Y){return mix(Y,texture(X,U(V)),step(0.,V));}vec3 Z(vec3 a,vec3 b,float c){return a+(b-a)*pow(clamp(1.-c,0.,1.),5.);}float d(float e,float f){float g=(f*f)*(e-1.)+1.;return e/(R*g*g);}float h(float e,float i,float j){float k=1./(i+sqrt(e+(1.-e)*(i*i)));float l=1./(j+sqrt(e+(1.-e)*(j*j)));return k*l;}float m(float e,float i,float j,float f){return h(e,i,j)*d(e,f);}vec3 n(vec3 T){return T/R;}vec4 o(){vec4 T=vec4(1.);\n#ifdef USE_COLOR_0\nT=vColor0;\n#endif\nreturn T;}vec4 p(){vec4 q=vec4(1.);q*=F;q*=W(baseColorTexture,I,vec4(1.));return q*o();}vec2 r(){vec4 s=W(metallicRoughnessTexture,J,vec4(1.));return vec2(clamp(G*s.b,0.,1.),clamp(H*s.g,.04,1.));}float t(){return W(occlusionTexture,N,vec4(1.)).r;}vec3 u(){return O.xyz*W(emissiveTexture,O.w,vec4(1.)).xyz;}struct v{vec3 ng;vec3 nn;vec3 t;vec3 b;};v w(vec3 x){vec3 y,t,b,ng;\n#ifdef USE_TANGENT\nt=normalize(vTBN[0]);b=normalize(vTBN[1]);ng=normalize(vTBN[2]);\n#else\n#ifdef USE_NORMAL\nng=normalize(vNormal);\n#else\nng=normalize(cross(dFdx(x),dFdy(x)));\n#endif\nvec2 z=U(L);vec3 AA=dFdx(vec3(z,0.));vec3 AB=dFdy(vec3(z,0.));vec3 AC=(AB.t*dFdx(x)-AA.t*dFdy(x))/(AA.s*AB.t-AB.s*AA.t);t=normalize(AC-ng*dot(ng,AC));b=cross(ng,t);\n#endif\nif(gl_FrontFacing==false){t*=-1.;b*=-1.;ng*=-1.;}y=ng;if(L>=0.){y=W(normalTexture,L).rgb*2.-vec3(1.);y*=vec3(K,K,1.);y=mat3(t,b,ng)*normalize(y);}v AD;AD.ng=ng;AD.t=t;AD.b=b;AD.nn=y;return AD;}\n#define LIGHT_DIRECTIONAL  0\n#define LIGHT_POINT  1\n#define LIGHT_SPOT  2\nint AE(mat4 AF){return int(AF[0].x);}vec2 AG(mat4 AF){return AF[0].zw;}vec4 AH(mat4 AF){return AF[1];}float AI(mat4 AF){return AF[2].w;}vec3 AJ(mat4 AF){return AF[2].xyz;}vec3 AK(mat4 AF){return AF[3].xyz;}float AL(float AM,float AN){if(AM<=0.){return 1./pow(AN,2.);}return max(min(1.-pow(AN/AM,4.),1.),0.)/pow(AN,2.);}float AO(vec3 AP,vec3 AQ,vec2 AR){float AS=dot(normalize(AQ),normalize(-AP));float AT=1./max(.001,AR[0]-AR[1]);float AU=-AR[1]*AT;float AV=clamp(AS*AT+AU,0.,1.);return AV*AV;}vec3 AW(mat4 AF,vec3 AX){return AE(AF)!=LIGHT_DIRECTIONAL?AK(AF)-AX:-AJ(AF);}vec3 AY(mat4 AF,vec3 AP){vec4 T=AH(AF);vec3 AZ=T.rgb*T.a;if(AE(AF)!=LIGHT_DIRECTIONAL){AZ*=AL(AI(AF),length(AP));}if(AE(AF)==LIGHT_SPOT){AZ*=AO(AP,AJ(AF),AG(AF));}return AZ;}void main(){vec4 q=p();\n#ifdef ALPHAMODE_OPAQUE\nq.a=1.;\n#endif\n#ifdef MATERIAL_UNLIT\ngl_FragColor=(vec4(S(q.rgb),q.a));return;\n#endif\nvec3 x=normalize(D.xyz-vPosition);v Aa=w(vPosition);vec3 y=Aa.nn;vec3 Ab=-normalize(reflect(x,y));float j=clamp(abs(dot(y,x)),0.001,1.);vec2 Ac=r();float Ad=Ac[0];float Ae=Ac[1];float Af=Ae*Ae;float e=Af*Af;vec3 Ag=vec3(0.04);vec3 Ah=q.rgb*(vec3(1.)-Ag)*(1.-Ad);vec3 Ai=mix(Ag,q.rgb,Ad);float a=max(max(Ai.r,Ai.g),Ai.b);float b=clamp(a*25.,0.,1.);vec3 Aj=Ai.rgb;vec3 Ak=vec3(1.,1.,1.)*b;vec3 Al=vec3(0.);vec3 Am=vec3(0.);\n#define NUM_LIGHTS  4\nmat4 An[4];An[0]=mat4(0.,0.,0.,0.,1.,1.,1.,1.,.5,-.707,-.5,0.,0.,0.,0.,0.);An[1]=mat4(0.,0.,0.,0.,1.,1.,1.,.75,-.5,.707,.5,0.,0.,0.,0.,0.);An[2]=mat4(0.,0.,0.,0.,1.,1.,1.,.75,.5,.707,-.5,0.,0.,0.,0.,0.);An[3]=mat4(0.,0.,0.,0.,1.,1.,1.,.75,-.5,-.707,.5,0.,0.,0.,0.,0.);\n#ifdef NUM_LIGHTS\nfor(int Ao=0;Ao<NUM_LIGHTS;++Ao){vec3 AP=AW(An[Ao],vPosition);vec3 AZ=AY(An[Ao],AP);vec3 Ap=normalize(AP);vec3 Aq=normalize(Ap+x);float i=clamp(dot(y,Ap),0.001,1.);float f=clamp(dot(y,Aq),0.,1.);float c=clamp(dot(x,Aq),0.,1.);vec3 Ar=Z(Aj,Ak,c);vec3 As=(1.-Ar)*n(Ah);vec3 At=max(vec3(0.),Ar*m(e,i,j,f));Al+=AZ*i*As;Am+=AZ*i*At;}\n#endif\nvec4 Au=vec4(.1);vec3 Av=Au.rgb*n(Ah);Al+=Av;vec3 Aw=Al+Am;float Ax=t();Aw=mix(Aw,Aw*Ax,M);vec3 Ay=u();Aw+=Ay;\n#ifdef ALPHAMODE_MASK\nif(q.a<P){discard;}q.a=1.;\n#endif\nfragColor=vec4(S(Aw),q.a);}".replace(m,""),A=xe(e,{usage:1,code:b}),v=xe(e,{usage:2,code:h});return r=Ze(n).pipeline=d[u]=function(e,t){const n=function(e,t,n){const r=e.gl.createProgram();return e.gl.attachShader(r,t),e.gl.attachShader(r,n),e.gl.linkProgram(r),r}(e,t.vertex.gls,t.fragment.gls),r=[],i={};let a=0,o=0;if(t.bindGroups){for(let s=0;s<t.bindGroups.length;++s){const l=t.bindGroups[s].entries;r.push([]);for(let t=0;t<l.length;++t){const c=l[t];let f=null,u=4294967295;0===c.type?(u=e.gl.getUniformBlockIndex(n,c.label),e.gl.uniformBlockBinding(n,u,a++)):2===c.type&&(f=e.gl.getUniformLocation(n,c.label),i[c.label]=o++),r[s][c.binding]={...c,loc:f,index:u,slot:0===c.type?a-1:2===c.type?o-1:0}}}for(let e=0;e<t.bindGroups.length;++e){const n=t.bindGroups[e].entries;for(let t=0;t<n.length;++t)1===n[t].type&&i[n[t].label]&&(r[e][n[t].binding].slot=i[n[t].label])}}const s=e=>{e.deleteProgram(n)},l={gl:e.gl,glp:n,buffers:t.buffers,cache:r,state:Me(t),destroy(){s(this.gl)}};return he.register(l,{finalizer:s,gl:e.gl}),l}(e,{vertex:A,fragment:v,buffers:c,bindGroups:[wt(0,t),Ft(0,t)],primitive:{indexFormat:f,topology:i,cullMode:s?0:1029},depthStencil:{depthCompare:515,depthWrite:!("BLEND"===o)},targets:"BLEND"===o?{blendColor:{srcFactor:770,dstFactor:771},blendAlpha:{srcFactor:1,dstFactor:771}}:null}),A.destroy(),v.destroy(),r}(e,n,a);!function(e,t){if(e.state.pipeline===t)return;e.state.pipeline&&e.state.pipeline.glp===t.glp||e.gl.useProgram(t.glp),Ne(e.gl,e.state.state,t.state,e.state.stencilRef),Object.assign(e.state.state,t.state);const n=[];for(const{attributes:t}of e.state.buffers)for(const{ptr:e}of t)n[e[0]]=1;e.state.buffers=Array(t.buffers.length);for(let r=0;r<t.buffers.length;++r){const{attributes:i,stride:a,stepMode:o=0}=t.buffers[r],s=[];e.state.buffers[r]={glb:null,attributes:s,stride:a,step:o,offset:0,instanceOffset:0};for(const{format:e,offset:t,shaderLocation:l}of i)n[l]=(n[l]||0)+2,s.push({buffer:r,ptr:[l,ue(e),de(e),pe(e),a,t],step:o})}for(let t=0;t<n.length;++t)2===n[t]?e.gl.enableVertexAttribArray(t):1===n[t]&&e.gl.disableVertexAttribArray(t);e.state.pipeline=t}(e,c),_e(e,0,function(e,n,r){const i=n.materials?.[r];if(i&&Ze(i).bindGroup)return Ze(i).bindGroup;if(!i&&Ze(n).defaultMaterialBindGroup)return Ze(n).defaultMaterialBindGroup;const a=new Float32Array(20);a[0]=a[1]=a[2]=a[3]=1,a[4]=1,a[5]=1,a[6]=a[7]=a[9]=a[11]=a[15]=-1,a[8]=1,a[10]=0,a[12]=a[13]=a[14]=0,a[16]=.5;const o=Ae(e,{usage:64,size:a.byteLength});i&&(Ze(i).gpuBuffer=o);const s=[{binding:0,buffer:o},{binding:1,texture:Ot(e,n)},{binding:2,sampler:St(e,n)},{binding:3,texture:Ot(e,n)},{binding:4,sampler:St(e,n)},{binding:5,texture:Ot(e,n)},{binding:6,sampler:St(e,n)},{binding:7,texture:Ot(e,n)},{binding:8,sampler:St(e,n)},{binding:9,texture:Ot(e,n)},{binding:10,sampler:St(e,n)}];if(i){if(i.pbrMetallicRoughness){const r=i.pbrMetallicRoughness;r.baseColorFactor&&t(r.baseColorFactor,a,0,0,4),(r.metallicFactor||0===r.metallicFactor)&&(a[4]=r.metallicFactor),(r.roughnessFactor||0===r.roughnessFactor)&&(a[5]=r.roughnessFactor),r.baseColorTexture&&(s[1].texture=xt(e,n,r.baseColorTexture.index,35907),s[2].sampler=Tt(e,n,r.baseColorTexture.index),a[6]=r.baseColorTexture.texCoord||0),r.metallicRoughnessTexture&&(s[3].texture=xt(e,n,r.metallicRoughnessTexture.index),s[4].sampler=Tt(e,n,r.metallicRoughnessTexture.index),a[7]=r.metallicRoughnessTexture.texCoord||0)}i.normalTexture&&(s[5].texture=xt(e,n,i.normalTexture.index),s[6].sampler=Tt(e,n,i.normalTexture.index),a[8]=i.normalTexture.scale??1,a[9]=i.normalTexture.texCoord||0),i.occlusionTexture&&(s[7].texture=xt(e,n,i.occlusionTexture.index),s[8].sampler=Tt(e,n,i.occlusionTexture.index),a[10]=i.occlusionTexture.strength||0,a[11]=i.occlusionTexture.texCoord||0),i.emissiveFactor&&t(i.emissiveFactor,a,0,12,3),i.emissiveTexture&&(s[9].texture=xt(e,n,i.emissiveTexture.index,35907),s[10].sampler=Tt(e,n,i.emissiveTexture.index),a[15]=i.emissiveTexture.texCoord||0),(i.alphaCutoff||0===i.alphaCutoff)&&(a[16]=i.alphaCutoff)}Se(e,o,a);const l=Oe(0,{layout:wt(0,n),entries:s});return i?Ze(i).bindGroup=l:Ze(n).defaultMaterialBindGroup=l,l}(e,n,a.material)),_e(e,1,function(e,t,n,r){if(Ze(n).modelBindGroup)return Ze(n).modelBindGroup;const i=[{binding:0,buffer:_t(e,0,n)},{binding:1,buffer:Et(e,t,n,r)},{binding:2,texture:Mt(e,t,n)},{binding:3,sampler:Nt(e,t)}];return Ze(n).modelBindGroup=Oe(0,{layout:Ft(0,t),entries:i})}(e,n,r,i));const f=vt(n,a);for(let t=0;t<f.length;++t){const r=f[t].attributes[0].name,i=pt.exec(r),o=yt(e,n,i?a.targets[i[2]][i[1]]:a.attributes[r],32);o&&we(e,t,o)}const u=n.accessors?.[a.indices];if(u){const t=yt(e,n,a.indices,16);t&&(function(e,t){t.glb!==e.state.index&&e.gl.bindBuffer(34963,e.state.index=t.glb)}(e,t),l=u.count,s=Ze(u).byteOffset||0,o=!0)}o?function(e,t,n=1,r=0,i=0){for(const t of e.state.buffers)t.step&&t.instanceOffset!==i&&(t.instanceOffset=i,Pe(e.gl,t,i*t.stride));e.gl.drawElementsInstanced(e.state.state.topology,t,e.state.state.indexFormat,r*(e.state.state.indexFormat===g?2:4),n)}(e,l,1,s):function(e,t,n=1,r=0,i=0){for(const t of e.state.buffers)t.step&&t.instanceOffset!==i&&(t.instanceOffset=i,Pe(e.gl,t,i*t.stride));e.gl.drawArraysInstanced(e.state.state.topology,r,t,n)}(e,l)}function vt(e,t){const n={},r=[];if(Ze(t).bufferLayouts)return Ze(t).bufferLayouts;function i(t){if(!t.sparse){const i=tt(e,t).buffer,a=`${t.bufferView},${i.byteOffset},${i.byteLength}`;if(a in n)return r[n[a]];n[a]=r.length}const i={attributes:[],stride:e.bufferViews?.[t.bufferView]?.byteStride||0};return r.push(i),i}for(let n=0;n<ft.length;++n){const r=e.accessors?.[t.attributes[ft[n]]];if(r){const e=et(r);if(!e)continue;i(r).attributes.push({name:ft[n],format:e,shaderLocation:n,offset:Ze(r).byteOffset||0})}}if(t.targets){const n=new Array(3);let r=8;for(let a=0;a<Math.min(t.targets.length,r);++a){let o=0;for(let r=0;r<ut.length;++r)(n[r]=e.accessors?.[t.targets[a][ut[r]]])&&++o;r=8/o|0;for(let e=0;e<ut.length;++e){const t=n[e];t&&i(t).attributes.push({name:`${ut[e]}_${a}`,format:579,shaderLocation:dt[e]+a,offset:Ze(t).byteOffset||0})}}}return Ze(t).bufferLayouts=r,r}function yt(e,t,n,r){const i=t.accessors?.[n];if(!i)return null;const a=16&r&&i.componentType===Ke;if(i.sparse||a){let n=Ze(i).gpuBuffer;if(!n){const o=tt(t,i);let s=o.buffer;if(a){const e=new Uint16Array(s.byteLength);for(let t=0;t<s.byteLength;++t)e[t]=s[o.byteOffset+t];s=Ze(i).buffer=new Uint8Array(e.buffer,0,e.byteLength),Ze(i).byteOffset=0}n=Ze(i).gpuBuffer=Ae(e,{usage:r,size:s.byteLength}),Se(e,n,s)}return n}const o=t.bufferViews?.[i.bufferView];if(!o)return null;const s=Ze(o).gpuBuffers=Ze(o).gpuBuffers||{},l=tt(t,i).buffer,c=`${l.byteOffset},${l.byteLength}`;return s[c]||(s[c]=Ae(e,{usage:r,size:l.byteLength}),Se(e,s[c],l)),s[c]}function xt(e,t,n,r=32856){let i=null;const a=t.textures?.[n],o=t.images?.[a?.source];if(o&&(i=o.extras.image),!a||!i)return Ot(e,t);let s=Ze(a).texture;return s||(s=Ze(a).texture=ve(e,{format:r,size:[i.naturalWidth||1,i.naturalHeight||1,1],usage:4}),function(e,{src:t,origin:[n,r]=[0,0]},{texture:i,mipLevel:a=0,origin:[o,s,l]=[0,0,0]},[c,f]=[t.width-n,t.height-r]){const u=me(i.format),d=i.type===A?34069+l:i.type;e.gl.activeTexture(v),e.gl.bindTexture(i.type,i.glt),e.gl.pixelStorei(3316,n),e.gl.pixelStorei(O,r),e.gl.pixelStorei(32877,0),e.gl.pixelStorei(32878,0),fe(i.type)?e.gl.texSubImage3D(d,a,o,s,l,c,f,1,i.format,u,t):e.gl.texSubImage2D(d,a,o,s,c,f,ge(i.format),u,t)}(e,{src:i},{texture:s})),s}function Tt(e,t,n){const r=t.textures?.[n],i=t.samplers?.[r?.sampler];if(!i)return St(e,t);let a=Ze(i).sampler;if(!a){const t={...gt};switch(t.addressModeU=i.wrapS||t.addressModeU,t.addressModeV=i.wrapT||t.addressModeV,t.magFilter=i.magFilter||t.magFilter,i.minFilter){case 9984:t.minFilter=se,t.mipmapFilter=se;break;case 9986:t.minFilter=se,t.mipmapFilter=le;break;case 9985:t.minFilter=le,t.mipmapFilter=se;case 9987:t.minFilter=le,t.mipmapFilter=le;break;default:t.minFilter=i.minFilter}a=Ze(i).sampler=ye(e,t)}return a}function Ot(e,t){let n=Ze(t).blankTexture;return n||(n=Ze(t).blankTexture=ve(e,{usage:4}),Fe(e,{texture:n},new Uint8Array([255,255,255,255]),{bytesPerRow:4}),n)}function St(e,t){let n=Ze(t).defaultSampler;return n||(n=Ze(t).defaultSampler=ye(e,gt)),n}function Ft(e,t){let n=Ze(t).modelLayout;return n||(n=Ze(t).modelLayout=Te(0,{entries:[{binding:0,label:"Model",type:0},{binding:1,label:"Morph",type:0},{binding:2,label:"jointTexture",type:2},{binding:3,label:"jointTexture",type:1}]})),n}function wt(e,t){let n=Ze(t).materialLayout;return n||(n=Ze(t).materialLayout=Te(0,{entries:[{binding:0,label:"Material",type:0},{binding:1,label:"baseColorTexture",type:2},{binding:2,label:"baseColorTexture",type:1},{binding:3,label:"metallicRoughnessTexture",type:2},{binding:4,label:"metallicRoughnessTexture",type:1},{binding:5,label:"normalTexture",type:2},{binding:6,label:"normalTexture",type:1},{binding:7,label:"occlusionTexture",type:2},{binding:8,label:"occlusionTexture",type:1},{binding:9,label:"emissiveTexture",type:2},{binding:10,label:"emissiveTexture",type:1}]})),n}function _t(e,r,i,a=null){let o=Ze(i).modelBuffer;if(o||(o=Ze(i).modelBuffer=Ae(e,{usage:8256,size:208})),a){const r=new Float32Array(a.buffer,0,16);t(Ze(i).model||mt,r,0,0,16);const s=new Float32Array(a.buffer,64,16),l=function(e,t=[1,0,0,0,1,0,0,0,1]){return function(e,t=[1,0,0,0,1,0,0,0,1]){return function(e,t=[1,0,0,0,1,0,0,0,1]){const r=function(e){return e[0]*+(e[4]*e[8]-e[7]*e[5])+e[3]*-(e[1]*e[8]-e[7]*e[2])+e[6]*+(e[1]*e[5]-e[4]*e[2])}(e);return r?(Re[0]=+(e[4]*e[8]-e[7]*e[5]),Re[1]=-(e[1]*e[8]-e[7]*e[2]),Re[2]=+(e[1]*e[5]-e[4]*e[2]),Re[3]=-(e[3]*e[8]-e[6]*e[5]),Re[4]=+(e[0]*e[8]-e[6]*e[2]),Re[5]=-(e[0]*e[5]-e[3]*e[2]),Re[6]=+(e[3]*e[7]-e[6]*e[4]),Re[7]=-(e[0]*e[7]-e[6]*e[1]),Re[8]=+(e[0]*e[4]-e[3]*e[1]),function(e,t,r=[1,0,0,0,1,0,0,0,1]){return n(e,t,r)}(Re,1/r,t)):null}(e,t)?function(e,t=[1,0,0,0,1,0,0,0,1]){return function(e,t,n){let r=0;for(let e=0;e<3;++e)for(let i=e;i<3;++i)r=t[3*i+e],n[3*i+e]=t[3*e+i],n[3*e+i]=r;return n}(0,e,t)}(t,t):null}(function(e,t=[1,0,0,0,1,0,0,0,1]){for(let n=0;n<3;++n)for(let r=0;r<3;++r)t[3*n+r]=e[4*n+r];return t}(e,t),t)}(r);l?function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){for(let n=0;n<3;++n){for(let r=0;r<3;++r)t[4*n+r]=e[3*n+r];t[4*n+3]=0}t[12]=t[13]=t[14]=0,t[15]=1}(l,s):t(r,s,0,0,16),Se(e,o,a)}return o}function Et(e,n,r,i,a=!1){const o=Ze(r).weights||r.weights||i.weights;if(!o)return function(e,t){let n=Ze(t).morphBuffer;return n||(n=Ze(t).morphBuffer=Ae(e,{usage:64,size:32})),n}(e,n);let s=Ze(r).morphBuffer;if(s||(s=Ze(r).morphBuffer=Ae(e,{usage:8256,size:32})),a){const n=new Float32Array(8);t(o,n,0,0,8),Se(e,s,n)}return s}function Mt(e,t,n,r=!1){const i=t.skins?.[n.skin];if(!i)return Ot(e,t);let a=i.joints.length,o=Ze(n).jointTexture;return o||(o=Ze(n).jointTexture=ve(e,{size:[4,a,1],format:34836,usage:4})),r&&Fe(e,{texture:o},Ze(n).jointMatrix=Ze(n).jointMatrix||new Float32Array(16*a),{bytesPerRow:64,rowsPerImage:a},[4,a,1]),o}function Nt(e,t){let n=Ze(t).jointSampler;return n||(n=Ze(t).jointSampler=ye(e,{})),n}const Ct=new TextDecoder("utf-8");function Ut(e){return Ct.decode(e)}function It(e){return/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)}function Lt(e,t){return""===e?"":/^(https?:)?\/\//i.test(e)||It(e)?e:t+e}const Pt=1179937895;async function Rt(e,t=Bt){const n=e.uri?function(e){if(It(e))return"";const t=e.split(/[?#]/)[0].split("/");return t.pop(),t.length?t.join("/")+"/":""}(e.uri):"";let r=e.glTF,i=e.binaryChunk;if(!r&&e.uri){const n=await t(e.uri,"bin");if(a=n,new DataView(a.buffer||a,a.byteOffset||0,4).getUint32(0,!0)===Pt){const e=function(e){let t,n;const r=e.buffer||e,i=e.byteOffset||0,a=new DataView(r,i,12);if(a.getUint32(0,!0)!==Pt)throw new Error("Invalid GLB format");const o=a.getUint32(4,!0);if(2!==o)throw new Error("Unsupported GLB version: "+o);const s=new DataView(r,i+12);let l=0;for(;l<s.byteLength;){const e=s.getUint32(l,!0),a=s.getUint32(l+4,!0);if(l+=8,1313821514===a){const n=new Uint8Array(r,i+12+l,e);t=JSON.parse(Ut(n))}else 5130562===a&&(n=new Uint8Array(r,i+12+l,e));l+=e}if(!t)throw new Error("Invalid GLB format: missing JSON content");if(!t.asset||"2.0"!==t.asset.minVersion&&"2.0"!==t.asset.version)throw new Error("Unsupported glTF version: 2.0 required");return{glTF:t,binaryChunk:n}}(n);r=e.glTF,i=e.binaryChunk}else r=JSON.parse(Ut(n))}var a;if(!r)throw new Error("Failed to load glTF JSON");const o=await async function(e,t,n,r){if(e.buffers)for(let i=0;i<e.buffers.length;++i){const a=e.buffers[i];if(Ze(a).buffer)continue;let o;const s=a.uri;if(s)o=await n(Lt(s,r),"bin");else{if(0!==i||!t)throw new Error("Invalid glTF: missing uri for buffer "+i);o=t}Ze(a).buffer=o}return e}(r,i,t,n);return await async function(e,t,n){if(e.images)for(let r=0;r<e.images.length;++r){const i=e.images[r];if(Ze(i).image)continue;const a=i.bufferView;let o,s=!1,l=i.uri;if(a){const t=e.bufferViews?.[a];if(!t)throw new Error("Invalid glTF: invalid bufferView for image "+r);const n=new Blob([nt(e,t)],{type:i.mimeType});l=URL.createObjectURL(n),s=!0}if(!l)throw new Error("Invalid glTF: missing uri or bufferView for image "+r);try{o=await t(Lt(l,n),"img")}finally{s&&URL.revokeObjectURL(l)}Ze(i).image=o}return e}(o,t,n)}function Bt(e,t){return"img"===t?new Promise(((t,n)=>{const r=new Image;r.crossOrigin="anonymous",r.onerror=()=>n(new Error("Failed to load: "+e)),r.onload=()=>t(r),r.src=e})):fetch(e).then((e=>e.arrayBuffer())).then((e=>new Uint8Array(e)))}const kt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function zt(e,t,n,r){const i=d(n),[a,o]=function(e,t,n,r){for(let n=0;n<3;++n)e[n]=1/0,t[n]=-1/0;const i=s(),a=s();let o=(r.nodes||[]).slice();for(;o.length>0;){const r=n.nodes?.[o.pop()];if(!r)continue;o=o.concat(r.children||[]);const s=n.meshes?.[r.mesh];if(s)for(const o of s.primitives){const s=n.accessors?.[o.attributes.POSITION];if(s){Wt(i,a,s,r.extras?.model||kt);for(let n=0;n<3;++n)e[n]=Math.min(e[n],i[n]),t[n]=Math.max(t[n],a[n])}}}return[e,t]}(s(),s(),e,e.scenes[t]),p=Math.max(o[0]-a[0],o[1]-a[1]),g=Math.PI/4,m=g*r,b=p/2/Math.tan(g/2),h=p/2/Math.tan(m/2),A=Math.max(h,b);f(i,-1.2*A,i);const v=u(c(a,o));let y=A+6*v,x=A-6*v;x=Math.max(x,y/1e4);const T=s();return l(a,o,T),f(T,.5,T),{model:$e(i,T),proj:qe(r,g,x,y)}}const Dt=s(),Gt=s(),Vt=s(),jt=s();function Wt(e,n,r,i){const a=[...r.min,1],s=[...r.max,1];o(i,a,a),o(i,s,s),t(a,Dt,0,0,3),t(s,Gt,0,0,3),l(Gt,Dt,Vt),f(Vt,.5,Vt),c(Gt,Vt,jt);const d=u(jt);for(let t=0;t<3;++t)e[t]=Vt[t]-d,n[t]=Vt[t]+d}const Ht=s(-1,-2,-2),qt=new URLSearchParams(window.location.search),$t=document.querySelector("canvas"),Kt=$t.parentElement;let Xt=null,Jt=0,Zt=0;const Qt=function(e,t={},n=0){const r=e.getContext("webgl2",t);if(r){let t=0;for(const e in ce)n&+e&&r.getExtension(ce[+e])&&(t|=+e);const i=function(e){const t=Me();e.blendColor(1,1,1,1),Ne(e,t,t,0,!0);for(let t=0;t<16;++t)e.disableVertexAttribArray(t);return e.pixelStorei(3333,1),e.pixelStorei(3317,1),{copyFrameBuffer:e.createFramebuffer(),buffers:[],state:t,pipeline:null,index:null,stencilRef:0,scissor:!1}}(r),a=e=>{e.deleteFramebuffer(i.copyFrameBuffer)},o={canvas:e,gl:r,state:i,features:t,pass:null,destroy(){a(this.gl)}};return he.register(o,{finalizer:a,gl:r}),o}return null}($t,{powerPreference:"low-power"}),Yt="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/63f026b2aa957d3e8207f6dd798608993e33fb0d/2.0";function en(e=0){if(window.requestAnimationFrame(en),!Xt)return;Jt||(Jt=e);const n=e-Jt,r=qt.get("camera"),i=qt.get("scene"),a=((null!==i&&parseInt(i))??Xt.scene)||0;Xt.animations?.length&&(function(e,n,r=0,i=!1){const a=function(e,t){let n=Ze(t).duration||0;for(const r of t.channels){const i=e.nodes?.[r.target.node],a=e.accessors?.[t.samplers[r.sampler]?.input];i&&a&&(n=Math.max(n,a.max?.[0]||0))}return Ze(t).duration=n}(e,n),o=i?r-Math.floor(r/a)*a:Math.min(r,a);for(const r of n.channels){const i=e.nodes?.[r.target.node],a=n.samplers[r.sampler];if(!i||!a)continue;const s=Qe(e,a),l=Ye(e,a);if(!s?.length||!l)continue;const c=s.length,f=s[0],u=s[c-1];let d,p;if(o<=f)d=p=0;else if(o>=u)d=p=c-1;else{let e=Ze(r).lastKeyframe||0;for(s[e]>o&&(e=0),d=e,p=d+1;p<c&&!(s[d]<=o&&s[p]>o);++d,++p);}Ze(r).lastKeyframe=d;const g=r.target.path;let m=3;switch(g){case"rotation":m=4;break;case"weights":m=i.weights?.length||e.meshes?.[i.mesh]?.weights?.length||0}if(!m)continue;let b=a.interpolation;d===p&&(b="STEP");const h=s[d],A=s[p],v=(o-h)/(A-h),y=Ze(i)[g]=Ze(i)[g]||new Array(m),x=new Array(m);switch(b){case"STEP":t(l,y,d*m,0,m);break;case"CUBICSPLINE":{const e=A-h,t=v*v,n=v*t;for(let r=0;r<m;++r)y[r]=(2*n-3*t+1)*l[(3*d+1)*m+r]+(n-2*t+v)*e*l[(3*d+2)*m+r]+(-2*n+3*t)*l[(3*p+1)*m+r]+(n-t)*e*l[3*p*m+r];break}default:if("rotation"===g)t(l,y,d*m,0,m),t(l,x,p*m,0,m),Ve(y,x,v,y);else for(let e=0;e<m;++e)y[e]=(1-v)*l[d*m+e]+v*l[p*m+e]}}return r<a}(Xt,Xt.animations[Zt],n/1e3)||(Jt=e,Zt=(Zt+1)%Xt.animations.length)),function(e,n,r,i={}){const a=(i.scene??r.scene)||0,o=r.nodes,l=r.scenes?.[a]?.nodes;if(!o||!l)return;const c=function(e,t={}){let n=[];const r=e.scenes?.[(t.scene??e.scene)||0]?.nodes;if(r)for(let t=0;t<r.length;++t)st(e,r[t],rt,n);n=n.sort().filter(((e,t,n)=>!t||e!==n[t-1]));for(const t of n){const n=e.nodes[t];"camera"in n&&lt(e,n),"skin"in n&&ct(e,n)}return n}(r,{scene:a});let f=mt,u=mt,d=bt;if(i.camera){const t=r.cameras?.[i.camera.index||0];t&&(f=t.extras?.view||mt,p=ht,g=t,m=e.width/e.height,g?.orthographic?function(e,t,n,r,i,a,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const s=1/(t-e),l=1/(r-n),c=1/(i-a);ke(o),o[0]=2*s,o[5]=2*l,o[10]=2*c,o[12]=-(t+e)*s,o[13]=-(r+n)*l,o[14]=(i+a)*c}(-g.orthographic.xmag,g.orthographic.xmag,-g.orthographic.xmag/(m||1),g.orthographic.xmag/(m||1),g.orthographic.znear,g.orthographic.zfar,p):g?.perspective?qe(m||g.perspective.aspectRatio||1,g.perspective.yfov,g.perspective.znear,g.perspective.zfar||1/0,p):ke(p),u=p,d=t.extras?.translation||bt),i.camera.model&&(d=s(i.camera.model[12],i.camera.model[13],i.camera.model[14]),De(i.camera.model,f)),u=i.camera.proj||u}var p,g,m;const b=ze(u,f,ht),h=new Float32Array(52);t(b,h,0,32,16),t(d,h,0,48,3),function(e,t={}){e.gl.bindFramebuffer(36160,null),e.gl.viewport(0,0,e.gl.drawingBufferWidth,e.gl.drawingBufferHeight),e.gl.depthRange(0,1),e.state.scissor&&(e.state.scissor=!1,Le(e.gl,3089,!1));let n=0;isNaN(t.clearDepth)||(n|=256,e.gl.clearDepth(t.clearDepth),Ue(e.gl,e.state.state.depthWrite,!0),e.state.state.depthWrite=!0),isNaN(t.clearStencil)||(n|=1024,e.gl.clearStencil(t.clearStencil),Ie(e.gl,e.state.state.stencilWriteMask,255),e.state.state.stencilWriteMask=255),t.clearColor&&(n|=16384,e.gl.clearColor(...t.clearColor),Ce(e.gl,e.state.state.blendWriteMask,15),e.state.state.blendWriteMask=15),n&&e.gl.clear(n),e.pass=null}(n,{clearDepth:1});const A=[];for(let e=0;e<c.length;++e){const t=o[c[e]],i=r.meshes?.[t.mesh];if(i){_t(n,0,t,h),Et(n,r,t,i,!0),Mt(n,r,t,!0);for(let e=0;e<i.primitives.length;++e){const a=i.primitives[e];"BLEND"===r.materials?.[a.material]?.alphaMode?A.push({node:t,mesh:i,primitive:a}):At(n,r,t,i,a)}}}for(const e of A)At(n,r,e.node,e.mesh,e.primitive);!function(e){if(e.pass){for(let t=0;t<e.pass.color.length;++t)e.pass.glrfb[t]&&Ee(e.gl,e.pass.glfb,e.pass.glrfb[t],e.pass.color[t],16384,36064+t);const t=e.pass.glrfb[e.pass.glrfb.length-1];e.pass.depth&&t&&Ee(e.gl,e.pass.glfb,t,e.pass.depth,1280)}e.pass=null}(n)}($t,Qt,Xt,{scene:a,camera:Xt.cameras?{index:parseInt(r)||0}:zt(Xt,a,Ht,$t.width/$t.height)})}function tn(){const e=window.devicePixelRatio||1,t=Kt.clientWidth,n=Kt.clientHeight;$t.width=t*e,$t.height=n*e,$t.style.width=`${t}px`,$t.style.height=`${n}px`}window.addEventListener("resize",tn,!1),tn(),async function(){let e=qt.get("url");if(!e){const t=await(await fetch(`${Yt}/model-index.json`)).json(),n=qt.get("model")||"BrainStem",r=qt.get("variant")||"glTF",i=t.find((e=>e.name===n));e=`${Yt}/${n}/${r}/${i.variants[r]}`}const t=await Rt({uri:e});Xt=t,en()}()})();