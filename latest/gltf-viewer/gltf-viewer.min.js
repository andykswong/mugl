(()=>{async function e(e,t){if("img"===t)return await function(e){return new Promise(((t,n)=>{const r=new Image;r.crossOrigin="anonymous",r.onerror=()=>n(new Error(`Failed to load: ${e}`)),r.onload=()=>t(r),r.src=e}))}(e);const n=await fetch(e),r=await n.arrayBuffer();return new Uint8Array(r)}const t=new TextDecoder("utf-8");function n(e){return t.decode(e)}function r(e){return/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)}function i(e,t){return""===e?"":/^(https?:)?\/\//i.test(e)||r(e)?e:t+e}const a=1179937895;function o(e,t){const n=e[t.buffer];return n?new Uint8Array(n.buffer,n.byteOffset+(t.byteOffset||0),t.byteLength):new Uint8Array}const s=new Array(16);function l(e,t,n=0,r=0,i=e.length-n){for(let a=0;a<i;++a)t[r+a]=e[n+a];return t}function c(e,t,n){for(let r=0;r<e.length;++r)n[r]=e[r]*t;return n}function f(e,t,n,r){const i=t.length/e,a=n.length/e;let o=0;s.length=i*a;for(let r=0;r<a;++r)for(let a=0;a<i;++a){o=0;for(let s=0;s<e;++s)o+=t[s*i+a]*n[r*e+s];s[r*i+a]=o}return l(s,r,0,0,s.length),r}function u(e,t){let n=0;for(let r=0;r<e.length;++r)n+=e[r]*t[r];return n}function d(e=0,t=0,n=0,r=0){return[e,t,n,r]}function g(e,t,n=d()){return f(4,e,t,n)}function p(e=0,t=0,n=0){return[e,t,n]}function m(e,t,n=p()){return function(e,t,n){for(let r=0;r<e.length;++r)n[r]=e[r]+t[r];return n}(e,t,n)}function b(e,t,n=p()){return function(e,t,n){for(let r=0;r<e.length;++r)n[r]=e[r]-t[r];return n}(e,t,n)}function h(e,t,n=p()){return c(e,t,n)}function A(e){return Math.sqrt(u(e,e))}function T(e,t=p()){return c(e,1/(A(e)||1),t)}function v(e,t,n=p()){const r=e[2]*t[0]-t[2]*e[0],i=e[0]*t[1]-t[0]*e[1];return n[0]=e[1]*t[2]-t[1]*e[2],n[1]=r,n[2]=i,n}p(),d(),d();const y=5123,F=5126,x=7680,O=9728,S=34067,w=33984,E=33071,_=36161,M=33189,C=3315,N=32856,U=32857,I=33190,L=35907,P=34836,B=34842,R=35898,k=36208,D=36214,z=36220,G=36226,V=36232,j=36238,W=36012,H=36013,q=35056,$=33321,K=33323,X=33325,J=33326,Z=33327,Q=33328,Y=33329,ee=33330,te=33331,ne=33332,re=33333,ie=33334,ae=33335,oe=33336,se=33337,le=33338,ce=33339,fe=33340,ue=36756,de=36757,ge=36759,pe=O,me=9729;function be(e){return 32879===e||35866===e}function he(e){return 15&e}function Ae(e){switch(e>>4&511){case 36:return F;case 34:return 5131;case 274:return 5122;case 273:return 5120;case 18:return y;case 17:return 5121}return 0}function Te(e){return!!(e>>13)}function ve(e){switch(e){case $:case ue:case X:case J:return 6403;case ee:case Y:case ne:case te:case ie:case re:return 36244;case K:case de:case Z:case Q:return 33319;case oe:case ae:case le:case se:case fe:case ce:return 33320;case N:case L:case ge:case U:case B:case P:return 6408;case z:case j:case D:case k:case V:case G:return 36249;case R:return 6407;case M:case I:case W:return 6402;case q:case H:return 34041}return 0}function ye(e){switch(e){case $:case ee:case K:case oe:case N:case L:case z:return 5121;case ue:case Y:case de:case ae:case ge:case j:return 5120;case ne:case le:case D:return y;case te:case se:case V:return 5122;case ie:case fe:case k:return 5125;case re:case ce:case G:return 5124;case U:return 33640;case X:case Z:case B:return 5131;case J:case Q:case P:return F;case R:return 35899;case M:return y;case I:return 5125;case q:return 34042;case W:return F;case H:return 36269}return 0}const Fe={1:"EXT_texture_filter_anisotropic",2:"OES_texture_half_float_linear",4:"OES_texture_float_linear",8:"EXT_color_buffer_float",16:"OES_draw_buffers_indexed"},xe=4294967295;function Oe(e={}){const t=e.primitive||{},n=e.depthStencil||{},{stencilFront:r={},stencilBack:i={}}=n,{sampleCount:a=1,alphaToCoverage:o=!1}=e.multisample||{},s=e.targets||{},l=s.targets&&s.targets.map((e=>Se(e.blendColor,e.blendAlpha,e.writeMask)))||[];return{sampleCount:a,alphaToCoverage:o,topology:t.topology||4,indexFormat:t.indexFormat||y,frontFace:t.frontFace||2305,cullMode:t.cullMode||0,depth:!!e.depthStencil,depthWrite:n.depthWrite||!1,depthFormat:n.format||M,depthCompare:n.depthCompare||519,depthBias:n.depthBias||0,depthBiasSlopeScale:n.depthBiasSlopeScale||0,stencil:!(!n.stencilFront&&!n.stencilBack),stencilFrontCompare:r.compare||519,stencilFrontFailOp:r.failOp||x,stencilFrontDepthFailOp:r.depthFailOp||x,stencilFrontPassOp:r.passOp||x,stencilBackCompare:i.compare||519,stencilBackFailOp:i.failOp||x,stencilBackDepthFailOp:i.depthFailOp||x,stencilBackPassOp:i.passOp||x,stencilReadMask:n.stencilReadMask||xe,stencilWriteMask:n.stencilWriteMask||xe,blend:!!e.targets,drawBuffers:l,...Se(s.blendColor,s.blendAlpha,s.writeMask)}}function Se(e={},t={},n=15){return{blendWriteMask:n,blendColorOp:e.operation||32774,blendColorSrcFactor:void 0!==e.srcFactor?e.srcFactor:1,blendColorDstFactor:e.dstFactor||0,blendAlphaOp:t.operation||32774,blendAlphaSrcFactor:void 0!==t.srcFactor?t.srcFactor:1,blendAlphaDstFactor:t.dstFactor||0}}function we(e,t,n,r,i=0,a=!1){let o=!1,s=0,l=0,c=0,f=0;if(s=r.frontFace,(a||n.frontFace!==s)&&e.frontFace(s),s=r.cullMode,(a||n.cullMode!==s)&&((o=0!==s)&&e.cullFace(s),Ne(e,2884,o)),o=r.alphaToCoverage,(a||n.alphaToCoverage!==o)&&Ne(e,32926,o),o=!!r.depth,(a||n.depth!==o)&&Ne(e,2929,o),(a||o)&&(Me(e,n.depthWrite,r.depthWrite,a),s=r.depthCompare,(a||n.depthCompare!==s)&&e.depthFunc(s)),s=r.depthBiasSlopeScale,l=r.depthBias,(a||n.depthBiasSlopeScale!==s||n.depthBias!==l)&&(Ne(e,32823,!(!s&&!l)),e.polygonOffset(s,l)),o=!!r.stencil,(a||n.stencil!==o)&&Ne(e,2960,o),(a||o)&&(s=r.stencilReadMask,o=a||n.stencilReadMask!==s,l=r.stencilFrontCompare,(o||n.stencilFrontCompare!==l)&&e.stencilFuncSeparate(1028,l,i,s),l=r.stencilBackCompare,(o||n.stencilBackCompare!==l)&&e.stencilFuncSeparate(1029,l,i,s),s=r.stencilFrontFailOp,l=r.stencilFrontDepthFailOp,c=r.stencilFrontPassOp,(a||n.stencilFrontFailOp!==s||n.stencilFrontDepthFailOp!==l||n.stencilFrontPassOp!==c)&&e.stencilOpSeparate(1028,s,l,c),s=r.stencilBackFailOp,l=r.stencilBackDepthFailOp,c=r.stencilBackPassOp,(a||n.stencilBackFailOp!==s||n.stencilBackDepthFailOp!==l||n.stencilBackPassOp!==c)&&e.stencilOpSeparate(1029,s,l,c),Ce(e,n.stencilWriteMask,r.stencilWriteMask,a)),o=r.blend,(a||n.blend!==o)&&Ne(e,3042,o),(a||o)&&(s=r.blendColorSrcFactor,l=r.blendColorDstFactor,c=r.blendAlphaSrcFactor,f=r.blendAlphaDstFactor,(a||n.blendColorSrcFactor!==s||n.blendColorDstFactor!==l||n.blendAlphaSrcFactor!==c||n.blendAlphaDstFactor!==f)&&e.blendFuncSeparate(s,l,c,f),s=r.blendColorOp,l=r.blendAlphaOp,(a||n.blendColorOp!==s||n.blendAlphaOp!==l)&&e.blendEquationSeparate(s,l),_e(e,n.blendWriteMask,r.blendWriteMask,a),t))for(let e=0;e<r.drawBuffers.length;++e)Ee(t,e,r,r.drawBuffers[e])}function Ee(e,t,n,r,i=!1){let a=0,o=0,s=0,l=0;a=r.blendColorSrcFactor,o=r.blendColorDstFactor,s=r.blendAlphaSrcFactor,l=r.blendAlphaDstFactor,(i||n.blendColorSrcFactor!==a||n.blendColorDstFactor!==o||n.blendAlphaSrcFactor!==s||n.blendAlphaDstFactor!==l)&&e.blendFuncSeparateiOES(t,a,o,s,l),a=r.blendColorOp,o=r.blendAlphaOp,(i||n.blendColorOp!==a||n.blendAlphaOp!==o)&&e.blendEquationSeparateiOES(t,a,o),function(e,t,n,r,i=!1){(i||n!==r)&&e.colorMaskiOES(t,!!(1&r),!!(2&r),!!(4&r),!!(8&r))}(e,t,n.blendWriteMask,r.blendWriteMask,i)}function _e(e,t,n,r=!1){(r||t!==n)&&e.colorMask(!!(1&n),!!(2&n),!!(4&n),!!(8&n))}function Me(e,t,n,r=!1){(r||t!==n)&&e.depthMask(n)}function Ce(e,t,n,r=!1){(r||t!==n)&&e.stencilMask(n)}function Ne(e,t,n){n?e.enable(t):e.disable(t)}function Ue(e,t,n,r,i,a=36064){e.bindFramebuffer(36008,t),e.bindFramebuffer(36009,n),e.readBuffer(a),e.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,i,O)}function Ie(e,t,n){e.bindBuffer(34962,t.glb);for(let r=0;r<t.attributes.length;++r){const{ptr:i,step:a}=t.attributes[r],o=[...i];o[5]+=n,e.vertexAttribPointer(...o),e.vertexAttribDivisor(i[0],a)}}let Le=null;function Pe(e,t){const n=64&t.usage?35345:16&t.usage?34963:34962,r=8192&t.usage?35040:4096&t.usage?35048:35044,i=e.gl.createBuffer();e.gl.bindBuffer(n,i),e.gl.bufferData(n,t.size,r);const a=e=>{e.deleteBuffer(i)},o={gl:e.gl,glb:i,type:n,size:t.size,destroy(){a(this.gl)}};return Le.register(o,{finalizer:a,gl:e.gl}),o}function Be(e,t){const n=t.sampleCount||1,r=t.dimension||3553,i=t.format||N,a=!function(e){switch(e){case M:case I:case q:case W:case H:return!0}return!1}(i)||4&(t.usage||0),[o,s,l]=t.size||[1,1,1],c=r===S?6:3553===r?1:l;let f=null,u=null;(n>1||!a)&&(u=e.gl.createRenderbuffer(),e.gl.bindRenderbuffer(_,u),n>1?e.gl.renderbufferStorageMultisample(_,n,i,o,s):e.gl.renderbufferStorage(_,i,o,s)),a&&(f=e.gl.createTexture(),e.gl.activeTexture(w),e.gl.bindTexture(r,f),be(r)?e.gl.texStorage3D(r,t.mipLevelCount||1,i,o,s,c):e.gl.texStorage2D(r,t.mipLevelCount||1,i,o,s));const d=e=>{e.deleteTexture(f),e.deleteRenderbuffer(u)},g={gl:e.gl,glt:f,glrb:u,type:r,format:i,width:o,height:s,depth:c,samples:n,destroy(){d(this.gl)}};return Le.register(g,{finalizer:d,gl:e.gl}),g}function Re(e,t={}){const n=e.gl.createSampler();let r=t.minFilter||O;t.mipmapFilter&&(r=t.mipmapFilter===O?r===O?9984:9985:r===O?9986:9987),e.gl.samplerParameteri(n,10241,r),e.gl.samplerParameteri(n,10240,t.magFilter||O),e.gl.samplerParameteri(n,10242,t.addressModeU||E),e.gl.samplerParameteri(n,10243,t.addressModeV||E),e.gl.samplerParameteri(n,32882,t.addressModeW||E),e.gl.samplerParameterf(n,33083,t.lodMaxClamp||32),e.gl.samplerParameterf(n,33082,t.lodMinClamp||0),t.compare&&(e.gl.samplerParameterf(n,34892,34894),e.gl.samplerParameterf(n,34893,t.compare)),(t.maxAnisotropy||1)>1&&e.gl.samplerParameterf(n,34046,Math.min(t.maxAnisotropy||1,e.gl.getParameter(34047)));const i=e=>{e.deleteSampler(n)},a={gls:n,gl:e.gl,destroy(){i(this.gl)}};return Le.register(a,{finalizer:i,gl:e.gl}),a}function ke(e,t){const n=1===t.usage?35633:35632,r=e.gl.createShader(n);e.gl.shaderSource(r,t.code),e.gl.compileShader(r);const i=e=>{e.deleteShader(r)},a={gl:e.gl,gls:r,destroy(){i(this.gl)}};return Le.register(a,{finalizer:i,gl:e.gl}),a}function De(e,t){return{entries:t.entries.map(((e,t)=>({binding:t,...e}))),destroy(){}}}function ze(e,t){return{entries:t.entries.map(((e,t)=>({binding:t,...e}))),destroy(){}}}function Ge(e,t,n,r=0){e.gl.bindBuffer(t.type,t.glb),e.gl.bufferSubData(t.type,r,n)}function Ve(e,{texture:t,mipLevel:n=0,origin:[r,i,a]=[0,0,0]},o,{offset:s=0,bytesPerRow:l,rowsPerImage:c=0},[f,u,d]=[t.width-r,t.height-i,t.depth-a]){const g=ve(t.format),p=ye(t.format),m=t.type===S,b=m?34069+a:t.type;e.gl.activeTexture(w),e.gl.bindTexture(t.type,t.glt);const h=function(e){switch(e){case $:case ee:case ue:case Y:return 1;case ne:case te:case K:case oe:case de:case ae:case X:return 2;case ie:case re:case J:case le:case se:case Z:case N:case L:case z:case ge:case j:case U:case R:return 4;case fe:case ce:case Q:case D:case V:case B:return 8;case k:case G:case P:return 16;case M:return 2;case I:case q:case W:return 4;case H:return 8}return 0}(t.format),A=c||u,T=Math.floor(l/h),v=s-s%l;if(e.gl.pixelStorei(32878,A),e.gl.pixelStorei(3314,T),e.gl.pixelStorei(3316,Math.floor(s%l/h)),e.gl.pixelStorei(C,0),e.gl.pixelStorei(32877,0),be(t.type))e.gl.texSubImage3D(b,n,r,i,a,f,u,d,t.format,p,o,v);else if(m)for(let t=a;t<a+d;++t)e.gl.pixelStorei(C,t*T*A),e.gl.texSubImage2D(b+t,n,r,i,f,u,g,p,o,v);else e.gl.texSubImage2D(b,n,r,i,f,u,g,p,o,v)}function je(e,t,n,r=0){const i=e.state.buffers[t];!i||i.glb===n.glb&&i.offset===r||(i.glb=n.glb,i.offset=r,i.instanceOffset=0,Ie(e.gl,i,r))}function We(e,t,n,r=[]){if(e.state.pipeline)for(let i=0,a=0;i<n.entries.length;++i){const o=n.entries[i],s=e.state.pipeline.cache[t]&&e.state.pipeline.cache[t][o.binding];if(s)if(o.buffer){let t=o.bufferOffset||0;s.bufferDynamicOffset&&(t+=r[a]||0,++a),e.gl.bindBufferRange(35345,s.slot,o.buffer.glb,t,o.bufferSize||o.buffer.size-t)}else o.texture?(e.gl.activeTexture(w+s.slot),e.gl.bindTexture(o.texture.type,o.texture.glt),e.gl.uniform1i(s.loc,s.slot)):o.sampler&&e.gl.bindSampler(s.slot,o.sampler.gls)}}Le=new FinalizationRegistry((({finalizer:e,gl:t})=>{e(t)}));const He=[1,0,0,0,1,0,0,0,1],qe=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function $e(e){for(let t=0;t<16;++t)e[t]=t%5?0:1;return e}function Ke(e,t,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){return f(4,e,t,n)}function Xe(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const n=e[0]*e[5]-e[4]*e[1],r=e[0]*e[9]-e[8]*e[1],i=e[0]*e[13]-e[12]*e[1],a=e[4]*e[9]-e[8]*e[5],o=e[4]*e[13]-e[12]*e[5],s=e[8]*e[13]-e[12]*e[9],l=e[2]*e[7]-e[6]*e[3],f=e[2]*e[11]-e[10]*e[3],u=e[2]*e[15]-e[14]*e[3],d=e[6]*e[11]-e[10]*e[7],g=e[6]*e[15]-e[14]*e[7],p=e[10]*e[15]-e[14]*e[11],m=n*p-r*g+i*d+a*u-o*f+s*l;return m?(qe[0]=+e[5]*p-e[9]*g+e[13]*d,qe[1]=-e[1]*p+e[9]*u-e[13]*f,qe[2]=+e[1]*g-e[5]*u+e[13]*l,qe[3]=-e[1]*d+e[5]*f-e[9]*l,qe[4]=-e[4]*p+e[8]*g-e[12]*d,qe[5]=+e[0]*p-e[8]*u+e[12]*f,qe[6]=-e[0]*g+e[4]*u-e[12]*l,qe[7]=+e[0]*d-e[4]*f+e[8]*l,qe[8]=+e[7]*s-e[11]*o+e[15]*a,qe[9]=-e[3]*s+e[11]*i-e[15]*r,qe[10]=+e[3]*o-e[7]*i+e[15]*n,qe[11]=-e[3]*a+e[7]*r-e[11]*n,qe[12]=-e[6]*s+e[10]*o-e[14]*a,qe[13]=+e[2]*s-e[10]*i+e[14]*r,qe[14]=-e[2]*o+e[6]*i-e[14]*n,qe[15]=+e[2]*a-e[6]*r+e[10]*n,function(e,t,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){return c(e,t,n)}(qe,1/m,t)):null}const Je=u,Ze=p(),Qe=p(),Ye=p();function et(e,t,n,r=1/0,i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const a=1/Math.tan(t/2);if($e(i),i[0]=a/e,i[5]=a,i[11]=-1,i[15]=0,isFinite(r)){const e=1/(n-r);i[10]=(n+r)*e,i[14]=2*n*r*e}else i[10]=-1,i[14]=-2*n;return i}function tt(e,t,n=p(0,1,0),r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const i=b(e,t,Ze);T(i,i);const a=v(n,i,Qe);T(a,a);const o=v(i,a,Ye);return T(o,o),l(a,r,0,0,3),l(o,r,0,4,3),l(i,r,0,8,3),l(e,r,0,12,3),r[3]=r[7]=r[11]=0,r[15]=1,r}const nt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function rt(e,t,n,r){const i=T(n),[a,o]=function(e,t,n,r){for(let n=0;n<3;++n)e[n]=1/0,t[n]=-1/0;const i=p(),a=p();let o=(r.nodes||[]).slice();for(;o.length>0;){const r=n.nodes?.[o.pop()];if(!r)continue;o=o.concat(r.children||[]);const s=n.meshes?.[r.mesh];if(s)for(const o of s.primitives){const s=n.accessors?.[o.attributes.POSITION];if(s){lt(i,a,s,r.extras?.model||nt);for(let n=0;n<3;++n)e[n]=Math.min(e[n],i[n]),t[n]=Math.max(t[n],a[n])}}}return[e,t]}(p(),p(),e,e.scenes[t]),s=Math.max(o[0]-a[0],o[1]-a[1]),l=Math.PI/4,c=l*r,f=s/2/Math.tan(l/2),u=s/2/Math.tan(c/2),d=Math.max(u,f);h(i,-1.2*d,i);const g=A(b(a,o)),v=d+6*g;let y=d-6*g;y=Math.max(y,v/1e4);const F=p();return m(a,o,F),h(F,.5,F),{model:tt(i,F),proj:et(r,l,y,v)}}const it=p(),at=p(),ot=p(),st=p();function lt(e,t,n,r){const i=[...n.min,1],a=[...n.max,1];g(r,i,i),g(r,a,a),l(i,it,0,0,3),l(a,at,0,0,3),m(at,it,ot),h(ot,.5,ot),b(at,ot,st);const o=A(st);for(let n=0;n<3;++n)e[n]=ot[n]-o,t[n]=ot[n]+o}const ct=5121,ft=5123,ut=5126;function dt(e){return e.extras||(e.extras={}),e.extras}function gt(e,t){let n=dt(t).input||null;if(!n){const r=e.glTF.accessors?.[t.input];if(r){const{buffer:i,byteOffset:a=0}=bt(e,r);dt(t).input=n=new Float32Array(i.buffer,a+i.byteOffset,(i.byteLength-a)/4)}}return n}function pt(e,t){let n=dt(t).output||null;if(!n){const r=e.glTF.accessors?.[t.output];if(r){const{buffer:i,byteOffset:a=0}=bt(e,r);let o=Float32Array;switch(r.componentType){case 5120:o=Int8Array;break;case ct:o=Uint8Array;break;case 5122:case ft:o=Uint16Array}dt(t).output=n=new o(i.buffer,a+i.byteOffset,(i.byteLength-a)/o.BYTES_PER_ELEMENT)}}return n}function mt(e){switch(e.type){case"VEC2":if(e.componentType===ut)return 578;if(e.componentType===ft)return e.normalized?8482:290;if(e.componentType===ct)return e.normalized?8466:274;break;case"VEC3":if(e.componentType===ut)return 579;break;case"VEC4":if(e.componentType===ut)return 580;if(e.componentType===ft)return e.normalized?8484:292;if(e.componentType===ct)return e.normalized?8468:276}return null}function bt(e,t){let n=dt(t).buffer,r=dt(t).byteOffset||0;if(n)return{buffer:n,byteOffset:r};const i=function(e){let t=0;switch(e.type){case"SCALAR":t=1;break;case"VEC2":t=2;break;case"VEC3":t=3;break;case"VEC4":case"MAT2":t=4;break;case"MAT3":t=9;break;case"MAT4":t=16}let n=0;switch(e.componentType){case 5120:case ct:n=1;break;case 5122:case ft:n=2;break;case 5125:case ut:n=4}return t*n}(t);let a=t.count*i;const o=e.glTF.bufferViews?.[t.bufferView];if(o){const s=ht(e,o),l=o.byteStride||1;r=(t.byteOffset||0)%l,a=t.count*(o.byteStride||i);const c=(t.byteOffset||0)-r;n=new Uint8Array(s.buffer,s.byteOffset+c,a)}if(t.sparse){const{count:o,indices:{bufferView:s,byteOffset:l=0,componentType:c},values:{bufferView:f,byteOffset:u=0}}=t.sparse,d=e.glTF.bufferViews?.[s],g=e.glTF.bufferViews?.[f];if(d&&g){const t=new Uint8Array(a);n&&t.set(n,r);const s=ht(e,d),f=ht(e,g),p=new(c===ct?Uint8Array:c===ft?Uint16Array:Uint32Array)(s.buffer,s.byteOffset+l,o),m=new Uint8Array(f.buffer,f.byteOffset+u,o*i);for(let e=0;e<o;++e){const n=p[e]*i;for(let r=0;r<i;++r)t[n+r]=m[e*i+r]}r=0,n=t}}return n?(dt(t).buffer=n,dt(t).byteOffset=r):n=new Uint8Array,{buffer:n,byteOffset:r}}function ht(e,t){let n=dt(t).buffer;if(!n){const r=e.buffers?.[t.buffer];n=r?new Uint8Array(r.buffer,r.byteOffset+(t.byteOffset||0),t.byteLength):new Uint8Array,dt(t).buffer=n}return n}const At=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Tt=[0,0,0,1],vt=p(1,1,1),yt=p();function Ft(e,t,n,r=null){const i=e.nodes?.[t];if(!i)return;r?.push(t);const a=dt(i),o=a.matrix=a.matrix||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];i.matrix?function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){l(e,t)}(i.matrix,o):(i.rotation||i.scale||i.translation||a.rotation||a.scale||a.translation)&&function(e,t,n,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){!function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){!function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const n=e[0]*e[0],r=e[0]*e[1],i=e[0]*e[2],a=e[1]*e[1],o=e[1]*e[2],s=e[2]*e[2],l=e[3]*e[0],c=e[3]*e[1],f=e[3]*e[2];t[0]=1-2*(a+s),t[1]=2*(r+f),t[2]=2*(i-c),t[4]=2*(r-f),t[5]=1-2*(n+s),t[6]=2*(o+l),t[8]=2*(i+c),t[9]=2*(o-l),t[10]=1-2*(n+a),t[3]=t[7]=t[11]=t[12]=t[13]=t[14]=0,t[15]=1}(e,t)}(t,r);for(let e=0;e<3;++e)for(let t=0;t<3;++t)r[4*e+t]*=n[e];l(e,r,0,12,3)}(a.translation||i.translation||yt,a.rotation||i.rotation||Tt,a.scale||i.scale||vt,o);const s=a.model=Ke(n,o,a.model||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);if(i.children)for(const t of i.children)Ft(e,t,s,r)}function xt(e,t){const n=e.cameras?.[t.camera];if(n){const e=dt(t).model=dt(t).model||At;dt(n).view=Xe(e,dt(n).view||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),dt(n).translation=[e[12],e[13],e[14]]}}function Ot(e,t){const n=e.glTF.skins?.[t.skin];if(n){const r=n.joints.length,i=dt(t).jointMatrix=dt(t).jointMatrix||new Float32Array(16*r),a=function(e,t){let n=dt(t).inverseBindMatrices;if(!n){const r=e.glTF.accessors?.[t.inverseBindMatrices];if(r){const{buffer:i,byteOffset:a}=bt(e,r);n=new Float32Array(i.buffer,i.byteOffset+a,16*t.joints.length)}else n=new Float32Array(16*t.joints.length);dt(t).inverseBindMatrices=n}return n}(e,n);for(let o=0;o<r;++o){const r=e.glTF.nodes[n.joints[o]],s=new Float32Array(i.buffer,i.byteOffset+64*o,16),l=new Float32Array(a.buffer,a.byteOffset+64*o,16);Xe(dt(t).model||At,s),Ke(s,r&&dt(r).model||At,s),Ke(s,l,s)}}}function St(e,t,n,r,i=0){const a=e.length;let o,s;if(r<=t)o=s=0;else if(r>=n)o=s=a-1;else{for((i>=a||e[i]>r)&&(i=0),o=i,s=o+1;s<a&&!(e[o]<=r&&e[s]>r);++o,++s);s=Math.min(s,a-1)}return[o,s]}function wt(e,t,n,r,i,a,o,s){const c=t[r],f=t[i],u=(a-c)/(f-c),d=e.length,g=new Array(d);switch(o=r===i?"STEP":o){case"STEP":l(n,e,r*d,0,d);break;case"CUBICSPLINE":{const t=f-c,a=u*u,o=u*a;for(let s=0;s<d;++s)e[s]=(2*o-3*a+1)*n[(3*r+1)*d+s]+(o-2*a+u)*t*n[(3*r+2)*d+s]+(-2*o+3*a)*n[(3*i+1)*d+s]+(o-a)*t*n[3*i*d+s];break}default:if(s)l(n,e,r*d,0,d),l(n,g,i*d,0,d),function(e,t,n,r=[0,0,0,1]){let i=Je(e,t),a=1;i<0&&(i*=-1,a=-1);let o=1-n,s=n;if(1-i>1e-6){const e=Math.acos(i),t=Math.sin(e);o=Math.sin((1-n)*e)/t,s=Math.sin(n*e)/t}s*=a,r[0]=e[0]*o+t[0]*s,r[1]=e[1]*o+t[1]*s,r[2]=e[2]*o+t[2]*s,r[3]=e[3]*o+t[3]*s}(e,g,u,e);else for(let t=0;t<d;++t)e[t]=(1-u)*n[r*d+t]+u*n[i*d+t]}}const Et=["POSITION","NORMAL","TANGENT","TEXCOORD_0","TEXCOORD_1","COLOR_0","JOINTS_0","WEIGHTS_0"],_t=["POSITION","NORMAL","TANGENT"],Mt=[8,12,14],Ct=/(POSITION|NORMAL|TANGENT)_(\d+)/,Nt={addressModeU:10497,addressModeV:10497,magFilter:me,minFilter:me},Ut=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],It=p(),Lt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function Pt(e,t,n,r,i){let a=!1,o=0,s=t.glTF.accessors?.[i.attributes.POSITION]?.count||0;if(!s)return;const c=function(e,t,n){let r=dt(n).pipeline;if(r)return r;const i=n.mode||4,a=t.glTF.materials?.[n.material];let o="OPAQUE",s=!1,l=!1;a&&(s=a.doubleSided||!1,o=a.alphaMode||o,l=!!a.extensions?.KHR_materials_unlit);const c=Bt(t,n),f=5125===t.glTF.accessors?.[n.indices]?.componentType?5125:5123,u=JSON.stringify([c,s,o,f,i,l]),d=dt(t.glTF).pipelines=dt(t.glTF).pipelines||{};if(r=d[u],r)return r;const g=[`ALPHAMODE_${o}`];for(const e of c)for(const t of e.attributes)g.push(`USE_${t.name}`),"COLOR_0"===t.name&&579===t.format&&g.push("COLOR_0_VEC3");l&&g.push("MATERIAL_UNLIT");const p=g.map((e=>`#define ${e}\n`)).join(""),m="#version 300 es\n",b=m+p+"#version 300 es\nprecision highp float;\nlayout(std140)uniform Model{mat4 A,B,C;vec4 D;};layout(std140)uniform Morph{vec4 E[2];};uniform sampler2D jointTexture;layout(location=0)in vec3 F;out vec3 vPosition;out vec2 vTexCoord0,vTexCoord1;\n#ifdef USE_NORMAL\nlayout(location=1)in vec3 G;\n#ifdef USE_TANGENT\nlayout(location=2)in vec4 H;out mat3 vTBN;\n#else\nout vec3 vNormal;\n#endif\n#endif \n#ifdef USE_TEXCOORD_0\nlayout(location=3)in vec2 I;\n#endif\n#ifdef USE_TEXCOORD_1\nlayout(location=4)in vec2 J;\n#endif\n#ifdef USE_COLOR_0\nout vec4 vColor0;\n#if defined(COLOR_0_VEC3)\nlayout(location=5)in vec3 K;\n#else\nlayout(location=5)in vec4 K;\n#endif\n#endif \n#if defined(USE_WEIGHTS_0) && defined(USE_JOINTS_0)\n#define USE_SKIN \nlayout(location=6)in vec4 L;layout(location=7)in vec4 M;mat4 N(int O){return mat4(texelFetch(jointTexture,ivec2(0,O),0),texelFetch(jointTexture,ivec2(1,O),0),texelFetch(jointTexture,ivec2(2,O),0),texelFetch(jointTexture,ivec2(3,O),0));}mat4 P(){mat4 Q=M.x*N(int(L.x))+M.y*N(int(L.y))+M.z*N(int(L.z))+M.w*N(int(L.w));return Q;}\n#endif \n#if defined(USE_POSITION_0)\n#define USE_MORPH \n#ifdef USE_POSITION_0\nlayout(location=8)in vec3 R;\n#endif\n#ifdef USE_POSITION_1\nlayout(location=9)in vec3 S;\n#endif\n#if !defined(USE_TANGENT_0)\n#ifdef USE_POSITION_2\nlayout(location=10)in vec3 T;\n#endif\n#ifdef USE_POSITION_3\nlayout(location=11)in vec3 U;\n#endif\n#if !defined(USE_NORMAL_0)\n#ifdef USE_POSITION_4\nlayout(location=12)in vec3 V;\n#endif\n#ifdef USE_POSITION_5\nlayout(location=13)in vec3 W;\n#endif\n#ifdef USE_POSITION_6\nlayout(location=14)in vec3 X;\n#endif\n#ifdef USE_POSITION_7\nlayout(location=15)in vec3 Y;\n#endif\n#endif \n#endif \n#ifdef USE_NORMAL_0\nlayout(location=12)in vec3 Z;\n#endif\n#ifdef USE_NORMAL_1\nlayout(location=13)in vec3 a;\n#endif\n#if !defined(USE_TANGENT_0)\n#ifdef USE_NORMAL_2\nlayout(location=14)in vec3 b;\n#endif\n#ifdef USE_NORMAL_3\nlayout(location=15)in vec3 c;\n#endif\n#endif \n#ifdef USE_TANGENT_0\nlayout(location=14)in vec3 d;\n#endif\n#ifdef USE_TANGENT_1\nlayout(location=15)in vec3 e;\n#endif\nvec3 f(){vec3 g=vec3(0.);\n#ifdef USE_POSITION_0\ng+=E[0].x*R;\n#endif\n#ifdef USE_POSITION_1\ng+=E[0].y*S;\n#endif\n#ifdef USE_POSITION_2\ng+=E[0].z*T;\n#endif\n#ifdef USE_POSITION_3\ng+=E[0].w*U;\n#endif\n#ifdef USE_POSITION_4\ng+=E[1].x*V;\n#endif\n#ifdef USE_POSITION_5\ng+=E[1].y*W;\n#endif\n#ifdef USE_POSITION_6\ng+=E[1].z*X;\n#endif\n#ifdef USE_POSITION_7\ng+=E[1].w*Y;\n#endif\nreturn g;}vec3 h(){vec3 g=vec3(0.);\n#ifdef USE_NORMAL_0\ng+=E[0].x*Z;\n#endif\n#ifdef USE_NORMAL_1\ng+=E[0].y*a;\n#endif\n#ifdef USE_NORMAL_2\ng+=E[0].z*b;\n#endif\n#ifdef USE_NORMAL_3\ng+=E[0].w*c;\n#endif\nreturn g;}vec3 i(){vec3 g=vec3(0.);\n#ifdef USE_TANGENT_0\ng+=E[0].x*d;\n#endif\n#ifdef USE_TANGENT_1\ng+=E[0].y*e;\n#endif\nreturn g;}\n#endif \nvec4 j(){vec4 k=vec4(F,1.);\n#ifdef USE_MORPH\nk+=vec4(f(),0.);\n#endif\n#ifdef USE_SKIN\nk=P()*k;\n#endif\nreturn k;}\n#ifdef USE_NORMAL\nvec3 l(){vec3 m=G;\n#ifdef USE_MORPH\nm+=h();\n#endif\n#ifdef USE_SKIN\nm=mat3(P())*m;\n#endif\nreturn normalize(m);}\n#ifdef USE_TANGENT\nvec3 n(){vec3 tan=H.xyz;\n#ifdef USE_MORPH\ntan+=i();\n#endif\n#ifdef USE_SKIN\ntan=mat3(P())*tan;\n#endif\nreturn normalize(tan);}\n#endif \n#endif \nvoid main(){vec4 k=A*j();vPosition=k.xyz/k.w;\n#ifdef USE_NORMAL\nmat3 o=mat3(B);\n#ifdef USE_TANGENT\nvec3 tan=n();vec3 p=normalize(o*l());vec3 q=normalize(o*tan);vec3 r=cross(p,q)*H.w;vTBN=mat3(q,r,p);\n#else\nvNormal=normalize(o*G);\n#endif \n#endif \n#ifdef USE_COLOR_0\n#if defined(COLOR_0_VEC3)\nvColor0=vec4(K,1.);\n#else\nvColor0=K;\n#endif\n#endif \nvTexCoord0=vec2(0.);vTexCoord1=vec2(0.);\n#ifdef USE_TEXCOORD_0\nvTexCoord0=I;\n#endif\n#ifdef USE_TEXCOORD_1\nvTexCoord1=J;\n#endif\ngl_Position=C*k;gl_PointSize=1.;}".replace(m,""),h=m+p+"#version 300 es\nprecision highp float;\nlayout(std140)uniform Model{mat4 A,B,C;vec4 D;};layout(std140)uniform Morph{vec4 E[2];};layout(std140)uniform Material{vec4 F;float G,H;float I,J;float K,L;float M,N;vec4 O;float P;};uniform sampler2D baseColorTexture;uniform sampler2D metallicRoughnessTexture;uniform sampler2D normalTexture;uniform sampler2D occlusionTexture;uniform sampler2D emissiveTexture;in vec3 vPosition;in vec2 vTexCoord0,vTexCoord1;\n#ifdef USE_COLOR_0\nin vec4 vColor0;\n#endif\n#ifdef USE_NORMAL\n#ifdef USE_TANGENT\nin mat3 vTBN;\n#else\nin vec3 vNormal;\n#endif\n#endif\nout vec4 fragColor;const float Q=2.2;const float R=3.141592653589793;vec3 S(vec3 T){return pow(T,vec3(1./Q));}vec2 U(float V){return mix(vTexCoord0,vTexCoord1,step(1.,V));}vec4 W(sampler2D X,float V){return texture(X,U(V));}vec4 W(sampler2D X,float V,vec4 Y){return mix(Y,texture(X,U(V)),step(0.,V));}vec3 Z(vec3 a,vec3 b,float c){return a+(b-a)*pow(clamp(1.-c,0.,1.),5.);}float d(float e,float f){float g=(f*f)*(e-1.)+1.;return e/(R*g*g);}float h(float e,float i,float j){float k=1./(i+sqrt(e+(1.-e)*(i*i)));float l=1./(j+sqrt(e+(1.-e)*(j*j)));return k*l;}float m(float e,float i,float j,float f){return h(e,i,j)*d(e,f);}vec3 n(vec3 T){return T/R;}vec4 o(){vec4 T=vec4(1.);\n#ifdef USE_COLOR_0\nT=vColor0;\n#endif\nreturn T;}vec4 p(){vec4 q=vec4(1.);q*=F;q*=W(baseColorTexture,I,vec4(1.));return q*o();}vec2 r(){vec4 s=W(metallicRoughnessTexture,J,vec4(1.));return vec2(clamp(G*s.b,0.,1.),clamp(H*s.g,.04,1.));}float t(){return W(occlusionTexture,N,vec4(1.)).r;}vec3 u(){return O.xyz*W(emissiveTexture,O.w,vec4(1.)).xyz;}struct v{vec3 ng;vec3 nn;vec3 t;vec3 b;};v w(vec3 x){vec3 y,t,b,ng;\n#ifdef USE_TANGENT\nt=normalize(vTBN[0]);b=normalize(vTBN[1]);ng=normalize(vTBN[2]);\n#else\n#ifdef USE_NORMAL\nng=normalize(vNormal);\n#else\nng=normalize(cross(dFdx(x),dFdy(x)));\n#endif\nvec2 z=U(L);vec3 AA=dFdx(vec3(z,0.));vec3 AB=dFdy(vec3(z,0.));vec3 AC=(AB.t*dFdx(x)-AA.t*dFdy(x))/(AA.s*AB.t-AB.s*AA.t);t=normalize(AC-ng*dot(ng,AC));b=cross(ng,t);\n#endif\nif(gl_FrontFacing==false){t*=-1.;b*=-1.;ng*=-1.;}y=ng;if(L>=0.){y=W(normalTexture,L).rgb*2.-vec3(1.);y*=vec3(K,K,1.);y=mat3(t,b,ng)*normalize(y);}v AD;AD.ng=ng;AD.t=t;AD.b=b;AD.nn=y;return AD;}\n#define LIGHT_DIRECTIONAL  0\n#define LIGHT_POINT  1\n#define LIGHT_SPOT  2\nint AE(mat4 AF){return int(AF[0].x);}vec2 AG(mat4 AF){return AF[0].zw;}vec4 AH(mat4 AF){return AF[1];}float AI(mat4 AF){return AF[2].w;}vec3 AJ(mat4 AF){return AF[2].xyz;}vec3 AK(mat4 AF){return AF[3].xyz;}float AL(float AM,float AN){if(AM<=0.){return 1./pow(AN,2.);}return max(min(1.-pow(AN/AM,4.),1.),0.)/pow(AN,2.);}float AO(vec3 AP,vec3 AQ,vec2 AR){float AS=dot(normalize(AQ),normalize(-AP));float AT=1./max(.001,AR[0]-AR[1]);float AU=-AR[1]*AT;float AV=clamp(AS*AT+AU,0.,1.);return AV*AV;}vec3 AW(mat4 AF,vec3 AX){return AE(AF)!=LIGHT_DIRECTIONAL?AK(AF)-AX:-AJ(AF);}vec3 AY(mat4 AF,vec3 AP){vec4 T=AH(AF);vec3 AZ=T.rgb*T.a;if(AE(AF)!=LIGHT_DIRECTIONAL){AZ*=AL(AI(AF),length(AP));}if(AE(AF)==LIGHT_SPOT){AZ*=AO(AP,AJ(AF),AG(AF));}return AZ;}void main(){vec4 q=p();\n#ifdef ALPHAMODE_OPAQUE\nq.a=1.;\n#endif\n#ifdef MATERIAL_UNLIT\ngl_FragColor=(vec4(S(q.rgb),q.a));return;\n#endif\nvec3 x=normalize(D.xyz-vPosition);v Aa=w(vPosition);vec3 y=Aa.nn;vec3 Ab=-normalize(reflect(x,y));float j=clamp(abs(dot(y,x)),0.001,1.);vec2 Ac=r();float Ad=Ac[0];float Ae=Ac[1];float Af=Ae*Ae;float e=Af*Af;vec3 Ag=vec3(0.04);vec3 Ah=q.rgb*(vec3(1.)-Ag)*(1.-Ad);vec3 Ai=mix(Ag,q.rgb,Ad);float a=max(max(Ai.r,Ai.g),Ai.b);float b=clamp(a*25.,0.,1.);vec3 Aj=Ai.rgb;vec3 Ak=vec3(1.,1.,1.)*b;vec3 Al=vec3(0.);vec3 Am=vec3(0.);\n#define NUM_LIGHTS  4\nmat4 An[4];An[0]=mat4(0.,0.,0.,0.,1.,1.,1.,1.,.5,-.707,-.5,0.,0.,0.,0.,0.);An[1]=mat4(0.,0.,0.,0.,1.,1.,1.,.75,-.5,.707,.5,0.,0.,0.,0.,0.);An[2]=mat4(0.,0.,0.,0.,1.,1.,1.,.75,.5,.707,-.5,0.,0.,0.,0.,0.);An[3]=mat4(0.,0.,0.,0.,1.,1.,1.,.75,-.5,-.707,.5,0.,0.,0.,0.,0.);\n#ifdef NUM_LIGHTS\nfor(int Ao=0;Ao<NUM_LIGHTS;++Ao){vec3 AP=AW(An[Ao],vPosition);vec3 AZ=AY(An[Ao],AP);vec3 Ap=normalize(AP);vec3 Aq=normalize(Ap+x);float i=clamp(dot(y,Ap),0.001,1.);float f=clamp(dot(y,Aq),0.,1.);float c=clamp(dot(x,Aq),0.,1.);vec3 Ar=Z(Aj,Ak,c);vec3 As=(1.-Ar)*n(Ah);vec3 At=max(vec3(0.),Ar*m(e,i,j,f));Al+=AZ*i*As;Am+=AZ*i*At;}\n#endif\nvec4 Au=vec4(.1);vec3 Av=Au.rgb*n(Ah);Al+=Av;vec3 Aw=Al+Am;float Ax=t();Aw=mix(Aw,Aw*Ax,M);vec3 Ay=u();Aw+=Ay;\n#ifdef ALPHAMODE_MASK\nif(q.a<P){discard;}q.a=1.;\n#endif\nfragColor=vec4(S(Aw),q.a);}".replace(m,""),A=ke(e,{usage:1,code:b}),T=ke(e,{usage:2,code:h});return r=dt(n).pipeline=d[u]=function(e,t){const n=function(e,t,n){const r=e.gl.createProgram();return e.gl.attachShader(r,t),e.gl.attachShader(r,n),e.gl.linkProgram(r),r}(e,t.vertex.gls,t.fragment.gls),r=[],i={};let a=0,o=0;if(t.bindGroups){for(let s=0;s<t.bindGroups.length;++s){const l=t.bindGroups[s].entries;r.push([]);for(let t=0;t<l.length;++t){const c=l[t];let f=null,u=4294967295;0===c.type?(u=e.gl.getUniformBlockIndex(n,c.label),e.gl.uniformBlockBinding(n,u,a++)):2===c.type&&(f=e.gl.getUniformLocation(n,c.label),i[c.label]=o++),r[s][c.binding]={...c,loc:f,index:u,slot:0===c.type?a-1:2===c.type?o-1:0}}}for(let e=0;e<t.bindGroups.length;++e){const n=t.bindGroups[e].entries;for(let t=0;t<n.length;++t)1===n[t].type&&i[n[t].label]&&(r[e][n[t].binding].slot=i[n[t].label])}}const s=e=>{e.deleteProgram(n)},l={gl:e.gl,glp:n,buffers:t.buffers,cache:r,state:Oe(t),destroy(){s(this.gl)}};return Le.register(l,{finalizer:s,gl:e.gl}),l}(e,{vertex:A,fragment:T,buffers:c,bindGroups:[jt(0,t.glTF),Vt(0,t.glTF)],primitive:{indexFormat:f,topology:i,cullMode:s?0:1029},depthStencil:{depthCompare:515,depthWrite:!("BLEND"===o)},targets:"BLEND"===o?{blendColor:{srcFactor:770,dstFactor:771},blendAlpha:{srcFactor:1,dstFactor:771}}:null}),A.destroy(),T.destroy(),r}(e,t,i);!function(e,t){if(e.state.pipeline===t)return;e.state.pipeline&&e.state.pipeline.glp===t.glp||e.gl.useProgram(t.glp),we(e.gl,e.extDrawBuffersi,e.state.state,t.state,e.state.stencilRef),Object.assign(e.state.state,t.state);const n=[];for(const{attributes:t}of e.state.buffers)for(const{ptr:e}of t)n[e[0]]=1;e.state.buffers=Array(t.buffers.length);for(let r=0;r<t.buffers.length;++r){const{attributes:i,stride:a,stepMode:o=0}=t.buffers[r],s=[];e.state.buffers[r]={glb:null,attributes:s,stride:a,step:o,offset:0,instanceOffset:0};for(const{format:e,offset:t,shaderLocation:l}of i)n[l]=(n[l]||0)+2,s.push({buffer:r,ptr:[l,he(e),Ae(e),Te(e),a,t],step:o})}for(let t=0;t<n.length;++t)2===n[t]?e.gl.enableVertexAttribArray(t):1===n[t]&&e.gl.disableVertexAttribArray(t);e.state.pipeline=t}(e,c),We(e,0,function(e,t,n){const r=t.glTF.materials?.[n];if(r&&dt(r).bindGroup)return dt(r).bindGroup;if(!r&&dt(t.glTF).defaultMaterialBindGroup)return dt(t.glTF).defaultMaterialBindGroup;const i=new Float32Array(20);i[0]=i[1]=i[2]=i[3]=1,i[4]=1,i[5]=1,i[6]=i[7]=i[9]=i[11]=i[15]=-1,i[8]=1,i[10]=0,i[12]=i[13]=i[14]=0,i[16]=.5;const a=Pe(e,{usage:64,size:i.byteLength});r&&(dt(r).gpuBuffer=a);const o=[{binding:0,buffer:a},{binding:1,texture:Ht(e,t.glTF)},{binding:2,sampler:qt(e,t.glTF)},{binding:3,texture:Ht(e,t.glTF)},{binding:4,sampler:qt(e,t.glTF)},{binding:5,texture:Ht(e,t.glTF)},{binding:6,sampler:qt(e,t.glTF)},{binding:7,texture:Ht(e,t.glTF)},{binding:8,sampler:qt(e,t.glTF)},{binding:9,texture:Ht(e,t.glTF)},{binding:10,sampler:qt(e,t.glTF)}];if(r){if(r.pbrMetallicRoughness){const n=r.pbrMetallicRoughness;n.baseColorFactor&&l(n.baseColorFactor,i,0,0,4),(n.metallicFactor||0===n.metallicFactor)&&(i[4]=n.metallicFactor),(n.roughnessFactor||0===n.roughnessFactor)&&(i[5]=n.roughnessFactor),n.baseColorTexture&&(o[1].texture=kt(e,t,n.baseColorTexture.index,35907),o[2].sampler=Dt(e,t.glTF,n.baseColorTexture.index),i[6]=n.baseColorTexture.texCoord||0),n.metallicRoughnessTexture&&(o[3].texture=kt(e,t,n.metallicRoughnessTexture.index),o[4].sampler=Dt(e,t.glTF,n.metallicRoughnessTexture.index),i[7]=n.metallicRoughnessTexture.texCoord||0)}r.normalTexture&&(o[5].texture=kt(e,t,r.normalTexture.index),o[6].sampler=Dt(e,t.glTF,r.normalTexture.index),i[8]=r.normalTexture.scale??1,i[9]=r.normalTexture.texCoord||0),r.occlusionTexture&&(o[7].texture=kt(e,t,r.occlusionTexture.index),o[8].sampler=Dt(e,t.glTF,r.occlusionTexture.index),i[10]=r.occlusionTexture.strength||0,i[11]=r.occlusionTexture.texCoord||0),r.emissiveFactor&&l(r.emissiveFactor,i,0,12,3),r.emissiveTexture&&(o[9].texture=kt(e,t,r.emissiveTexture.index,35907),o[10].sampler=Dt(e,t.glTF,r.emissiveTexture.index),i[15]=r.emissiveTexture.texCoord||0),(r.alphaCutoff||0===r.alphaCutoff)&&(i[16]=r.alphaCutoff)}Ge(e,a,i);const s=ze(0,{layout:jt(0,t.glTF),entries:o});return r?dt(r).bindGroup=s:dt(t.glTF).defaultMaterialBindGroup=s,s}(e,t,i.material)),We(e,1,function(e,t,n,r){if(dt(n).modelBindGroup)return dt(n).modelBindGroup;const i=[{binding:0,buffer:zt(e,n)},{binding:1,buffer:Gt(e,t,n,r)},{binding:2,texture:Wt(e,t,n)},{binding:3,sampler:$t(e,t)}];return dt(n).modelBindGroup=ze(0,{layout:Vt(0,t),entries:i})}(e,t.glTF,n,r));const f=Bt(t,i);for(let n=0;n<f.length;++n){const r=f[n].attributes[0].name,a=Ct.exec(r),o=Rt(e,t,a?i.targets[a[2]][a[1]]:i.attributes[r],32);o&&je(e,n,o)}const u=t.glTF.accessors?.[i.indices];if(u){const n=Rt(e,t,i.indices,16);n&&(function(e,t){t.glb!==e.state.index&&e.gl.bindBuffer(34963,e.state.index=t.glb)}(e,n),s=u.count,o=dt(u).byteOffset||0,a=!0)}a?function(e,t,n=1,r=0,i=0){for(const t of e.state.buffers)t.step&&t.instanceOffset!==i&&(t.instanceOffset=i,Ie(e.gl,t,i*t.stride));e.gl.drawElementsInstanced(e.state.state.topology,t,e.state.state.indexFormat,r*(e.state.state.indexFormat===y?2:4),n)}(e,s,1,o):function(e,t,n=1,r=0,i=0){for(const t of e.state.buffers)t.step&&t.instanceOffset!==i&&(t.instanceOffset=i,Ie(e.gl,t,i*t.stride));e.gl.drawArraysInstanced(e.state.state.topology,r,t,n)}(e,s)}function Bt(e,t){const n={},r=[];if(dt(t).bufferLayouts)return dt(t).bufferLayouts;function i(t){if(!t.sparse){const i=bt(e,t).buffer,a=`${t.bufferView},${i.byteOffset},${i.byteLength}`;if(a in n)return r[n[a]];n[a]=r.length}const i={attributes:[],stride:e.glTF.bufferViews?.[t.bufferView]?.byteStride||0};return r.push(i),i}for(let n=0;n<Et.length;++n){const r=e.glTF.accessors?.[t.attributes[Et[n]]];if(r){const e=mt(r);if(!e)continue;i(r).attributes.push({name:Et[n],format:e,shaderLocation:n,offset:dt(r).byteOffset||0})}}if(t.targets){const n=new Array(3);let r=8;for(let a=0;a<Math.min(t.targets.length,r);++a){let o=0;for(let r=0;r<_t.length;++r)(n[r]=e.glTF.accessors?.[t.targets[a][_t[r]]])&&++o;r=8/o|0;for(let e=0;e<_t.length;++e){const t=n[e];t&&i(t).attributes.push({name:`${_t[e]}_${a}`,format:579,shaderLocation:Mt[e]+a,offset:dt(t).byteOffset||0})}}}return dt(t).bufferLayouts=r,r}function Rt(e,t,n,r){const i=t.glTF.accessors?.[n];if(!i)return null;const a=16&r&&i.componentType===ct;if(i.sparse||a){let n=dt(i).gpuBuffer;if(!n){const o=bt(t,i);let s=o.buffer;if(a){const e=new Uint16Array(s.byteLength);for(let t=0;t<s.byteLength;++t)e[t]=s[o.byteOffset+t];s=dt(i).buffer=new Uint8Array(e.buffer,0,e.byteLength),dt(i).byteOffset=0}n=dt(i).gpuBuffer=Pe(e,{usage:r,size:s.byteLength}),Ge(e,n,s)}return n}const o=t.glTF.bufferViews?.[i.bufferView];if(!o)return null;const s=dt(o).gpuBuffers=dt(o).gpuBuffers||{},l=bt(t,i).buffer,c=`${l.byteOffset},${l.byteLength}`;return s[c]||(s[c]=Pe(e,{usage:r,size:l.byteLength}),Ge(e,s[c],l)),s[c]}function kt(e,t,n,r=32856){const i=t.glTF.textures?.[n],a=t.images?.[i?.source??-1];if(!i||!a)return Ht(e,t.glTF);let o=dt(i).texture;return o||(o=dt(i).texture=Be(e,{format:r,size:[a.width||1,a.height||1,1],usage:4}),function(e,{src:t,origin:[n,r]=[0,0]},{texture:i,mipLevel:a=0,origin:[o,s,l]=[0,0,0]},[c,f]=[t.width-n,t.height-r]){const u=ye(i.format),d=i.type===S?34069+l:i.type;e.gl.activeTexture(w),e.gl.bindTexture(i.type,i.glt),e.gl.pixelStorei(3316,n),e.gl.pixelStorei(C,r),e.gl.pixelStorei(32877,0),e.gl.pixelStorei(32878,0),be(i.type)?e.gl.texSubImage3D(d,a,o,s,l,c,f,1,i.format,u,t):e.gl.texSubImage2D(d,a,o,s,c,f,ve(i.format),u,t)}(e,{src:a},{texture:o})),o}function Dt(e,t,n){const r=t.textures?.[n],i=t.samplers?.[r?.sampler??-1];if(!i)return qt(e,t);let a=dt(i).sampler;if(!a){const t={...Nt};switch(t.addressModeU=i.wrapS||t.addressModeU,t.addressModeV=i.wrapT||t.addressModeV,t.magFilter=i.magFilter||t.magFilter,i.minFilter){case 9984:t.minFilter=pe,t.mipmapFilter=pe;break;case 9986:t.minFilter=pe,t.mipmapFilter=me;break;case 9985:t.minFilter=me,t.mipmapFilter=pe;break;case 9987:t.minFilter=me,t.mipmapFilter=me;break;default:t.minFilter=i.minFilter}a=dt(i).sampler=Re(e,t)}return a}function zt(e,t,n=null){let r=dt(t).modelBuffer;if(r||(r=dt(t).modelBuffer=Pe(e,{usage:8256,size:208})),n){const i=new Float32Array(n.buffer,0,16);l(dt(t).model||Ut,i,0,0,16);const a=new Float32Array(n.buffer,64,16),o=function(e,t=[1,0,0,0,1,0,0,0,1]){return function(e,t=[1,0,0,0,1,0,0,0,1]){return function(e,t=[1,0,0,0,1,0,0,0,1]){const n=function(e){return e[0]*+(e[4]*e[8]-e[7]*e[5])+e[3]*-(e[1]*e[8]-e[7]*e[2])+e[6]*+(e[1]*e[5]-e[4]*e[2])}(e);return n?(He[0]=+(e[4]*e[8]-e[7]*e[5]),He[1]=-(e[1]*e[8]-e[7]*e[2]),He[2]=+(e[1]*e[5]-e[4]*e[2]),He[3]=-(e[3]*e[8]-e[6]*e[5]),He[4]=+(e[0]*e[8]-e[6]*e[2]),He[5]=-(e[0]*e[5]-e[3]*e[2]),He[6]=+(e[3]*e[7]-e[6]*e[4]),He[7]=-(e[0]*e[7]-e[6]*e[1]),He[8]=+(e[0]*e[4]-e[3]*e[1]),function(e,t,n=[1,0,0,0,1,0,0,0,1]){return c(e,t,n)}(He,1/n,t)):null}(e,t)?function(e,t=[1,0,0,0,1,0,0,0,1]){return function(e,t,n){let r=0;for(let e=0;e<3;++e)for(let i=e;i<3;++i)r=t[3*i+e],n[3*i+e]=t[3*e+i],n[3*e+i]=r;return n}(0,e,t)}(t,t):null}(function(e,t=[1,0,0,0,1,0,0,0,1]){for(let n=0;n<3;++n)for(let r=0;r<3;++r)t[3*n+r]=e[4*n+r];return t}(e,t),t)}(i);o?function(e,t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){for(let n=0;n<3;++n){for(let r=0;r<3;++r)t[4*n+r]=e[3*n+r];t[4*n+3]=0}t[12]=t[13]=t[14]=0,t[15]=1}(o,a):l(i,a,0,0,16),Ge(e,r,n)}return r}function Gt(e,t,n,r,i=!1){const a=dt(n).weights||n.weights||r.weights;if(!a)return function(e,t){let n=dt(t).morphBuffer;return n||(n=dt(t).morphBuffer=Pe(e,{usage:64,size:32})),n}(e,t);let o=dt(n).morphBuffer;if(o||(o=dt(n).morphBuffer=Pe(e,{usage:8256,size:32})),i){const t=new Float32Array(8);l(a,t,0,0,8),Ge(e,o,t)}return o}function Vt(e,t){let n=dt(t).modelLayout;return n||(n=dt(t).modelLayout=De(0,{entries:[{binding:0,label:"Model",type:0},{binding:1,label:"Morph",type:0},{binding:2,label:"jointTexture",type:2},{binding:3,label:"jointTexture",type:1}]})),n}function jt(e,t){let n=dt(t).materialLayout;return n||(n=dt(t).materialLayout=De(0,{entries:[{binding:0,label:"Material",type:0},{binding:1,label:"baseColorTexture",type:2},{binding:2,label:"baseColorTexture",type:1},{binding:3,label:"metallicRoughnessTexture",type:2},{binding:4,label:"metallicRoughnessTexture",type:1},{binding:5,label:"normalTexture",type:2},{binding:6,label:"normalTexture",type:1},{binding:7,label:"occlusionTexture",type:2},{binding:8,label:"occlusionTexture",type:1},{binding:9,label:"emissiveTexture",type:2},{binding:10,label:"emissiveTexture",type:1}]})),n}function Wt(e,t,n,r=!1){const i=t.skins?.[n.skin];if(!i)return Ht(e,t);const a=i.joints.length;let o=dt(n).jointTexture;return o||(o=dt(n).jointTexture=Be(e,{size:[4,a,1],format:34836,usage:4})),r&&Ve(e,{texture:o},dt(n).jointMatrix=dt(n).jointMatrix||new Float32Array(16*a),{bytesPerRow:64,rowsPerImage:a},[4,a,1]),o}function Ht(e,t){let n=dt(t).blankTexture;return n||(n=dt(t).blankTexture=Be(e,{usage:4}),Ve(e,{texture:n},new Uint8Array([255,255,255,255]),{bytesPerRow:4}),n)}function qt(e,t){let n=dt(t).defaultSampler;return n||(n=dt(t).defaultSampler=Re(e,Nt)),n}function $t(e,t){let n=dt(t).jointSampler;return n||(n=dt(t).jointSampler=Re(e,{})),n}const Kt=p(-1,-2,-2),Xt=new URLSearchParams(window.location.search),Jt=document.querySelector("canvas"),Zt=Jt.parentElement;let Qt=null,Yt=0,en=0;const tn=function(e,t={},n=0){const r=e.getContext("webgl2",t);if(r){let t=0;for(const e in Fe)n&+e&&r.getExtension(Fe[+e])&&(t|=+e);const i=16&t?r.getExtension(Fe[16]):null,a=function(e){const t=Oe();e.blendColor(1,1,1,1),we(e,null,t,t,0,!0);const n=e.getParameter(34921);for(let t=0;t<n;++t)e.disableVertexAttribArray(t);return e.pixelStorei(3333,1),e.pixelStorei(3317,1),{copyFrameBuffer:e.createFramebuffer(),buffers:[],state:t,pipeline:null,index:null,stencilRef:0,scissor:!1}}(r),o=e=>{e.deleteFramebuffer(a.copyFrameBuffer)},s={canvas:e,gl:r,features:t,extDrawBuffersi:i,pass:null,state:a,destroy(){o(this.gl)}};return Le.register(s,{finalizer:o,gl:r}),s}return null}(Jt,{powerPreference:"low-power"}),nn="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/63f026b2aa957d3e8207f6dd798608993e33fb0d/2.0";function rn(e=0){if(window.requestAnimationFrame(rn),!Qt)return;Yt||(Yt=e);const t=e-Yt,n=Qt.glTF,r=Xt.get("camera"),i=Xt.get("scene"),a=((null!==i&&parseInt(i))??n.scene)||0;n.animations?.length&&(function(e,t,n=0,r=!1){const i=function(e,t){let n=dt(t).duration||0;for(const r of t.channels){const i=e.nodes?.[r.target.node],a=e.accessors?.[t.samplers[r.sampler]?.input];i&&a&&(n=Math.max(n,a.max?.[0]||0))}return dt(t).duration=n}(e.glTF,t),a=r?n-Math.floor(n/i)*i:Math.min(n,i);for(const n of t.channels){const r=e.glTF.nodes?.[n.target.node],i=t.samplers[n.sampler];if(!r||!i)continue;const o=gt(e,i),s=pt(e,i);if(!o?.length||!s)continue;const l=o.length,c=o[0],f=o[l-1],u=dt(n).lastKeyframe||0,[d,g]=St(o,c,f,a,u);dt(n).lastKeyframe=d;const p=n.target.path;let m=3,b=!1;switch(p){case"rotation":m=4,b=!0;break;case"weights":m=r.weights?.length||e.glTF.meshes?.[r.mesh]?.weights?.length||0}wt(dt(r)[p]=dt(r)[p]||new Array(m),o,s,d,g,a,i.interpolation||"LINEAR",b)}return n<i}(Qt,n.animations[en],t/1e3)||(Yt=e,en=(en+1)%n.animations.length)),function(e,t,n,r={}){const i=(r.scene??n.glTF.scene)||0,a=n.glTF.nodes,o=n.glTF.scenes?.[i]?.nodes;if(!a||!o)return;const s=function(e,t={}){let n=[];const r=e.glTF.scenes?.[(t.scene??e.glTF.scene)||0]?.nodes;if(r)for(let t=0;t<r.length;++t)Ft(e.glTF,r[t],At,n);n=n.sort().filter(((e,t,n)=>!t||e!==n[t-1]));for(const t of n){const n=e.glTF.nodes[t];"camera"in n&&xt(e.glTF,n),"skin"in n&&Ot(e,n)}return n}(n,{scene:i});let c=Ut,f=Ut,u=It;if(r.camera){const t=n.glTF.cameras?.[r.camera.index||0];t&&(c=t.extras?.view||Ut,d=Lt,g=t,m=e.width/e.height,g?.orthographic?function(e,t,n,r,i,a,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]){const s=1/(t-e),l=1/(r-n),c=1/(i-a);$e(o),o[0]=2*s,o[5]=2*l,o[10]=2*c,o[12]=-(t+e)*s,o[13]=-(r+n)*l,o[14]=(i+a)*c}(-g.orthographic.xmag,g.orthographic.xmag,-g.orthographic.xmag/(m||1),g.orthographic.xmag/(m||1),g.orthographic.znear,g.orthographic.zfar,d):g?.perspective?et(m||g.perspective.aspectRatio||1,g.perspective.yfov,g.perspective.znear,g.perspective.zfar||1/0,d):$e(d),f=d,u=t.extras?.translation||It),r.camera.model&&(u=p(r.camera.model[12],r.camera.model[13],r.camera.model[14]),Xe(r.camera.model,c)),f=r.camera.proj||f}var d,g,m;const b=Ke(f,c,Lt),h=new Float32Array(52);l(b,h,0,32,16),l(u,h,0,48,3),function(e,t={}){e.gl.bindFramebuffer(36160,null),e.gl.viewport(0,0,e.gl.drawingBufferWidth,e.gl.drawingBufferHeight),e.gl.depthRange(0,1),e.state.scissor&&(e.state.scissor=!1,Ne(e.gl,3089,!1));let n=0;isNaN(t.clearDepth)||(n|=256,e.gl.clearDepth(t.clearDepth),Me(e.gl,e.state.state.depthWrite,!0),e.state.state.depthWrite=!0),isNaN(t.clearStencil)||(n|=1024,e.gl.clearStencil(t.clearStencil),Ce(e.gl,e.state.state.stencilWriteMask,255),e.state.state.stencilWriteMask=255),t.clearColor&&(n|=16384,e.gl.clearColor(...t.clearColor),_e(e.gl,e.state.state.blendWriteMask,15),e.state.state.blendWriteMask=15),n&&e.gl.clear(n),e.pass=null}(t,{clearDepth:1});const A=[];for(let e=0;e<s.length;++e){const r=a[s[e]],i=n.glTF.meshes?.[r.mesh];if(i){zt(t,r,h),Gt(t,n.glTF,r,i,!0),Wt(t,n.glTF,r,!0);for(let e=0;e<i.primitives.length;++e){const a=i.primitives[e];"BLEND"===n.glTF.materials?.[a.material]?.alphaMode?A.push({node:r,mesh:i,primitive:a}):Pt(t,n,r,i,a)}}}for(const e of A)Pt(t,n,e.node,e.mesh,e.primitive);!function(e){if(e.pass){for(let t=0;t<e.pass.color.length;++t)e.pass.glrfb[t]&&Ue(e.gl,e.pass.glfb,e.pass.glrfb[t],e.pass.color[t],16384,36064+t);const t=e.pass.glrfb[e.pass.glrfb.length-1];e.pass.depth&&t&&Ue(e.gl,e.pass.glfb,t,e.pass.depth,1280)}e.pass=null}(t)}(Jt,tn,Qt,{scene:a,camera:n.cameras?{index:parseInt(r)||0}:rt(n,a,Kt,Jt.width/Jt.height)})}function an(){const e=window.devicePixelRatio||1,t=Zt.clientWidth,n=Zt.clientHeight;Jt.width=t*e,Jt.height=n*e,Jt.style.width=`${t}px`,Jt.style.height=`${n}px`}window.addEventListener("resize",an,!1),an(),async function(){let t=Xt.get("url");if(!t){const e=await(await fetch(`${nn}/model-index.json`)).json(),n=Xt.get("model")||"BrainStem",r=Xt.get("variant")||"glTF",i=e.find((e=>e.name===n));t=`${nn}/${n}/${r}/${i.variants[r]}`}Qt=await async function(t,s=!0,l=e){const c=function(e){if(r(e))return"";const t=e.split(/[?#]/)[0].split("/");return t.pop(),t.length?t.join("/")+"/":""}(t);let f;const u=await l(t,"bin");var d;return d=u,f=new DataView(d.buffer||d,d.byteOffset||0,4).getUint32(0,!0)===a?function(e){let t,r;const i=e.buffer||e,o=e.byteOffset||0,s=new DataView(i,o,12);if(s.getUint32(0,!0)!==a)throw new Error("Invalid GLB format");const l=s.getUint32(4,!0);if(2!==l)throw new Error(`Unsupported GLB version: ${l}`);const c=new DataView(i,o+12);let f=0;for(;f<c.byteLength;){const e=c.getUint32(f,!0),a=c.getUint32(f+4,!0);if(f+=8,1313821514===a){const r=new Uint8Array(i,o+12+f,e);t=JSON.parse(n(r))}else 5130562===a&&(r=new Uint8Array(i,o+12+f,e));f+=e}if(!t)throw new Error("Invalid GLB format: missing JSON content");if(!t.asset||"2.0"!==t.asset.minVersion&&"2.0"!==t.asset.version)throw new Error("Unsupported glTF version: 2.0 required");return{glTF:t,binaryChunk:r}}(u):{glTF:JSON.parse(n(u))},f.baseUrl=c,s&&(f=await async function(t,n=e){return t=await async function(e,t){const n=e.buffers||[];if(e.glTF.buffers)for(let r=0;r<e.glTF.buffers.length;++r){if(n[r])continue;const a=e.glTF.buffers[r];if(a.uri)n[r]=await t(i(a.uri,e.baseUrl||""),"bin");else{if(0!==r||!e.binaryChunk)throw new Error(`Invalid glTF: missing uri for buffer ${r}`);n[r]=e.binaryChunk}}return{...e,buffers:n}}(t,n),await async function(e,t){const{glTF:n,buffers:r=[],images:a=[]}=e;if(n.images)for(let s=0;s<n.images.length;++s){if(a[s])continue;const l=n.images[s];let c=!1,f=l.uri;if(l.bufferView||0===l.bufferView){const e=n.bufferViews?.[l.bufferView];if(!e)throw new Error(`Invalid glTF: invalid bufferView for image ${s}`);const t=new Blob([o(r,e)],{type:l.mimeType});f=URL.createObjectURL(t),c=!0}if(!f)throw new Error(`Invalid glTF: missing uri or bufferView for image ${s}`);try{a[s]=await t(i(f,e.baseUrl||""),"img")}finally{c&&URL.revokeObjectURL(f)}}return{...e,images:a}}(t,n)}(f,l)),f}(t,!0),rn()}()})();